<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>KPIs Counter</title>

  <style>
    :root{
      --bg1:#145c8c;
      --bg2:#0e466b;

      /* Calendar (blue / celeste + transparency) */
      --calPanel: rgba(20, 92, 145, .24);
      --calPanel2: rgba(10, 62, 104, .22);
      --calLine: rgba(142, 211, 245, .28);
      --calLine2: rgba(187, 232, 255, .54);
      --calInk: rgba(236,248,255,.97);
      --calMuted: rgba(193,224,241,.84);
      --calChip: rgba(91, 169, 216, .18);
      --calChipLine: rgba(173, 224, 250, .30);
      --calShadow: 0 18px 55px rgba(0,0,0,.22);
    }

    html, body { touch-action: manipulation; min-height:100%; background: linear-gradient(150deg, var(--bg1), var(--bg2)); }

    body{
      margin:0; min-height:100dvh; display:flex; justify-content:center; align-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(130% 120% at 15% 0%, rgba(150,210,242,.24), transparent 62%), linear-gradient(150deg, var(--bg1), var(--bg2));
      color:#fff;
      overflow-x:hidden; /* avoid sideways scroll */
      overscroll-behavior-y: none;
    }

    .wrap{ width:min(620px, 99vw); padding:22px 4px 26px; }

    .card{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 20px;
      padding: 14px;
      backdrop-filter: blur(12px) saturate(130%);
      -webkit-backdrop-filter: blur(12px) saturate(130%);
      box-shadow: 0 10px 24px rgba(4,28,46,.20);
      display:flex;
      flex-direction:column;
      height:min(920px, 94vh);
      overflow:hidden;
    }

    .appHeader{
      position:sticky;
      top:0;
      z-index:5;
      background: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      padding: 6px 0 4px;
      flex:0 0 auto;
    }

    .appMain{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
      padding-right:2px;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:6px;
    }

    .title{ font-weight:700; letter-spacing:.015em; font-size:19px; line-height:1.1; }
    .subtitle{ opacity:.75; font-size:13px; margin-top:2px; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:14px; font-weight:700;
      user-select:none; touch-action: manipulation;
    }
    .btn:active{ transform: scale(.98); }

    .btn.primary{
      background: rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.55);
    }

    .helpBtn{
      width:38px;
      min-width:38px;
      padding:0;
      border-radius:999px;
      font-weight:900;
      font-size:16px;
    }

    .langBtn{
      min-width:58px;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:.04em;
    }

    .finishResult{
      margin-top:8px;
      text-align:center;
      font-size:13px;
      font-weight:700;
      color:rgba(245,252,255,.96);
      opacity:.95;
    }
    .finishResult .badgeText{ opacity:.85; font-weight:600; }

    .ratingNote{
      margin-bottom:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      font-weight:700;
      color:rgba(243,251,255,.97);
    }

    /* ---------- Tabs ---------- */
    .tabs{
      display:flex;
      gap:0;
      margin: 4px 0 0;
      padding:3px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      border-radius: 14px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:9px 8px;
      border-radius: 10px;
      border:0;
      background: transparent;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      color: rgba(227,246,255,.86);
    }
    .tab:active{ transform: scale(.99); }
    .tab.active{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      box-shadow:none;
    }

    .center{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
      padding:18px 6px 8px;
      text-align:center;
    }

    .centerIntro{
      min-height: 100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .sessionInfo{
      width:100%;
      box-sizing: border-box;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      margin: 8px 0 4px;
      padding: 10px 0;
      border-radius: 0;
      background: transparent;
      border: 0;
      border-top: 1px solid rgba(255,255,255,.12);
      border-bottom: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }

    .sessionInfo .left{ flex: 1 1 auto; min-width:0; }

    .sessionInfo .left .line1{
      font-weight:900; letter-spacing:.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sessionInfo .left .line2{
      opacity:.75; font-size:12px; margin-top:3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .timerBox{ flex: 0 0 120px; text-align:center; }
    .timerBox .t1{ font-size:12px; opacity:.9; }
    .timerBox .t2{ font-size:18px; font-weight:900; letter-spacing:.02em; margin-top:3px; }

    .metrics{ margin-top:10px; }
    .row{ text-align:center; margin:16px 0; }
    .label{ font-weight:800; letter-spacing:.08em; margin-bottom:8px; font-size:20px; }

    .pill{
      margin:0 auto;
      width:310px; height:56px;
      background:#fff; border-radius:999px;
      display:flex; overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      color:#111;
      touch-action: manipulation;
    }

    .pill button, .pill .val{
      flex:1; display:flex; align-items:center; justify-content:center;
      border:0; background:transparent; font-size:26px; cursor:pointer;
      touch-action: manipulation;
    }

    .pill .val{ flex:1.2; font-weight:800; font-size:24px; user-select:none; }
    .sep{ width:2px; background:#111; opacity:.8; }
    .pill button:active{ transform: scale(.97); }

    .indicators{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
      margin-top:12px;
    }
    .ind{
      background: transparent;
      border: 1px solid rgba(184,230,255,.16);
      border-radius: 10px;
      padding: 8px 8px;
    }
    .ind .k{ font-size:12px; opacity:.75; margin-bottom:6px; }
    .ind .v{ font-size:18px; font-weight:900; letter-spacing:.02em; }

    .footer{
      margin-top:auto;
      padding-top:8px;
      text-align:center;
      font-size:8px;
      opacity:.70;
      letter-spacing:.03em;
      border-top:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }

    /* ---------- Calendar (blue translucent style) ---------- */
    .calSurface{
      background: rgba(255,255,255,.09);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 6px 6px 6px;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      overflow:hidden;
    }

    .calHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 2px 0 10px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,.14);
    }

    .calTitle{
      font-weight:700;
      letter-spacing:.02em;
      font-size:14px;
      text-align:center;
      flex:1;
      color: var(--calInk);
      opacity:.95;
    }

    .iconBtn{
      width:34px; height:34px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:1000;
      color: var(--calInk);
      box-shadow:none;
      touch-action: manipulation;
    }
    .iconBtn:active{ transform: scale(.98); }

    /* IMPORTANT: prevent horizontal scroll + force fit */
    .calGrid{
      width:100%;
      box-sizing:border-box;
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:1px;
      overflow:hidden;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 10px;
      padding: 1px;
    }

    .dow{
      text-align:center;
      font-size:10px;
      letter-spacing:.12em;
      font-weight:900;
      padding:7px 0;
      color: var(--calMuted);
      user-select:none;
      min-width:0;
      border: 0;
      border-radius: 0;
      background: rgba(255,255,255,.05);
    }

    /* Square day WITHOUT aspect-ratio (avoids Safari grid overflow bugs) */
    .dayCell{
      position:relative;
      border-radius: 0;
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.07);
      cursor:pointer;
      user-select:none;
      min-width:0;              /* key for grid overflow */
      overflow:hidden;           /* clip anything inside */
      box-shadow:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      touch-action: manipulation;
    }
    .dayCell:active{ transform: scale(.985); }
    .dayCell:hover{ background: rgba(255,255,255,.10); }

    .dayCell.muted{
      opacity:1;
      background: rgba(255,255,255,.03);
      border-color: rgba(255,255,255,.10);
      box-shadow: none !important;
    }
    .dayCell.muted .dayNum,
    .dayCell.muted .miniClean{ opacity:.45; }

    .dayCell.today{
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
    }

    .dayCell.hasData{
      box-shadow: none;
    }

    .dayCell.selected{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.28);
      box-shadow: none;
    }
    .dayCell.muted.selected{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.12);
      box-shadow: none;
    }


    /* Square sizing helper */
    .dayCell::before{
      content:"";
      display:block;
      padding-top:134%;
    }
    .dayContent{
      position:absolute;
      inset:3px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-width:0;
    }

    .dayTop{
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:2px;
      min-width:0;
      min-height: 9px;
    }

    .dayNum{
      font-weight:900;
      font-size:10px;
      letter-spacing:.01em;
      color: var(--calInk);
      min-width:0;
    }

    .dayDot{
      margin-left:auto;
      width:8px;
      height:8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.60);
      align-self:flex-start;
      margin-top:1px;
      flex:0 0 auto;
    }
    .dayDot.good{ background:#2ce06a; }
    .dayDot.regular{ background:#ffd24a; }
    .dayDot.bad{ background:#ff4b4b; }
    .dayCell.muted .dayDot{ opacity:.45; }

    .badge{
      display:none;
      font-size:8px;
      font-weight:900;
      letter-spacing:.04em;
      padding: 1px 3px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      color: var(--calInk);
      white-space:nowrap;
      max-width: 38px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge.today{
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.28);
    }

    .miniClean{
      margin-top: 1px;
      min-width:0;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:1px;
      font-size:10px;
      line-height:1.15;
      color: var(--calInk);
      font-weight:500;
      letter-spacing:.01em;
    }
    .miniClean .kpiInline{ min-width:0; opacity:.95; }

    /* Stats under calendar */
    .statsPanel{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .statCard{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 10px;
      padding: 10px 10px;
      color: var(--calInk);
      box-shadow: none;
      backdrop-filter: none;
      overflow:hidden;
    }
    .statHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .statHead .h{
      font-weight:700;
      letter-spacing:.01em;
      font-size:13px;
      color: var(--calInk);
    }
    .statHead .p{
      font-size:13px;
      color: rgba(255,255,255,.75);
      white-space:nowrap;
    }
    .statGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:8px;
    }
    .statItem{
      border-radius: 8px;
      padding: 7px 6px;
      text-align:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: none;
      min-width:0;
    }
    .statItem .k{
      font-size:10px; letter-spacing:.10em; font-weight:1000;
      color: rgba(255,255,255,.78);
      margin-bottom: 4px;
      white-space:nowrap;
    }
    .statItem .v{
      font-size:14px; font-weight:1000; letter-spacing:.02em;
      color: var(--calInk);
      white-space:nowrap;
    }
    .moneyLine{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color: rgba(255,255,255,.75);
    }
    .moneyLine b{ font-weight:1000; color: var(--calInk); }

    /* ---------- Summary ---------- */
    .sumWrap{ display:grid; gap:10px; }
    .sumCard{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 10px;
      padding: 10px;
    }
    .sumTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom: 10px;
    }
    .sumTitle{ font-weight:700; letter-spacing:.02em; font-size:14px; opacity:.95; }
    .sumSub{ font-size:12px; opacity:.85; margin-top: 4px; }
    .sumMoney{ text-align:right; font-weight:900; letter-spacing:.02em; font-size:14px; }
    .sumMoney span{
      display:block;
      font-size:11px;
      opacity:.85;
      font-weight:800;
      letter-spacing:.08em;
      margin-top: 2px;
    }
    .sumStats{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .sumPill{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      padding: 8px 6px;
      text-align:center;
    }
    .sumPill .k{
      font-size:10px;
      opacity:.85;
      letter-spacing:.08em;
      font-weight:900;
      margin-bottom: 6px;
    }
    .sumPill .v{
      font-size:16px;
      font-weight:900;
      letter-spacing:.02em;
    }

    /* ---------- Modal ---------- */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(520px, 96vw);
      background: rgba(255,255,255,.11);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 8px 22px rgba(6,34,56,.16);
      padding: 14px;
      position:relative;
    }

    /* avoid stacked glass layers inside modal */
    .modal .statCard,
    .modal .reportBox,
    .modal .qrWrap{
      background: transparent;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom: 10px;
    }
    .modalTitle{ font-weight:900; font-size:16px; letter-spacing:.02em; }

    .xbtn{
      border:1px solid rgba(255,255,255,.30);
      background: rgba(255,255,255,.10);
      color:#fff;
      width:34px; height:34px;
      border-radius: 12px;
      cursor:pointer;
      font-size:16px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      touch-action: manipulation;
    }
    .xbtn:active{ transform: scale(.98); }

    .modalBody{ margin-top: 6px; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .field label{ display:block; font-size:12px; opacity:.9; margin:0 0 6px 2px; }
    .field input{
      width:100%; box-sizing:border-box;
      border-radius:12px; border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.10);
      color:#fff; padding:10px 12px; font-size:14px;
      outline:none; touch-action: manipulation;
    }
    .field input::placeholder{ color: rgba(255,255,255,.75); }

    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .reportBox{
      width:100%;
      box-sizing:border-box;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      padding: 10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* QR */
    .qrWrap{
      margin-top:12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      padding: 12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .qrTitle{
      font-weight:900;
      letter-spacing:.02em;
      font-size:13px;
      opacity:.95;
      text-align:center;
    }
    .qrCard{
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #qr_box{ display:flex; align-items:center; justify-content:center; }
    #qr_box img, #qr_box canvas{ display:block; border-radius: 10px; }
    .qrNote{
      opacity:.90;
      font-size:13px;
      text-align:center;
      line-height:1.25;
      max-width: 420px;
    }


    /* iPad/Safari can render nested glass layers as white blocks.
       Keep calendar on a single translucent layer there. */
    @supports (-webkit-touch-callout: none){
      .calSurface{
        background: rgba(168,219,245,.12);
      }
    }

    @media (max-width: 520px){
      .wrap{ width:100vw; padding:12px 2px 20px; }
      .card{ padding:10px; height:min(920px,95vh); }
      .appHeader{ padding:4px 0 4px; }
      .pill{ width: 290px; }
      .grid2{ grid-template-columns: 1fr; }
      .timerBox{ flex-basis: 112px; }

      /* tighter calendar on small screens so it NEVER overflows */
      .calSurface{ padding:8px 4px 8px; }
      .statsPanel{ grid-template-columns: 1fr; }
      .calGrid{ gap:1px; }
      .dayContent{ inset:3px; }
      .dayCell{ border-radius: 0; }
      .miniClean{ gap:1px; font-size:9px; }

      .statGrid{ grid-template-columns: repeat(5, minmax(0,1fr)); }
      .sumStats{ grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="appHeader">
      <div class="topbar">
        <div>
          <div class="title" id="today_title">KPIs Counter</div>
          <div class="subtitle" id="today_date"></div>
        </div>
        <div class="btnrow" id="top_actions">
          <button class="btn langBtn" id="lang_toggle" title="Cambiar idioma / Change language">Idioma</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="counter" id="tab_counter_label">Contador</div>
        <div class="tab" data-tab="calendar" id="tab_calendar_label">Calendario</div>
        <div class="tab" data-tab="summary" id="tab_summary_label">Resumen</div>
      </div>
      </div>

      <div class="appMain">
      <!-- ============ TAB: COUNTER ============ -->
      <div id="tab_counter">
        <div id="start_screen" class="center centerIntro">
          <div style="opacity:.9; font-size:13px; max-width: 360px;" id="start_intro">
            Presiona <b>Iniciar d√≠a</b> para comenzar.
          </div>
          <button class="btn primary" id="start_day">Start day</button>
          <button class="btn" id="edit_profile" style="display:none;">Editar datos</button>
        </div>

        <div id="session_screen" style="display:none;">
          <div class="sessionInfo">
            <div class="left">
              <div class="line1" id="who_line">‚Äî</div>
              <div class="line2" id="date_line">‚Äî</div>
            </div>
            <div class="timerBox">
              <div class="t1">Session</div>
              <div class="t2" id="timer">00:00:00</div>
            </div>
          </div>

          <div class="metrics" id="list"></div>

          <div class="indicators">
            <div class="ind">
              <div class="k">% Aggressiveness (Z/S)</div>
              <div class="v" id="aggr">‚Äî</div>
            </div>
            <div class="ind">
              <div class="k">% Close (X/Z)</div>
              <div class="v" id="close">0.0%</div>
            </div>
          </div>

          <div class="btnrow" style="margin-top:12px; justify-content:center;">
            <button class="btn helpBtn" id="rating_help_btn" aria-label="Ver criterios de clasificaci√≥n">?</button>
            <button class="btn primary" id="finish_day">End day</button>
          </div>
          <div id="finish_result" class="finishResult"></div>
        </div>
      </div>

      <!-- ============ TAB: CALENDAR ============ -->
      <div id="tab_calendar" style="display:none;">
        <div class="calSurface">
          <div class="calHeader">
            <div class="iconBtn" id="cal_prev" aria-label="Previous month">‚Äπ</div>
            <div class="calTitle" id="cal_title">‚Äî</div>
            <div class="iconBtn" id="cal_next" aria-label="Next month">‚Ä∫</div>
          </div>

          <div class="calGrid" id="cal_grid"></div>

          <div class="statsPanel">
            <div class="statCard" id="week_stats"></div>
            <div class="statCard" id="month_stats"></div>
          </div>
        </div>
      </div>

      <!-- ============ TAB: SUMMARY ============ -->
      <div id="tab_summary" style="display:none;">
        <div class="sumWrap" id="sum_wrap"></div>
      </div>

      </div>
      <div class="footer">KPIs Counter v4.4 ‚Äî Designed by Alen Cordero</div>
    </div>
  </div>

  <!-- Modal: Start day -->
  <div class="overlay" id="modal_start">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Start day">
      <div class="modalHeader">
        <div class="modalTitle" id="start_modal_title">Start day</div>
        <button class="xbtn" id="start_x" aria-label="Close">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.9; font-size:13px;" id="start_modal_intro">
          Ingresa tus datos para iniciar.
        </div>
        <div class="grid2">
          <div class="field">
            <label id="start_name_label">Nombre</label>
            <input id="start_name" placeholder="Ej: Bob" autocomplete="name" />
          </div>
          <div class="field">
            <label id="start_store_label">Tienda</label>
            <input id="start_store" placeholder="Ej: 2770 Valwood - Irving" />
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="start_cancel">Cancel</button>
          <button class="btn primary" id="start_confirm">Start</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Day summary -->
  <div class="overlay" id="modal_report">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Day summary">
      <div class="modalHeader">
        <div class="modalTitle">Resumen del d√≠a / Day summary</div>
        <button class="xbtn" id="report_x" aria-label="Back">√ó</button>
      </div>
      <div class="modalBody">
        <div id="report_day_rating" class="ratingNote" style="display:none;"></div>

        <div id="qr_wrap" class="qrWrap" style="display:none;">
          <div class="qrTitle">Abrir reporte en el tel√©fono / Open report on your phone</div>
          <div class="qrCard">
            <div id="qr_box"></div>
          </div>
          <div class="qrNote" id="qr_note">
            Escanea el QR y env√≠a el reporte desde tu tel√©fono.
            Scan the QR and send the report from your phone.
          </div>
        </div>

        <div class="reportBox" id="report_box">‚Äî</div>

        <div class="modalActions" id="report_actions">
          <button class="btn" id="copy_btn">Copy</button>
          <button class="btn primary" id="share_btn">Share</button>
          <button class="btn primary" id="end_btn" style="display:none;">End day</button>
        </div>

        <div id="report_hint" style="margin-top:10px; opacity:.8; font-size:12px;">
          Copia o comparte para terminar el d√≠a y resetear. / Copy or share ends the day and resets.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Day details (calendar click) -->
  <div class="overlay" id="modal_day">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Day details">
      <div class="modalHeader">
        <div class="modalTitle" id="day_modal_title">Day details</div>
        <button class="xbtn" id="day_x" aria-label="Close">√ó</button>
      </div>

      <div class="modalBody">
        <div class="statCard" id="day_modal_meta" style="margin:0;"></div>

        <div style="margin-top:10px;">
          <div class="reportBox" id="day_modal_report">‚Äî</div>
        </div>

        <div class="grid2" id="day_edit_grid" style="display:none; margin-top:10px;">
          <div class="field"><label>S</label><input id="day_edit_s" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>Z</label><input id="day_edit_z" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>CC</label><input id="day_edit_cc" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>C</label><input id="day_edit_c" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>X</label><input id="day_edit_x" type="number" min="0" inputmode="numeric" /></div>
        </div>

        <div class="modalActions">
          <button class="btn" id="day_copy">Copy</button>
          <button class="btn" id="day_share">Share</button>
          <button class="btn" id="day_edit">Editar d√≠a</button>
          <button class="btn" id="day_delete">Borrar d√≠a</button>
          <button class="btn primary" id="day_save" style="display:none;">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Rating help -->
  <div class="overlay" id="modal_rating_help">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Criterios de clasificaci√≥n">
      <div class="modalHeader">
        <div class="modalTitle" id="rating_help_title">Day rating rules</div>
        <button class="xbtn" id="rating_help_x" aria-label="Close">√ó</button>
      </div>
      <div class="modalBody" id="rating_help_body" style="font-size:13px; line-height:1.45;"></div>
    </div>
  </div>

  <!-- Modal: Language -->
  <div class="overlay" id="modal_language">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Language">
      <div class="modalHeader">
        <div class="modalTitle" id="lang_modal_title">Idioma</div>
        <button class="xbtn" id="lang_x" aria-label="Close">√ó</button>
      </div>
      <div class="modalBody">
        <div id="lang_modal_intro" style="opacity:.9; font-size:13px; margin-bottom:12px;">Selecciona el idioma:</div>
        <div class="modalActions">
          <button class="btn" id="lang_es">Espa√±ol</button>
          <button class="btn primary" id="lang_en">English</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

<script>
  const metrics = ["S","Z","CC","C","X"];
  const STATE_KEY = "kpi_state_v44";
  const HISTORY_KEY = "kpi_history_v1";
  const PROFILE_KEY = "kpi_profile_v1";
  const LANG_KEY = "kpi_lang_v1";
  const AGGR_MIN_STOPS = 20;
  const MONEY_PER_X = 100;

  const i18n = {
    es: {
      tabCounter: "Contador",
      tabCalendar: "Calendario",
      tabSummary: "Resumen",
      languageBtn: "Idioma",
      languageModalTitle: "Idioma",
      languageModalIntro: "Selecciona el idioma:",
      languageSpanish: "Espa√±ol",
      languageEnglish: "Ingl√©s",
      session: "Sesi√≥n",
      startIntro: "Presiona <b>Iniciar d√≠a</b> para comenzar.",
      startDay: "Iniciar d√≠a",
      editProfile: "Editar datos",
      finishDay: "Finalizar d√≠a",
      startModalTitle: "Iniciar d√≠a",
      startModalIntro: "Ingresa tus datos para iniciar.",
      nameLabel: "Nombre",
      storeLabel: "Tienda",
      cancel: "Cancelar",
      start: "Iniciar",
      date: "Fecha",
      day: "D√≠a",
      begins: "Inicio",
      missingProfile: "Por favor ingresa Nombre y Tienda.",
      endConfirm: "¬øSeguro que quieres finalizar el d√≠a y resetear?",
      finishResult: "Resultado",
      dayResult: "Resultado del d√≠a",
      weekStatsTitle: "Stats de la semana",
      monthStatsTitle: "Stats del mes",
      avgStopsPerDay: "Promedio S/d√≠a",
      hoursWorked: "Horas trabajadas",
      workedDays: "D√≠as trabajados",
      currentWeek: "Semana actual",
      currentMonth: "Mes actual",
      historical: "Hist√≥rico",
      sinceFirstDay: "Desde tu primer d√≠a registrado",
      bestDay: "Mejor d√≠a",
      noSavedDays: "A√∫n no hay d√≠as finalizados guardados.",
      avgXPerDay: "Prom. X/d√≠a",
      days: "D√≠as",
      dayRatingRules: "Criterios de clasificaci√≥n del d√≠a",
      quickCriteria: "Criterios r√°pidos:",
      specialBadges: "Badges especiales:",
      goodDayRule: "<b>Buen d√≠a (punto verde)</b>: S es 80 o m√°s + Agresividad es 10% o m√°s, O X es 2 o m√°s.",
      regularDayRule: "<b>D√≠a regular (punto amarillo)</b>: S est√° entre 50 y 79, O S es 80 o m√°s + Agresividad menor a 10%.",
      badDayRule: "<b>Mal d√≠a (punto rojo)</b>: S es menor a 50 + X es 0.",
      luckyDayRule: "<b>üçÄ D√≠a con suerte</b>: S menor a 50 + X 1 o m√°s (el punto sigue amarillo).",
      solidDayRule: "<b>üéØ D√≠a s√≥lido (sin resultado)</b>: S 80 o m√°s + Agresividad 10% o m√°s + X 0 (el punto sigue verde).",
      goodDay: "Buen d√≠a",
      regularDay: "Regular",
      badDay: "Mal d√≠a",
      luckyBadge: "üçÄ D√≠a con suerte",
      solidBadge: "üéØ D√≠a s√≥lido (sin resultado)"
    },
    en: {
      tabCounter: "Counter",
      tabCalendar: "Calendar",
      tabSummary: "Summary",
      languageBtn: "Language",
      languageModalTitle: "Language",
      languageModalIntro: "Select your language:",
      languageSpanish: "Spanish",
      languageEnglish: "English",
      session: "Session",
      startIntro: "Tap <b>Start day</b> to begin.",
      startDay: "Start day",
      editProfile: "Edit profile",
      finishDay: "End day",
      startModalTitle: "Start day",
      startModalIntro: "Enter your info to start.",
      nameLabel: "Name",
      storeLabel: "Store",
      cancel: "Cancel",
      start: "Start",
      date: "Date",
      day: "Day",
      begins: "Start",
      missingProfile: "Please enter Name and Store.",
      endConfirm: "Are you sure you want to end the day and reset?",
      finishResult: "Result",
      dayResult: "Day result",
      weekStatsTitle: "Week stats",
      monthStatsTitle: "Month stats",
      avgStopsPerDay: "Avg S/day",
      hoursWorked: "Hours worked",
      workedDays: "Days worked",
      currentWeek: "Current week",
      currentMonth: "Current month",
      historical: "Historical",
      sinceFirstDay: "Since your first recorded day",
      bestDay: "Best day",
      noSavedDays: "No completed days saved yet.",
      avgXPerDay: "Avg X/day",
      days: "Days",
      dayRatingRules: "Day rating rules",
      quickCriteria: "Quick criteria:",
      specialBadges: "Special badges:",
      goodDayRule: "<b>Good day (green dot)</b>: S is 80 or more + Aggressiveness is 10% or more, OR X is 2 or more.",
      regularDayRule: "<b>Regular day (yellow dot)</b>: S is between 50 and 79, OR S is 80 or more + Aggressiveness under 10%.",
      badDayRule: "<b>Bad day (red dot)</b>: S is under 50 + X is 0.",
      luckyDayRule: "<b>üçÄ Lucky day</b>: S under 50 + X 1 or more (dot stays yellow).",
      solidDayRule: "<b>üéØ Solid day (no result)</b>: S 80 or more + Aggressiveness 10% or more + X 0 (dot stays green).",
      goodDay: "Good day",
      regularDay: "Regular",
      badDay: "Bad day",
      luckyBadge: "üçÄ Lucky day",
      solidBadge: "üéØ Solid day (no result)"
    }
  };

  const fmtPct = (n) => (Number.isFinite(n) ? (n * 100).toFixed(1) + "%" : "0.0%");
  const pad2 = (n) => String(n).padStart(2,"0");
  const fmtHours = (ms) => ((ms || 0) / 3600000).toFixed(1) + "h";

  function classifyDay(values = {}) {
    const S = Number(values.S || 0);
    const Z = Number(values.Z || 0);
    const X = Number(values.X || 0);
    const aggr = S > 0 ? ((Z / S) * 100) : 0;

    let dayRating = "regular";
    if ((S >= 80 && aggr >= 10) || X >= 2) dayRating = "good";
    else if ((S >= 50 && S < 80) || (S >= 80 && aggr < 10)) dayRating = "regular";
    else if (S < 50 && X === 0) dayRating = "bad";

    let dayBadge = "";
    if (S < 50 && X >= 1) dayBadge = "lucky";
    else if (S >= 80 && aggr >= 10 && X === 0) dayBadge = "solid_no_result";

    return { dayRating, dayBadge, aggr };
  }

  function ratingLabel(rating) {
    if (rating === "good") return t("goodDay");
    if (rating === "bad") return t("badDay");
    return t("regularDay");
  }

  function badgeLabel(badge) {
    if (badge === "lucky") return t("luckyBadge");
    if (badge === "solid_no_result") return t("solidBadge");
    return "";
  }

  function ratingLine(rating, badge) {
    const b = badgeLabel(badge);
    const base = ratingLabel(rating);
    return b ? `${base} ¬∑ ${b}` : base;
  }

  const isoDateLocal = (d = new Date()) => {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const fmtTime = (ts) => {
    if (!ts) return "‚Äî";
    const d = new Date(ts);
    let h = d.getHours();
    const m = d.getMinutes();
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${pad2(m)} ${ampm}`;
  };

  const fmtDuration = (ms) => {
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  };

  const monthName = (y, m) => {
    const d = new Date(y, m, 1);
    return d.toLocaleString(undefined, { month:"long", year:"numeric" });
  };

  const startOfWeekMon = (d) => {
    const out = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = out.getDay();
    const diff = (day === 0) ? -6 : (1 - day);
    out.setDate(out.getDate() + diff);
    out.setHours(0,0,0,0);
    return out;
  };

  const endOfWeekSun = (d) => {
    const s = startOfWeekMon(d);
    const e = new Date(s);
    e.setDate(e.getDate() + 6);
    e.setHours(23,59,59,999);
    return e;
  };

  document.addEventListener("dblclick", (e) => e.preventDefault(), { passive:false });

  // ---------- History ----------
  function loadHistory() {
    try {
      const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || "{}");
      return (h && typeof h === "object") ? h : {};
    } catch {
      return {};
    }
  }
  function saveHistory(hist) {
    try { localStorage.setItem(HISTORY_KEY, JSON.stringify(hist)); } catch {}
  }
  function upsertDayInHistory(dayISO, payload) {
    const hist = loadHistory();
    hist[dayISO] = payload;
    saveHistory(hist);
  }

  function sumRecords(records) {
    const totals = { S:0, Z:0, CC:0, C:0, X:0, days:0, durationMs:0 };
    records.forEach(r => {
      totals.days += 1;
      metrics.forEach(k => totals[k] += (r.values?.[k] || 0));
      totals.durationMs += (r.durationMs || 0);
    });
    return totals;
  }

  function recordsInRange(startDate, endDate) {
    const hist = loadHistory();
    const out = [];
    const startISO = isoDateLocal(startDate);
    const endISO = isoDateLocal(endDate);

    Object.keys(hist).forEach(iso => {
      if (iso >= startISO && iso <= endISO) out.push(hist[iso]);
    });

    out.sort((a,b) => (a.date || "").localeCompare(b.date || ""));
    return out;
  }

  function recordsInMonth(year, monthIdx) {
    const start = new Date(year, monthIdx, 1);
    const end = new Date(year, monthIdx + 1, 0);
    return recordsInRange(start, end);
  }

  // ---------- Load session state ----------
  const saved = JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
  const savedProfile = JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
  const savedLang = localStorage.getItem(LANG_KEY);
  let currentLang = savedLang === "en" ? "en" : "es";
  const state = {
    active: !!saved.active,
    date: saved.date || isoDateLocal(),
    rep: saved.rep || savedProfile.rep || "",
    store: saved.store || savedProfile.store || "",
    values: saved.values || {},
    sessionStart: saved.sessionStart || null,
  };
  metrics.forEach(k => { if (typeof state.values[k] !== "number") state.values[k] = 0; });

  // ---------- DOM ----------
  const todayDateEl = document.getElementById("today_date");
  const startIntro = document.getElementById("start_intro");
  const startDayBtn = document.getElementById("start_day");
  const finishDayBtn = document.getElementById("finish_day");
  const editProfileBtn = document.getElementById("edit_profile");
  const langToggleBtn = document.getElementById("lang_toggle");
  const modalLanguage = document.getElementById("modal_language");
  const langEsBtn = document.getElementById("lang_es");
  const langEnBtn = document.getElementById("lang_en");

  // Tabs
  const tabEls = Array.from(document.querySelectorAll(".tab"));
  const tabCounter = document.getElementById("tab_counter");
  const tabCalendar = document.getElementById("tab_calendar");
  const tabSummary = document.getElementById("tab_summary");

  // Counter
  const startScreen = document.getElementById("start_screen");
  const sessionScreen = document.getElementById("session_screen");
  const list = document.getElementById("list");
  const whoLine = document.getElementById("who_line");
  const dateLine = document.getElementById("date_line");
  const timerEl = document.getElementById("timer");
  const aggrEl = document.getElementById("aggr");
  const closeEl = document.getElementById("close");

  // Calendar
  const calTitle = document.getElementById("cal_title");
  const calGrid = document.getElementById("cal_grid");
  const weekStatsEl = document.getElementById("week_stats");
  const monthStatsEl = document.getElementById("month_stats");

  // Summary
  const sumWrap = document.getElementById("sum_wrap");

  // Modals
  const modalStart = document.getElementById("modal_start");
  const modalReport = document.getElementById("modal_report");
  const startName = document.getElementById("start_name");
  const startStore = document.getElementById("start_store");
  const reportBox = document.getElementById("report_box");

  // QR
  const qrWrap = document.getElementById("qr_wrap");
  const qrBox = document.getElementById("qr_box");

  // Report actions
  const reportHint = document.getElementById("report_hint");
  const reportDayRating = document.getElementById("report_day_rating");
  const endBtn = document.getElementById("end_btn");
  const copyBtn = document.getElementById("copy_btn");
  const shareBtn = document.getElementById("share_btn");

  // Day details modal
  const modalDay = document.getElementById("modal_day");
  const dayX = document.getElementById("day_x");
  const dayModalTitle = document.getElementById("day_modal_title");
  const dayModalMeta = document.getElementById("day_modal_meta");
  const dayModalReport = document.getElementById("day_modal_report");
  const dayCopyBtn = document.getElementById("day_copy");
  const dayShareBtn = document.getElementById("day_share");
  const dayEditBtn = document.getElementById("day_edit");
  const dayDeleteBtn = document.getElementById("day_delete");
  const daySaveBtn = document.getElementById("day_save");
  const dayEditGrid = document.getElementById("day_edit_grid");
  const dayEditS = document.getElementById("day_edit_s");
  const dayEditZ = document.getElementById("day_edit_z");
  const dayEditCC = document.getElementById("day_edit_cc");
  const dayEditC = document.getElementById("day_edit_c");
  const dayEditX = document.getElementById("day_edit_x");
  const finishResult = document.getElementById("finish_result");
  const modalRatingHelp = document.getElementById("modal_rating_help");

  // ---------- Save session ----------
  function saveStateNow() { localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
  function saveState() { try { saveStateNow(); } catch {} }

  window.addEventListener("pagehide", () => { try { saveStateNow(); } catch {} });
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") { try { saveStateNow(); } catch {} }
  });

  function t(key) {
    return i18n[currentLang][key] || i18n.es[key] || key;
  }

  function saveProfile(rep, store) {
    try {
      localStorage.setItem(PROFILE_KEY, JSON.stringify({ rep, store }));
    } catch {}
  }

  function applyTranslations() {
    document.documentElement.lang = currentLang;
    document.getElementById("tab_counter_label").textContent = t("tabCounter");
    document.getElementById("tab_calendar_label").textContent = t("tabCalendar");
    document.getElementById("tab_summary_label").textContent = t("tabSummary");
    startIntro.innerHTML = t("startIntro");
    startDayBtn.textContent = t("startDay");
    editProfileBtn.textContent = t("editProfile");
    finishDayBtn.textContent = t("finishDay");
    document.getElementById("start_modal_title").textContent = t("startModalTitle");
    document.getElementById("start_modal_intro").textContent = t("startModalIntro");
    document.getElementById("start_name_label").textContent = t("nameLabel");
    document.getElementById("start_store_label").textContent = t("storeLabel");
    document.getElementById("start_cancel").textContent = t("cancel");
    document.getElementById("start_confirm").textContent = t("start");
    langToggleBtn.textContent = "Idioma";
    document.getElementById("lang_modal_title").textContent = t("languageModalTitle");
    document.getElementById("lang_modal_intro").textContent = t("languageModalIntro");
    langEsBtn.textContent = t("languageSpanish");
    langEnBtn.textContent = t("languageEnglish");
    document.querySelector(".t1").textContent = t("session");
    document.getElementById("rating_help_title").textContent = t("dayRatingRules");
    document.getElementById("rating_help_body").innerHTML = `
      <div style="font-weight:700; margin-bottom:8px;">${t("quickCriteria")}</div>
      <ul style="margin:0 0 10px 18px; padding:0;">
        <li>${t("goodDayRule")}</li>
        <li>${t("regularDayRule")}</li>
        <li>${t("badDayRule")}</li>
      </ul>
      <div style="font-weight:700; margin-bottom:8px;">${t("specialBadges")}</div>
      <ul style="margin:0 0 0 18px; padding:0;">
        <li>${t("luckyDayRule")}</li>
        <li>${t("solidDayRule")}</li>
      </ul>
    `;
    renderHeader();
    if (state.active) renderSessionInfo();
  }

  function setLanguage(lang) {
    currentLang = lang === "en" ? "en" : "es";
    try { localStorage.setItem(LANG_KEY, currentLang); } catch {}
    closeModal(modalLanguage);
    applyTranslations();
    renderCalendarStats();
    renderSummary();
  }

  // ---------- UI ----------
  const valEls = {};
  function renderHeader() {
    todayDateEl.textContent = `${t("date")}: ${state.date}`;
  }

  function renderSessionInfo() {
    whoLine.textContent = `${state.rep || "‚Äî"} ‚Ä¢ ${state.store || "‚Äî"}`;
    dateLine.textContent = `${t("day")}: ${state.date} ‚Ä¢ ${t("begins")}: ${fmtTime(state.sessionStart)}`;
  }

  function renderMetrics() {
    list.innerHTML = "";
    metrics.forEach(k => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="label">${k}</div>
        <div class="pill">
          <button aria-label="minus ${k}" data-k="${k}" data-d="-1">‚àí</button>
          <div class="sep"></div>
          <div class="val" id="v_${k}">${state.values[k]}</div>
          <div class="sep"></div>
          <button aria-label="plus ${k}" data-k="${k}" data-d="1">+</button>
        </div>
      `;
      list.appendChild(row);
    });
    metrics.forEach(k => { valEls[k] = document.getElementById("v_" + k); });
  }

  function renderIndicators() {
    const S = state.values.S;
    const Z = state.values.Z;
    const X = state.values.X;

    if (S >= AGGR_MIN_STOPS) aggrEl.textContent = fmtPct(S > 0 ? (Z / S) : 0);
    else aggrEl.textContent = `‚Äî (min ${AGGR_MIN_STOPS} S)`;

    closeEl.textContent = fmtPct(Z > 0 ? (X / Z) : 0);
  }

  function showStartScreen() {
    state.active = false;
    startScreen.style.display = "";
    sessionScreen.style.display = "none";
    editProfileBtn.style.display = (state.rep && state.store) ? "" : "none";
    renderHeader();
  }

  function showSessionScreen() {
    startScreen.style.display = "none";
    sessionScreen.style.display = "";
    renderHeader();
    renderSessionInfo();
    renderMetrics();
    renderIndicators();
  }

  // ---------- Timer ----------
  let timerInterval = null;
  function startTimerLoop() {
    stopTimerLoop();
    timerInterval = setInterval(() => {
      if (!state.active || !state.sessionStart) return;
      timerEl.textContent = fmtDuration(Date.now() - state.sessionStart);
    }, 1000);

    if (state.active && state.sessionStart) timerEl.textContent = fmtDuration(Date.now() - state.sessionStart);
    else timerEl.textContent = "00:00:00";
  }
  function stopTimerLoop() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
  }

  // ---------- Modals helpers ----------
  function openModal(el) { el.classList.add("show"); }
  function closeModal(el) { el.classList.remove("show"); }

  function clickOutsideToClose(overlayEl, allow) {
    overlayEl.addEventListener("click", (e) => {
      if (!allow) return;
      if (e.target === overlayEl) closeModal(overlayEl);
    });
  }
  clickOutsideToClose(modalStart, true);
  clickOutsideToClose(modalReport, false);
  clickOutsideToClose(modalDay, true);
  clickOutsideToClose(modalRatingHelp, true);
  dayX.addEventListener("click", () => closeModal(modalDay));
  document.getElementById("rating_help_x").addEventListener("click", () => closeModal(modalRatingHelp));

  // ---------- Session logic ----------
  function startDay(rep, store) {
    finishResult.textContent = "";
    reportDayRating.style.display = "none";
    reportDayRating.textContent = "";
    state.date = isoDateLocal();
    state.rep = rep;
    state.store = store;
    metrics.forEach(k => state.values[k] = 0);
    state.sessionStart = Date.now();
    state.active = true;
    saveStateNow();
    showSessionScreen();
    startTimerLoop();
  }

  function buildReport(endTs) {
    const S = state.values.S, Z = state.values.Z, CC = state.values.CC, C = state.values.C, X = state.values.X;

    const aggr = (S >= AGGR_MIN_STOPS && S > 0) ? (Z / S) : null;
    const close = (Z > 0) ? (X / Z) : 0;

    const startTs = state.sessionStart || endTs;
    const duration = fmtDuration(endTs - startTs);

    const aggrLine = (aggr !== null)
      ? `% Aggressiveness (Z/S): ${fmtPct(aggr)}`
      : `% Aggressiveness (Z/S): ‚Äî (min ${AGGR_MIN_STOPS} S)`;

    return [
      `Name: ${state.rep || "-"}`,
      `Store: ${state.store || "-"}`,
      `Date: ${state.date}`,
      ``,
      `Start: ${fmtTime(startTs)}`,
      `End: ${fmtTime(endTs)}`,
      `Duration: ${duration}`,
      ``,
      `S: ${S} | Z: ${Z} | CC: ${CC} | C: ${C} | X: ${X}`,
      aggrLine,
      `% Close (X/Z): ${fmtPct(close)}`
    ].join("\n");
  }

  function persistCompletedDay(endTs, reportText) {
    const startTs = state.sessionStart || endTs;
    const ratingInfo = classifyDay(state.values);
    const payload = {
      date: state.date,
      rep: state.rep || "",
      store: state.store || "",
      startTs,
      endTs,
      durationMs: Math.max(0, endTs - startTs),
      values: { ...state.values },
      money: (state.values.X || 0) * MONEY_PER_X,
      reportText: reportText || "",
      dayRating: ratingInfo.dayRating,
      dayBadge: ratingInfo.dayBadge
    };
    const hist = loadHistory();
    hist[state.date] = payload;
    saveHistory(hist);
  }

  function finalizeAndReset() {
    state.active = false;
    finishResult.textContent = "";
    reportDayRating.style.display = "none";
    reportDayRating.textContent = "";
    state.sessionStart = null;
    state.date = isoDateLocal();
    metrics.forEach(k => state.values[k] = 0);
    saveStateNow();
    stopTimerLoop();
    timerEl.textContent = "00:00:00";
    closeModal(modalReport);
    showStartScreen();
    renderCalendar();
    renderSummary();
  }

  function setReportMode(mode) {
    const isPhone = mode === "phone";
    copyBtn.style.display = isPhone ? "" : "none";
    shareBtn.style.display = isPhone ? "" : "none";
    reportHint.style.display = isPhone ? "" : "none";
    endBtn.style.display = isPhone ? "none" : "";
  }

  // ---------- QR ----------
  function makeShareUrlFromReport(text) {
    const payload = LZString.compressToEncodedURIComponent(text);
    return `${location.origin}${location.pathname}#r=${payload}`;
  }

  function showQRForText(text) {
    qrBox.innerHTML = "";
    qrWrap.style.display = "";
    const url = makeShareUrlFromReport(text);
    new QRCode(qrBox, { text: url, width: 176, height: 176, correctLevel: QRCode.CorrectLevel.L });
  }

  function tryLoadReportFromHash() {
    const h = location.hash || "";
    if (!h.startsWith("#r=")) return false;
    try {
      const payload = h.slice(3);
      const text = LZString.decompressFromEncodedURIComponent(payload);
      if (!text) return false;
      reportBox.textContent = text;
      qrWrap.style.display = "none";
      setReportMode("phone");
      openModal(modalReport);
      return true;
    } catch {
      return false;
    }
  }

  // ---------- Day details modal logic ----------
  function buildFullReportFromRecord(rec){
    if (!rec) return "No data for this day.";
    if (rec.reportText) return rec.reportText;

    const S = rec.values?.S ?? 0;
    const Z = rec.values?.Z ?? 0;
    const CC = rec.values?.CC ?? 0;
    const C = rec.values?.C ?? 0;
    const X = rec.values?.X ?? 0;

    const aggr = (S >= AGGR_MIN_STOPS && S > 0) ? (Z / S) : null;
    const close = (Z > 0) ? (X / Z) : 0;

    const aggrLine = (aggr !== null)
      ? `% Aggressiveness (Z/S): ${fmtPct(aggr)}`
      : `% Aggressiveness (Z/S): ‚Äî (min ${AGGR_MIN_STOPS} S)`;

    return [
      `Name: ${rec.rep || "-"}`,
      `Store: ${rec.store || "-"}`,
      `Date: ${rec.date || "-"}`,
      ``,
      `Start: ${fmtTime(rec.startTs)}`,
      `End: ${fmtTime(rec.endTs)}`,
      `Duration: ${fmtDuration(rec.durationMs || 0)}`,
      ``,
      `S: ${S} | Z: ${Z} | CC: ${CC} | C: ${C} | X: ${X}`,
      aggrLine,
      `% Close (X/Z): ${fmtPct(close)}`
    ].join("\n");
  }

  function openDayModal(iso){
    const hist = loadHistory();
    const rec = hist[iso];
    activeDayISO = iso;

    dayModalTitle.textContent = rec ? `Detalle del d√≠a ‚Ä¢ ${iso}` : `Sin datos ‚Ä¢ ${iso}`;
    dayEditGrid.style.display = "none";
    daySaveBtn.style.display = "none";
    dayEditBtn.textContent = "Editar d√≠a";

    if (!rec){
      dayModalMeta.innerHTML = `
        <div class="statHead">
          <div class="h">No hay un d√≠a finalizado guardado.</div>
          <div class="p">Tip: finaliza el d√≠a para que aparezca aqu√≠.</div>
        </div>
      `;
      dayModalReport.textContent = "‚Äî";
      dayCopyBtn.style.display = "none";
      dayShareBtn.style.display = "none";
      dayEditBtn.style.display = "none";
      dayDeleteBtn.style.display = "none";
      openModal(modalDay);
      return;
    }

    const X = rec.values?.X ?? 0;
    const money = (X * MONEY_PER_X);
    const ratingInfo = classifyDay(rec.values || {});
    const rating = rec.dayRating || ratingInfo.dayRating;
    const badge = rec.dayBadge ?? ratingInfo.dayBadge;

    dayModalMeta.innerHTML = `
      <div class="statHead">
        <div>
          <div class="h">${rec.rep || "‚Äî"} ‚Ä¢ ${rec.store || "‚Äî"}</div>
          <div class="p">Start: ${fmtTime(rec.startTs)} ‚Ä¢ End: ${fmtTime(rec.endTs)} ‚Ä¢ Dur: ${fmtDuration(rec.durationMs || 0)}</div>
          <div class="p">Resultado: ${ratingLine(rating, badge)}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:1000; letter-spacing:.02em;">$${money}</div>
          <div style="font-size:11px; opacity:.85; letter-spacing:.08em; font-weight:900; margin-top:2px;">EARNED</div>
        </div>
      </div>

      <div class="statGrid">
        ${["S","Z","CC","C","X"].map(k => `
          <div class="statItem">
            <div class="k">${k}</div>
            <div class="v">${rec.values?.[k] ?? 0}</div>
          </div>
        `).join("")}
      </div>
    `;

    dayEditS.value = rec.values?.S ?? 0;
    dayEditZ.value = rec.values?.Z ?? 0;
    dayEditCC.value = rec.values?.CC ?? 0;
    dayEditC.value = rec.values?.C ?? 0;
    dayEditX.value = rec.values?.X ?? 0;

    dayModalReport.textContent = buildFullReportFromRecord(rec);
    dayCopyBtn.style.display = "";
    dayShareBtn.style.display = "";
    dayEditBtn.style.display = "";
    dayDeleteBtn.style.display = "";
    openModal(modalDay);
  }

  async function copyOrShareText(text, kind){
    if (!text) return;

    if (kind === "share" && navigator.share) {
      await navigator.share({ title: "KPI Day", text });
      return;
    }

    if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(text);
      alert(kind === "share" ? "No native Share here. Copied to clipboard." : "Copied.");
    } else {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("Copied.");
    }
  }

  dayCopyBtn.addEventListener("click", async () => { try { await copyOrShareText(dayModalReport.textContent, "copy"); } catch {} });
  dayShareBtn.addEventListener("click", async () => { try { await copyOrShareText(dayModalReport.textContent, "share"); } catch {} });

  dayEditBtn.addEventListener("click", () => {
    if (dayEditGrid.style.display === "none") {
      dayEditGrid.style.display = "grid";
      daySaveBtn.style.display = "";
      dayEditBtn.textContent = "Cancelar edici√≥n";
    } else {
      dayEditGrid.style.display = "none";
      daySaveBtn.style.display = "none";
      dayEditBtn.textContent = "Editar d√≠a";
    }
  });

  daySaveBtn.addEventListener("click", () => {
    if (!activeDayISO) return;
    const hist = loadHistory();
    const rec = hist[activeDayISO];
    if (!rec) return;
    const n = (v) => Math.max(0, parseInt(v || 0, 10) || 0);
    rec.values = {
      ...rec.values,
      S: n(dayEditS.value),
      Z: n(dayEditZ.value),
      CC: n(dayEditCC.value),
      C: n(dayEditC.value),
      X: n(dayEditX.value),
    };
    rec.money = (rec.values.X || 0) * MONEY_PER_X;
    const ratingInfo = classifyDay(rec.values || {});
    rec.dayRating = ratingInfo.dayRating;
    rec.dayBadge = ratingInfo.dayBadge;
    upsertDayInHistory(activeDayISO, rec);
    renderCalendar();
    renderCalendarStats();
    renderSummary();
    openDayModal(activeDayISO);
  });

  dayDeleteBtn.addEventListener("click", () => {
    if (!activeDayISO) return;
    if (!confirm(`¬øBorrar el d√≠a ${activeDayISO}?`)) return;
    const hist = loadHistory();
    delete hist[activeDayISO];
    saveHistory(hist);
    closeModal(modalDay);
    renderCalendar();
    renderCalendarStats();
    renderSummary();
  });

  // ---------- Metrics interactions ----------
  function bump(k, d) {
    const prev = state.values[k];
    const next = Math.max(0, prev + d);
    if (next === prev) return;
    state.values[k] = next;
    valEls[k].textContent = next;
    renderIndicators();
    saveState();
  }

  let holdTimer = null;
  let holdInterval = null;
  function startHold(k, d) {
    bump(k, d);
    holdTimer = setTimeout(() => { holdInterval = setInterval(() => bump(k, d), 90); }, 250);
  }
  function stopHold() {
    clearTimeout(holdTimer); holdTimer = null;
    clearInterval(holdInterval); holdInterval = null;
  }

  document.addEventListener("pointerdown", (e) => {
    if (!state.active) return;
    const b = e.target.closest("button[data-k]");
    if (!b) return;
    e.preventDefault();
    startHold(b.dataset.k, Number(b.dataset.d));
  }, { passive:false });

  document.addEventListener("pointerup", stopHold);
  document.addEventListener("pointercancel", stopHold);
  document.addEventListener("pointerleave", stopHold);
  window.addEventListener("blur", stopHold);
  document.addEventListener("visibilitychange", () => { if (document.visibilityState === "hidden") stopHold(); });

  // ---------- Tabs logic ----------
  function setActiveTab(tabName) {
    tabEls.forEach(t => t.classList.toggle("active", t.dataset.tab === tabName));
    tabCounter.style.display = (tabName === "counter") ? "" : "none";
    tabCalendar.style.display = (tabName === "calendar") ? "" : "none";
    tabSummary.style.display = (tabName === "summary") ? "" : "none";
    if (tabName === "calendar") renderCalendar();
    if (tabName === "summary") renderSummary();
  }

  document.getElementById("tabs").addEventListener("click", (e) => {
    const t = e.target.closest(".tab");
    if (!t) return;
    setActiveTab(t.dataset.tab);
  });

  // ---------- Calendar rendering ----------
  let selectedDayISO = null;
  let activeDayISO = null;

  let calCursor = (() => {
    const d = new Date();
    return { y: d.getFullYear(), m: d.getMonth() };
  })();

  document.getElementById("cal_prev").addEventListener("click", () => {
    calCursor.m -= 1;
    if (calCursor.m < 0) { calCursor.m = 11; calCursor.y -= 1; }
    renderCalendar();
  });
  document.getElementById("cal_next").addEventListener("click", () => {
    calCursor.m += 1;
    if (calCursor.m > 11) { calCursor.m = 0; calCursor.y += 1; }
    renderCalendar();
  });
  calGrid.addEventListener("click", (e) => {
    const cell = e.target.closest(".dayCell");
    if (!cell) return;
    const iso = cell.dataset.iso;
    if (!iso) return;
    selectedDayISO = iso;
    renderCalendar();
    openDayModal(iso);
  });

  function renderCalendar() {
    const y = calCursor.y, m = calCursor.m;
    calTitle.textContent = monthName(y, m);

    calGrid.innerHTML = "";
    const dows = currentLang === "es" ? ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"] : ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    dows.forEach(s => {
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = s.toUpperCase();
      calGrid.appendChild(el);
    });

    const first = new Date(y, m, 1);
    const firstDow = first.getDay();
    const offset = (firstDow === 0) ? 6 : (firstDow - 1);
    const gridStart = new Date(y, m, 1);
    gridStart.setDate(gridStart.getDate() - offset);

    const hist = loadHistory();
    const todayISO = isoDateLocal();

    for (let i = 0; i < 42; i++) {
      const day = new Date(gridStart);
      day.setDate(gridStart.getDate() + i);
      const iso = isoDateLocal(day);
      const inMonth = (day.getMonth() === m);
      const rec = hist[iso];

      const S = rec?.values?.S ?? 0;
      const Z = rec?.values?.Z ?? 0;
      const X = rec?.values?.X ?? 0;
      const ratingInfo = rec ? classifyDay(rec.values || {}) : null;
      const dayRating = rec ? (rec.dayRating || ratingInfo.dayRating) : "";

      const isToday = (iso === todayISO);
      const badgeText = isToday ? "HOY" : "";
      const badgeHtml = badgeText ? `<div class="badge ${isToday ? "today" : ""}">${badgeText}</div>` : "";
      const dotHtml = dayRating ? `<span class="dayDot ${dayRating}"></span>` : "";

      const cell = document.createElement("div");
      cell.className =
        "dayCell" +
        (inMonth ? "" : " muted") +
        (rec ? " hasData" : "") +
        (isToday ? " today" : "") +
        (selectedDayISO === iso ? " selected" : "");

      cell.dataset.iso = iso;

      cell.innerHTML = `
        <div class="dayContent">
          <div class="dayTop">
            <div class="dayNum">${day.getDate()}</div>
            ${badgeHtml}
            ${dotHtml}
          </div>

          <div class="miniClean">
            <span class="kpiInline">S ${S}</span>
            <span class="kpiInline">Z ${Z}</span>
            <span class="kpiInline">X ${X}</span>
          </div>
        </div>
      `;
      calGrid.appendChild(cell);
    }

    renderCalendarStats();
  }


  function renderStatCard(container, title, periodLabel, totals, avgLabel = "Promedio S/d√≠a") {
    const money = (totals.X || 0) * MONEY_PER_X;
    container.innerHTML = `
      <div class="statHead">
        <div>
          <div class="h">${title}</div>
          <div class="p">${periodLabel}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:1000; letter-spacing:.02em;">$${money}</div>
          <div style="font-size:11px; opacity:.85; letter-spacing:.08em; font-weight:1000; margin-top:2px;">EARNED</div>
        </div>
      </div>

      <div class="statGrid">
        ${["S","Z","CC","C","X"].map(k => `
          <div class="statItem">
            <div class="k">${k}</div>
            <div class="v">${totals[k] || 0}</div>
          </div>
        `).join("")}
      </div>

      <div class="moneyLine">
        <div><b>${t("workedDays")}:</b> ${totals.days || 0}</div>
        <div><b>${avgLabel}:</b> ${totals.days ? ((totals.S||0)/totals.days).toFixed(1) : "0.0"}</div>
      </div>
      <div class="moneyLine" style="margin-top:6px;">
        <div><b>${t("hoursWorked")}:</b> ${fmtHours(totals.durationMs || 0)}</div>
        <div></div>
      </div>
    `;
  }

  function renderCalendarStats() {
    const now = new Date();
    const weekStart = startOfWeekMon(now);
    const weekEnd = endOfWeekSun(now);
    const weekTotals = sumRecords(recordsInRange(weekStart, weekEnd));

    const monthTotals = sumRecords(recordsInMonth(calCursor.y, calCursor.m));

    const wLabel = `${isoDateLocal(weekStart)} ‚Üí ${isoDateLocal(weekEnd)}`;
    const mLabel = `${calCursor.y}-${String(calCursor.m+1).padStart(2,"0")}`;

    renderStatCard(weekStatsEl, t("weekStatsTitle"), wLabel, weekTotals, t("avgStopsPerDay"));
    renderStatCard(monthStatsEl, t("monthStatsTitle"), mLabel, monthTotals, t("avgStopsPerDay"));
  }

  // ---------- Summary rendering ----------
  function renderSummary() {
    const now = new Date();
    const weekStart = startOfWeekMon(now);
    const weekEnd = endOfWeekSun(now);
    const weekTotals = sumRecords(recordsInRange(weekStart, weekEnd));
    const monthTotals = sumRecords(recordsInMonth(now.getFullYear(), now.getMonth()));

    const hist = loadHistory();
    const allRecords = Object.keys(hist).map(k => hist[k]).filter(Boolean);
    allRecords.sort((a,b) => (a.date||"").localeCompare(b.date||""));
    const allTotals = sumRecords(allRecords);

    const bestDay = (() => {
      let best = null;
      for (const r of allRecords) {
        const x = r.values?.X || 0;
        if (!best || x > (best.values?.X||0)) best = r;
      }
      return best;
    })();

    const card = (title, sub, totals) => {
      const money = (totals.X||0) * MONEY_PER_X;
      const days = totals.days || 0;
      const avgX = days ? ((totals.X||0)/days).toFixed(1) : "0.0";
      const close = (totals.Z||0) ? (((totals.X||0)/(totals.Z||0))*100).toFixed(1) + "%" : "0.0%";
      const aggr = (totals.S||0) ? (((totals.Z||0)/(totals.S||0))*100).toFixed(1) + "%" : "0.0%";

      return `
        <div class="sumCard">
          <div class="sumTop">
            <div>
              <div class="sumTitle">${title}</div>
              <div class="sumSub">${sub}</div>
            </div>
            <div class="sumMoney">$${money}<span>EARNED</span></div>
          </div>
          <div class="sumStats">
            <div class="sumPill"><div class="k">X</div><div class="v">${totals.X||0}</div></div>
            <div class="sumPill"><div class="k">${t("avgXPerDay")}</div><div class="v">${avgX}</div></div>
            <div class="sumPill"><div class="k">${t("days")}</div><div class="v">${days}</div></div>
          </div>
          <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <div class="sumPill"><div class="k">% Agg (Z/S)</div><div class="v">${aggr}</div></div>
            <div class="sumPill"><div class="k">% Close (X/Z)</div><div class="v">${close}</div></div>
          </div>
        </div>
      `;
    };

    const bestBlock = bestDay ? `
      <div class="sumCard">
        <div class="sumTop">
          <div>
            <div class="sumTitle">${t("bestDay")}</div>
            <div class="sumSub">${bestDay.date} ‚Ä¢ ${bestDay.store || ""}</div>
          </div>
          <div class="sumMoney">$${(bestDay.values?.X||0)*MONEY_PER_X}<span>EARNED</span></div>
        </div>
        <div class="sumStats">
          ${["S","Z","CC","C","X"].map(k => `
            <div class="sumPill"><div class="k">${k}</div><div class="v">${bestDay.values?.[k] ?? 0}</div></div>
          `).join("")}
        </div>
      </div>
    ` : `
      <div class="sumCard">
        <div class="sumTitle">${t("historical")}</div>
        <div class="sumSub">${t("noSavedDays")}</div>
      </div>
    `;

    sumWrap.innerHTML = `
      ${card(t("currentWeek"), `${isoDateLocal(weekStart)} ‚Üí ${isoDateLocal(weekEnd)}`, weekTotals)}
      ${card(t("currentMonth"), `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`, monthTotals)}
      ${card(t("historical"), t("sinceFirstDay"), allTotals)}
      ${bestBlock}
    `;
  }

  // ---------- Buttons ----------
  function openStartModal() {
    startName.value = state.rep || "";
    startStore.value = state.store || "";
    openModal(modalStart);
    setTimeout(() => startName.focus(), 50);
  }

  startDayBtn.addEventListener("click", () => {
    if (state.rep && state.store) {
      startDay(state.rep, state.store);
      return;
    }
    openStartModal();
  });

  editProfileBtn.addEventListener("click", () => {
    openStartModal();
  });

  document.getElementById("start_x").addEventListener("click", () => closeModal(modalStart));
  document.getElementById("start_cancel").addEventListener("click", () => closeModal(modalStart));

  document.getElementById("start_confirm").addEventListener("click", () => {
    const rep = (startName.value || "").trim();
    const store = (startStore.value || "").trim();
    if (!rep || !store) {
      alert(t("missingProfile"));
      return;
    }
    state.rep = rep;
    state.store = store;
    saveProfile(rep, store);
    closeModal(modalStart);
    startDay(rep, store);
  });

  [startName, startStore].forEach((inp) => {
    inp.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      if (inp === startName) startStore.focus();
      else document.getElementById("start_confirm").click();
    });
  });

  document.getElementById("finish_day").addEventListener("click", () => {
    const endTs = Date.now();
    const text = buildReport(endTs);
    const ratingInfo = classifyDay(state.values || {});
    const result = ratingLine(ratingInfo.dayRating, ratingInfo.dayBadge);
    finishResult.textContent = `${t("finishResult")}: ${result}`;
    reportDayRating.style.display = "";
    reportDayRating.textContent = `${t("dayResult")}: ${result}`;
    reportBox.textContent = text;
    showQRForText(text);
    setReportMode("tablet");
    openModal(modalReport);
  });

  document.getElementById("report_x").addEventListener("click", () => closeModal(modalReport));
  document.getElementById("rating_help_btn").addEventListener("click", () => openModal(modalRatingHelp));

  async function doCopyOrShare(kind) {
    const confirmMsg =
      `Are you sure you want to ${kind === "copy" ? "COPY" : "SHARE"}?\n` +
      `This ends the day and resets.`;

    if (!confirm(confirmMsg)) return;

    const endTs = Date.now();
    const text = reportBox.textContent || "";

    try {
      if (kind === "share") {
        if (navigator.share) {
          await navigator.share({ title: "KPI Report", text });
        } else if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          alert("No native Share here. Copied to clipboard.");
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          alert("No native Share here. Copied to clipboard.");
        }
      } else {
        if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
      }

      persistCompletedDay(endTs, text);
      finalizeAndReset();
      history.replaceState(null, "", location.pathname);
    } catch (_) {
      alert("Action failed. Day was not ended.");
    }
  }

  copyBtn.addEventListener("click", () => doCopyOrShare("copy"));
  shareBtn.addEventListener("click", () => doCopyOrShare("share"));

  endBtn.addEventListener("click", () => {
    const confirmMsg = t("endConfirm");
    if (!confirm(confirmMsg)) return;

    const endTs = Date.now();
    const text = reportBox.textContent || "";
    persistCompletedDay(endTs, text);

    finalizeAndReset();
    history.replaceState(null, "", location.pathname);
  });

  function normalizeHistoryRatings() {
    const hist = loadHistory();
    let changed = false;
    Object.keys(hist).forEach((iso) => {
      const rec = hist[iso];
      if (!rec || !rec.values) return;
      if (rec.dayRating && rec.dayBadge !== undefined) return;
      const info = classifyDay(rec.values);
      rec.dayRating = info.dayRating;
      rec.dayBadge = info.dayBadge;
      changed = true;
    });
    if (changed) saveHistory(hist);
  }

  langToggleBtn.addEventListener("click", () => openModal(modalLanguage));
  document.getElementById("lang_x").addEventListener("click", () => closeModal(modalLanguage));
  langEsBtn.addEventListener("click", () => setLanguage("es"));
  langEnBtn.addEventListener("click", () => setLanguage("en"));
  clickOutsideToClose(modalLanguage, true);

  // ---------- Init ----------
  (function init() {
    applyTranslations();
    normalizeHistoryRatings();

    // If opened from QR (phone), open report
    tryLoadReportFromHash();

    if (state.active && state.sessionStart && state.rep && state.store) {
      showSessionScreen();
      startTimerLoop();
    } else {
      showStartScreen();
    }

    renderCalendar();
    renderSummary();
    saveState();
  })();
</script>
</body>
</html>
