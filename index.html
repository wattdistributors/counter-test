<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>KPIs Counter</title>

  <style>
    :root { --bg1:#1b86c8; --bg2:#0b5a86; }

    html, body { touch-action: manipulation; }
    body{
      margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color:#fff;
    }

    .wrap{ width:min(520px, 94vw); padding:22px 14px 26px; }

    .card{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      padding: 14px;
      backdrop-filter: blur(6px);
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:10px;
    }

    .title{ font-weight:900; letter-spacing:.02em; font-size:18px; line-height:1.1; }
    .subtitle{ opacity:.9; font-size:13px; margin-top:4px; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      border:1px solid rgba(255,255,255,.40);
      background:rgba(255,255,255,.12);
      color:#fff; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:14px; font-weight:800;
      user-select:none; touch-action: manipulation;
    }
    .btn:active{ transform: scale(.98); }

    .btn.primary{
      background: rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.55);
    }

    /* ---------- Tabs ---------- */
    .tabs{
      display:flex;
      gap:8px;
      margin: 0 0 12px;
      padding: 6px;
      border-radius: 16px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.16);
    }
    .tab{
      flex:1;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .tab.active{
      background: rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.50);
      box-shadow: 0 10px 25px rgba(0,0,0,.14);
    }

    .center{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
      padding:18px 6px 8px;
      text-align:center;
    }

    .sessionInfo{
      width:100%;
      box-sizing: border-box;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      margin: 8px 0 4px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      overflow:hidden;
    }

    .sessionInfo .left{
      flex: 1 1 auto;
      min-width:0;
    }
    .sessionInfo .left .line1{
      font-weight:900; letter-spacing:.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sessionInfo .left .line2{
      opacity:.9; font-size:12px; margin-top:3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .timerBox{
      flex: 0 0 120px;
      text-align:center;
    }
    .timerBox .t1{ font-size:12px; opacity:.9; }
    .timerBox .t2{ font-size:18px; font-weight:900; letter-spacing:.02em; margin-top:3px; }

    .metrics{ margin-top:10px; }
    .row{ text-align:center; margin:16px 0; }
    .label{ font-weight:900; letter-spacing:.10em; margin-bottom:8px; font-size:20px; }

    .pill{
      margin:0 auto;
      width:310px; height:56px;
      background:#fff; border-radius:999px;
      display:flex; overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      color:#111;
      touch-action: manipulation;
    }
    .pill button, .pill .val{
      flex:1; display:flex; align-items:center; justify-content:center;
      border:0; background:transparent; font-size:26px; cursor:pointer;
      touch-action: manipulation;
    }
    .pill .val{ flex:1.2; font-weight:900; font-size:24px; user-select:none; }
    .sep{ width:2px; background:#111; opacity:.8; }
    .pill button:active{ transform: scale(.97); }

    .indicators{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
      margin-top:12px;
    }
    .ind{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.20);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .ind .k{ font-size:12px; opacity:.9; margin-bottom:6px; }
    .ind .v{ font-size:18px; font-weight:900; letter-spacing:.02em; }

    /* ---------- Weekly summary ---------- */
    .weeklyHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin: 6px 0 10px;
    }
    .weeklyHeader .h1{
      font-weight:900;
      letter-spacing:.02em;
      font-size:16px;
      line-height:1.15;
    }
    .weeklyHeader .h2{
      opacity:.9;
      font-size:12px;
      margin-top:4px;
    }

    .weeklyTotals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .mini{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .mini .k{ font-size:12px; opacity:.9; margin-bottom:6px; }
    .mini .v{ font-size:18px; font-weight:900; letter-spacing:.02em; }

    .weekList{
      margin-top:12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }
    .weekRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .weekRow:first-child{ border-top:0; }
    .weekRow .left{
      min-width:0;
      flex: 1 1 auto;
    }
    .weekRow .d1{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .weekRow .d2{
      opacity:.9;
      font-size:12px;
      margin-top:3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .weekRow .right{
      flex:0 0 auto;
      text-align:right;
      font-size:12px;
      opacity:.95;
      white-space:nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .empty{
      margin-top:10px;
      padding: 14px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px dashed rgba(255,255,255,.18);
      text-align:center;
      opacity:.9;
      font-size:13px;
    }

    .footer{
      margin-top:10px;
      text-align:center;
      font-size:10px;
      opacity:.70;
      letter-spacing:.03em;
    }

    /* ---------- Modal ---------- */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(560px, 96vw);
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.20);
      border-radius: 18px;
      backdrop-filter: blur(8px);
      box-shadow: 0 18px 55px rgba(0,0,0,.30);
      padding: 14px;
      position:relative;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom: 10px;
    }
    .modalTitle{
      font-weight:900; font-size:16px;
      letter-spacing:.02em;
    }
    .xbtn{
      border:1px solid rgba(255,255,255,.30);
      background: rgba(255,255,255,.10);
      color:#fff;
      width:34px; height:34px;
      border-radius: 12px;
      cursor:pointer;
      font-size:16px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .xbtn:active{ transform: scale(.98); }

    .modalBody{ margin-top: 6px; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .field label{ display:block; font-size:12px; opacity:.9; margin:0 0 6px 2px; }
    .field input{
      width:100%; box-sizing:border-box;
      border-radius:12px; border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.10);
      color:#fff; padding:10px 12px; font-size:14px;
      outline:none; touch-action: manipulation;
    }
    .field input::placeholder{ color: rgba(255,255,255,.75); }

    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .reportBox{
      width:100%;
      box-sizing:border-box;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      padding: 10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ✅ Elegant QR */
    .qrWrap{
      margin-top:12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      padding: 12px;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .qrTitle{
      font-weight:900;
      letter-spacing:.02em;
      font-size:13px;
      opacity:.95;
      text-align:center;
    }
    .qrCard{
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #qr_box{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #qr_box img, #qr_box canvas{
      display:block;
      border-radius: 10px;
    }
    .qrHint{
      opacity:.85;
      font-size:12px;
      text-align:center;
      line-height:1.25;
    }

    @media (max-width: 420px){
      .pill{ width: 290px; }
      .grid2{ grid-template-columns: 1fr; }
      .timerBox{ flex-basis: 112px; }
      .miniGrid{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="topbar">
        <div>
          <div class="title" id="today_title">KPIs Counter</div>
          <div class="subtitle" id="today_date"></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" id="tab_today" type="button">Today</button>
        <button class="tab" id="tab_weekly" type="button">Weekly</button>
      </div>

      <!-- TODAY TAB -->
      <div id="panel_today">

        <!-- Start screen -->
        <div id="start_screen" class="center">
          <div style="opacity:.9; font-size:13px; max-width: 360px;">
            Tap <b>Start day</b> to enter your name and store.
          </div>
          <button class="btn primary" id="start_day">Start day</button>
        </div>

        <!-- Active session screen -->
        <div id="session_screen" style="display:none;">
          <div class="sessionInfo">
            <div class="left">
              <div class="line1" id="who_line">—</div>
              <div class="line2" id="date_line">—</div>
            </div>
            <div class="timerBox">
              <div class="t1">Session</div>
              <div class="t2" id="timer">00:00:00</div>
            </div>
          </div>

          <div class="metrics" id="list"></div>

          <div class="indicators">
            <div class="ind">
              <div class="k">% Aggressiveness (Z/S)</div>
              <div class="v" id="aggr">—</div>
            </div>
            <div class="ind">
              <div class="k">% Close (X/Z)</div>
              <div class="v" id="close">0.0%</div>
            </div>
          </div>

          <div class="btnrow" style="margin-top:12px; justify-content:center;">
            <button class="btn primary" id="finish_day">End day</button>
          </div>
        </div>

      </div>

      <!-- WEEKLY TAB -->
      <div id="panel_weekly" style="display:none;">

        <div class="weeklyHeader">
          <div>
            <div class="h1">Weekly summary</div>
            <div class="h2" id="week_range">—</div>
          </div>
          <div class="btnrow" style="justify-content:flex-end;">
            <button class="btn" id="week_refresh" type="button">Refresh</button>
          </div>
        </div>

        <!-- Totals cards -->
        <div class="weeklyTotals">
          <div class="ind">
            <div class="k">% Aggressiveness (Z/S)</div>
            <div class="v" id="w_aggr">—</div>
          </div>
          <div class="ind">
            <div class="k">% Close (X/Z)</div>
            <div class="v" id="w_close">—</div>
          </div>
        </div>

        <div class="miniGrid">
          <div class="mini"><div class="k">S total</div><div class="v" id="w_S">0</div></div>
          <div class="mini"><div class="k">Z total</div><div class="v" id="w_Z">0</div></div>
          <div class="mini"><div class="k">X total</div><div class="v" id="w_X">0</div></div>
          <div class="mini"><div class="k">CC total</div><div class="v" id="w_CC">0</div></div>
          <div class="mini"><div class="k">C total</div><div class="v" id="w_C">0</div></div>
          <div class="mini"><div class="k">Days</div><div class="v" id="w_days">0</div></div>
        </div>

        <div id="week_empty" class="empty" style="display:none;">
          No completed days saved yet for this week.<br/>
          Finish a day (Copy/Share) to see it here.
        </div>

        <div id="week_list" class="weekList" style="display:none;"></div>

      </div>

      <div class="footer">KPIs Counter v5.0 — Designed by Alen Cordero</div>
    </div>
  </div>

  <!-- Modal: Start day -->
  <div class="overlay" id="modal_start">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Start day">
      <div class="modalHeader">
        <div class="modalTitle">Start day</div>
        <button class="xbtn" id="start_x" aria-label="Close">×</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.9; font-size:13px;">
          Enter your info to start.
        </div>
        <div class="grid2">
          <div class="field">
            <label>Name</label>
            <input id="start_name" placeholder="e.g., Alen" autocomplete="name" />
          </div>
          <div class="field">
            <label>Store</label>
            <input id="start_store" placeholder="e.g., El Rancho — Irving" />
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="start_cancel">Cancel</button>
          <button class="btn primary" id="start_confirm">Start</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Day summary -->
  <div class="overlay" id="modal_report">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Day summary">
      <div class="modalHeader">
        <div class="modalTitle">Day summary</div>
        <button class="xbtn" id="report_x" aria-label="Back">×</button>
      </div>
      <div class="modalBody">

        <!-- QR -->
        <div id="qr_wrap" class="qrWrap" style="display:none;">
          <div class="qrTitle">Open this report on your phone</div>
          <div class="qrCard">
            <div id="qr_box"></div>
          </div>
          <div class="qrHint">Scan with your phone camera • Then Copy/Share</div>
        </div>

        <div class="reportBox" id="report_box">—</div>

        <div class="modalActions">
          <button class="btn" id="copy_btn">Copy</button>
          <button class="btn primary" id="share_btn">Share</button>
        </div>
        <div style="margin-top:10px; opacity:.8; font-size:12px;">
          Copy or share ends the day and resets.
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

<script>
  const metrics = ["S","Z","CC","C","X"];
  const STATE_KEY = "kpi_state_v50";
  const HISTORY_KEY = "kpi_history_v50"; // ✅ weekly summary source
  const AGGR_MIN_STOPS = 20;

  const fmtPct = (n) => (Number.isFinite(n) ? (n * 100).toFixed(1) + "%" : "0.0%");
  const pad2 = (n) => String(n).padStart(2,"0");

  const isoDateLocal = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const fmtTime = (ts) => {
    if (!ts) return "—";
    const d = new Date(ts);
    let h = d.getHours();
    const m = d.getMinutes();
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${pad2(m)} ${ampm}`;
  };

  const fmtDuration = (ms) => {
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  };

  // Nice date for week range (e.g., Feb 2, 2026)
  const fmtNiceDate = (yyyyMmDd) => {
    const [y,m,d] = yyyyMmDd.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString(undefined, { month:"short", day:"numeric", year:"numeric" });
  };

  // Monday-start week (Mon..Sun)
  function weekBoundsISO(dateObj = new Date()) {
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    const day = d.getDay(); // 0 Sun .. 6 Sat
    const diffToMon = (day === 0) ? -6 : (1 - day);
    const start = new Date(d);
    start.setDate(d.getDate() + diffToMon);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);

    const toIso = (x) => {
      const yyyy = x.getFullYear();
      const mm = String(x.getMonth()+1).padStart(2,"0");
      const dd = String(x.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };

    return { startStr: toIso(start), endStr: toIso(end) };
  }

  document.addEventListener("dblclick", (e) => e.preventDefault(), { passive:false });

  // ---------- Load state ----------
  const saved = JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
  const state = {
    active: !!saved.active,
    date: saved.date || isoDateLocal(),
    rep: saved.rep || "",
    store: saved.store || "",
    values: saved.values || {},
    sessionStart: saved.sessionStart || null,
  };
  metrics.forEach(k => { if (typeof state.values[k] !== "number") state.values[k] = 0; });

  // ---------- Load history ----------
  function loadHistory() {
    try {
      const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }
  function saveHistory(arr) {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
  }

  // ---------- DOM ----------
  const todayDateEl = document.getElementById("today_date");

  // Tabs / panels
  const tabToday = document.getElementById("tab_today");
  const tabWeekly = document.getElementById("tab_weekly");
  const panelToday = document.getElementById("panel_today");
  const panelWeekly = document.getElementById("panel_weekly");

  const startScreen = document.getElementById("start_screen");
  const sessionScreen = document.getElementById("session_screen");
  const list = document.getElementById("list");
  const whoLine = document.getElementById("who_line");
  const dateLine = document.getElementById("date_line");
  const timerEl = document.getElementById("timer");
  const aggrEl = document.getElementById("aggr");
  const closeEl = document.getElementById("close");

  // Weekly DOM
  const weekRangeEl = document.getElementById("week_range");
  const wAggrEl = document.getElementById("w_aggr");
  const wCloseEl = document.getElementById("w_close");
  const wS = document.getElementById("w_S");
  const wZ = document.getElementById("w_Z");
  const wX = document.getElementById("w_X");
  const wCC = document.getElementById("w_CC");
  const wC = document.getElementById("w_C");
  const wDays = document.getElementById("w_days");
  const weekEmpty = document.getElementById("week_empty");
  const weekList = document.getElementById("week_list");

  // Modals
  const modalStart = document.getElementById("modal_start");
  const modalReport = document.getElementById("modal_report");
  const startName = document.getElementById("start_name");
  const startStore = document.getElementById("start_store");
  const reportBox = document.getElementById("report_box");

  // QR
  const qrWrap = document.getElementById("qr_wrap");
  const qrBox = document.getElementById("qr_box");

  // ---------- Save state ----------
  function saveStateNow() { localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
  function saveState() { try { saveStateNow(); } catch {} }

  window.addEventListener("pagehide", () => { try { saveStateNow(); } catch {} });
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") { try { saveStateNow(); } catch {} }
  });

  // ---------- UI ----------
  const valEls = {};
  function renderHeader() {
    todayDateEl.textContent = `Date: ${isoDateLocal()}`;
  }

  function renderSessionInfo() {
    whoLine.textContent = `${state.rep || "—"} • ${state.store || "—"}`;
    dateLine.textContent = `Day: ${state.date} • Start: ${fmtTime(state.sessionStart)}`;
  }

  function renderMetrics() {
    list.innerHTML = "";
    metrics.forEach(k => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="label">${k}</div>
        <div class="pill">
          <button aria-label="minus ${k}" data-k="${k}" data-d="-1">−</button>
          <div class="sep"></div>
          <div class="val" id="v_${k}">${state.values[k]}</div>
          <div class="sep"></div>
          <button aria-label="plus ${k}" data-k="${k}" data-d="1">+</button>
        </div>
      `;
      list.appendChild(row);
    });
    metrics.forEach(k => { valEls[k] = document.getElementById("v_" + k); });
  }

  function renderIndicators() {
    const S = state.values.S;
    const Z = state.values.Z;
    const X = state.values.X;

    if (S >= AGGR_MIN_STOPS) aggrEl.textContent = fmtPct(S > 0 ? (Z / S) : 0);
    else aggrEl.textContent = `— (min ${AGGR_MIN_STOPS} S)`;

    closeEl.textContent = fmtPct(Z > 0 ? (X / Z) : 0);
  }

  function showStartScreen() {
    state.active = false;
    startScreen.style.display = "";
    sessionScreen.style.display = "none";
    renderHeader();
  }

  function showSessionScreen() {
    startScreen.style.display = "none";
    sessionScreen.style.display = "";
    renderHeader();
    renderSessionInfo();
    renderMetrics();
    renderIndicators();
  }

  // ---------- Tabs ----------
  function setTab(which) {
    const isToday = which === "today";
    tabToday.classList.toggle("active", isToday);
    tabWeekly.classList.toggle("active", !isToday);
    panelToday.style.display = isToday ? "" : "none";
    panelWeekly.style.display = isToday ? "none" : "";

    if (!isToday) renderWeekly(); // refresh when opening weekly
  }

  tabToday.addEventListener("click", () => setTab("today"));
  tabWeekly.addEventListener("click", () => setTab("weekly"));

  // ---------- Timer ----------
  let timerInterval = null;
  function startTimerLoop() {
    stopTimerLoop();
    timerInterval = setInterval(() => {
      if (!state.active || !state.sessionStart) return;
      timerEl.textContent = fmtDuration(Date.now() - state.sessionStart);
    }, 1000);

    if (state.active && state.sessionStart) timerEl.textContent = fmtDuration(Date.now() - state.sessionStart);
    else timerEl.textContent = "00:00:00";
  }
  function stopTimerLoop() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
  }

  // ---------- Modals helpers ----------
  function openModal(el) { el.classList.add("show"); }
  function closeModal(el) { el.classList.remove("show"); }

  function clickOutsideToClose(overlayEl, allow) {
    overlayEl.addEventListener("click", (e) => {
      if (!allow) return;
      if (e.target === overlayEl) closeModal(overlayEl);
    });
  }
  clickOutsideToClose(modalStart, true);
  clickOutsideToClose(modalReport, false);

  // ---------- Session logic ----------
  function startDay(rep, store) {
    state.date = isoDateLocal();
    state.rep = rep;
    state.store = store;
    metrics.forEach(k => state.values[k] = 0);
    state.sessionStart = Date.now();
    state.active = true;
    saveStateNow();
    showSessionScreen();
    startTimerLoop();
  }

  // English-only report
  function buildReport(endTs) {
    const S = state.values.S, Z = state.values.Z, CC = state.values.CC, C = state.values.C, X = state.values.X;

    const aggr = (S >= AGGR_MIN_STOPS && S > 0) ? (Z / S) : null;
    const close = (Z > 0) ? (X / Z) : 0;

    const startTs = state.sessionStart || endTs;
    const duration = fmtDuration(endTs - startTs);

    const aggrLine = (aggr !== null)
      ? `% Aggressiveness (Z/S): ${fmtPct(aggr)}`
      : `% Aggressiveness (Z/S): — (min ${AGGR_MIN_STOPS} S)`;

    return [
      `Name: ${state.rep || "-"}`,
      `Store: ${state.store || "-"}`,
      `Date: ${state.date}`,
      ``,
      `Start: ${fmtTime(startTs)}`,
      `End: ${fmtTime(endTs)}`,
      `Duration: ${duration}`,
      ``,
      `S: ${S} | Z: ${Z} | CC: ${CC} | C: ${C} | X: ${X}`,
      aggrLine,
      `% Close (X/Z): ${fmtPct(close)}`
    ].join("\n");
  }

  function finalizeAndReset() {
    state.active = false;
    state.rep = "";
    state.store = "";
    state.sessionStart = null;
    state.date = isoDateLocal();
    metrics.forEach(k => state.values[k] = 0);
    saveStateNow();
    stopTimerLoop();
    timerEl.textContent = "00:00:00";
    closeModal(modalReport);
    showStartScreen();
  }

  // ---------- QR ----------
  function makeShareUrlFromReport(text) {
    const payload = LZString.compressToEncodedURIComponent(text);
    return `${location.origin}${location.pathname}#r=${payload}`;
  }

  function showQRForText(text) {
    qrBox.innerHTML = "";
    qrWrap.style.display = "";

    const url = makeShareUrlFromReport(text);

    // Less dense QR: low correction + elegant card
    new QRCode(qrBox, {
      text: url,
      width: 176,
      height: 176,
      correctLevel: QRCode.CorrectLevel.L
    });
  }

  function tryLoadReportFromHash() {
    const h = location.hash || "";
    if (!h.startsWith("#r=")) return false;

    try {
      const payload = h.slice(3);
      const text = LZString.decompressFromEncodedURIComponent(payload);
      if (!text) return false;

      reportBox.textContent = text;
      qrWrap.style.display = "none";
      openModal(modalReport);
      return true;
    } catch {
      return false;
    }
  }

  // ---------- Weekly summary ----------
  function renderWeekly() {
    const { startStr, endStr } = weekBoundsISO(new Date());
    weekRangeEl.textContent = `${fmtNiceDate(startStr)} → ${fmtNiceDate(endStr)}`;

    const history = loadHistory();

    // Filter current week
    const weekItems = history
      .filter(it => it && typeof it.date === "string" && it.date >= startStr && it.date <= endStr)
      .sort((a,b) => (a.date > b.date ? -1 : 1)); // newest first

    let totals = { S:0, Z:0, CC:0, C:0, X:0 };
    for (const it of weekItems) {
      const v = it.values || {};
      totals.S += Number(v.S||0);
      totals.Z += Number(v.Z||0);
      totals.CC += Number(v.CC||0);
      totals.C += Number(v.C||0);
      totals.X += Number(v.X||0);
    }

    wS.textContent = String(totals.S);
    wZ.textContent = String(totals.Z);
    wX.textContent = String(totals.X);
    wCC.textContent = String(totals.CC);
    wC.textContent = String(totals.C);
    wDays.textContent = String(weekItems.length);

    const aggr = (totals.S >= AGGR_MIN_STOPS && totals.S > 0) ? (totals.Z / totals.S) : null;
    const close = (totals.Z > 0) ? (totals.X / totals.Z) : 0;

    wAggrEl.textContent = (aggr !== null) ? fmtPct(aggr) : `— (min ${AGGR_MIN_STOPS} S)`;
    wCloseEl.textContent = fmtPct(close);

    // List
    if (!weekItems.length) {
      weekEmpty.style.display = "";
      weekList.style.display = "none";
      weekList.innerHTML = "";
      return;
    }

    weekEmpty.style.display = "none";
    weekList.style.display = "";
    weekList.innerHTML = "";

    for (const it of weekItems) {
      const name = it.rep || "-";
      const store = it.store || "-";
      const v = it.values || {};
      const line = `S:${v.S||0} Z:${v.Z||0} CC:${v.CC||0} C:${v.C||0} X:${v.X||0}`;

      const row = document.createElement("div");
      row.className = "weekRow";
      row.innerHTML = `
        <div class="left">
          <div class="d1">${it.date} • ${name}</div>
          <div class="d2">${store}</div>
        </div>
        <div class="right">${line}</div>
      `;
      weekList.appendChild(row);
    }
  }

  document.getElementById("week_refresh").addEventListener("click", renderWeekly);

  // ---------- Metrics interactions (tap and hold repeat) ----------
  function bump(k, d) {
    const prev = state.values[k];
    const next = Math.max(0, prev + d);
    if (next === prev) return;
    state.values[k] = next;
    valEls[k].textContent = next;
    renderIndicators();
    saveState();
  }

  let holdTimer = null;
  let holdInterval = null;
  function startHold(k, d) {
    bump(k, d);
    holdTimer = setTimeout(() => {
      holdInterval = setInterval(() => bump(k, d), 90);
    }, 250);
  }
  function stopHold() {
    clearTimeout(holdTimer); holdTimer = null;
    clearInterval(holdInterval); holdInterval = null;
  }

  document.addEventListener("pointerdown", (e) => {
    if (!state.active) return;
    const b = e.target.closest("button[data-k]");
    if (!b) return;
    e.preventDefault();
    startHold(b.dataset.k, Number(b.dataset.d));
  }, { passive:false });

  document.addEventListener("pointerup", stopHold);
  document.addEventListener("pointercancel", stopHold);
  document.addEventListener("pointerleave", stopHold);
  window.addEventListener("blur", stopHold);
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") stopHold();
  });

  // ---------- Buttons ----------
  document.getElementById("start_day").addEventListener("click", () => {
    startName.value = state.rep || "";
    startStore.value = state.store || "";
    openModal(modalStart);
    setTimeout(() => startName.focus(), 50);
  });

  document.getElementById("start_x").addEventListener("click", () => closeModal(modalStart));
  document.getElementById("start_cancel").addEventListener("click", () => closeModal(modalStart));

  document.getElementById("start_confirm").addEventListener("click", () => {
    const rep = (startName.value || "").trim();
    const store = (startStore.value || "").trim();
    if (!rep || !store) {
      alert("Please enter Name and Store.");
      return;
    }
    closeModal(modalStart);
    startDay(rep, store);
  });

  [startName, startStore].forEach((inp) => {
    inp.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      if (inp === startName) startStore.focus();
      else document.getElementById("start_confirm").click();
    });
  });

  document.getElementById("finish_day").addEventListener("click", () => {
    const endTs = Date.now();
    const text = buildReport(endTs);
    reportBox.textContent = text;

    // Tablet: show QR
    showQRForText(text);

    openModal(modalReport);
  });

  document.getElementById("report_x").addEventListener("click", () => closeModal(modalReport));

  async function doCopyOrShare(kind) {
    if (!confirm(`Are you sure you want to ${kind === "copy" ? "COPY" : "SHARE"}?\nThis ends the day and resets.`)) return;

    const endTs = Date.now();
    const text = reportBox.textContent || "";

    // ✅ Save to weekly history ONLY if it was a real active session on this device.
    // If opened from QR on phone (#r=...), we DON'T duplicate-save.
    const openedFromQR = (location.hash || "").startsWith("#r=");
    const canSaveDay = (!openedFromQR && state.sessionStart && state.rep && state.store);

    try {
      if (kind === "share") {
        if (navigator.share) {
          await navigator.share({ title: "KPI Report", text });
        } else if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          alert("No native Share here. Copied to clipboard.");
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          alert("No native Share here. Copied to clipboard.");
        }
      } else {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
      }

      if (canSaveDay) {
        const history = loadHistory();

        // Prevent duplicates for same date+rep+store (optional safety)
        const sig = `${state.date}|${state.rep}|${state.store}`;
        const filtered = history.filter(h => `${h.date}|${h.rep}|${h.store}` !== sig);

        filtered.push({
          date: state.date,
          rep: state.rep,
          store: state.store,
          values: { ...state.values },
          startTs: state.sessionStart,
          endTs: endTs
        });

        saveHistory(filtered);
      }

      finalizeAndReset();

      // Clear hash so reload doesn't reopen modal
      history.replaceState(null, "", location.pathname);

      // If user is on weekly tab, refresh it
      renderWeekly();

    } catch (_) {
      alert("Action failed. Day was not ended.");
    }
  }

  document.getElementById("copy_btn").addEventListener("click", () => doCopyOrShare("copy"));
  document.getElementById("share_btn").addEventListener("click", () => doCopyOrShare("share"));

  // ---------- Init ----------
  (function init() {
    renderHeader();

    // If opened from QR (phone), open report
    tryLoadReportFromHash();

    if (state.active && state.sessionStart && state.rep && state.store) {
      showSessionScreen();
      startTimerLoop();
    } else {
      showStartScreen();
    }

    // Default tab: Today
    setTab("today");

    saveState();
  })();
</script>
</body>
</html>
