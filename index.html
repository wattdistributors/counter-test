<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>RetailFlow Tracker</title>

  <style>
    :root{
      --bg1:#145c8c;
      --bg2:#0e466b;

      /* Calendar (blue / celeste + transparency) */
      --calPanel: rgba(20, 92, 145, .24);
      --calPanel2: rgba(10, 62, 104, .22);
      --calLine: rgba(142, 211, 245, .28);
      --calLine2: rgba(187, 232, 255, .54);
      --calInk: rgba(236,248,255,.97);
      --calMuted: rgba(193,224,241,.84);
      --calChip: rgba(91, 169, 216, .18);
      --calChipLine: rgba(173, 224, 250, .30);
      --calShadow: 0 18px 55px rgba(0,0,0,.22);
      --radiusLg: 20px;
      --radiusMd: 14px;
      --surfaceBorder: rgba(255,255,255,.14);
      --surfaceBg: rgba(255,255,255,.12);
      --shadowSoft: 0 10px 24px rgba(4,28,46,.20);
    }

    /* Global no-overscroll fix (iOS mini-scroll / top-gap prevention) */
    *{ box-sizing:border-box; }

    html, body {
      min-height:100%;
      margin:0;
      overflow-x:hidden;
      touch-action:manipulation;
      background: linear-gradient(150deg, var(--bg1), var(--bg2));
    }

    body{
      display:block;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(130% 120% at 15% 0%, rgba(150,210,242,.24), transparent 62%), linear-gradient(150deg, var(--bg1), var(--bg2));
      color:#fff;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior-y:auto;
      padding-top:env(safe-area-inset-top, 0px);
      padding-bottom:env(safe-area-inset-bottom, 0px);
    }

    /* Global reusable shell: same width for Counter / Calendar / Progress */
    .app-shell {
      width: min(96vw, 980px);
      margin: 0 auto;
      padding: 16px 18px 28px;
      box-sizing: border-box;
    }

    .card{
      background: var(--surfaceBg);
      border: 1px solid var(--surfaceBorder);
      border-radius: var(--radiusLg);
      padding: clamp(12px, 1.4vw, 16px);
      backdrop-filter: blur(12px) saturate(130%);
      -webkit-backdrop-filter: blur(12px) saturate(130%);
      box-shadow: var(--shadowSoft);
      display:flex;
      flex-direction:column;
      width:100%;
      min-height:calc(100dvh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 44px);
      overflow:visible;
      transition: box-shadow .2s ease, border-color .2s ease;
    }

    .appHeader{
      position:sticky;
      top:0;
      z-index:5;
      background: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      padding: 6px 0 4px;
      flex:0 0 auto;
    }

    .appMain{
      flex:1 1 auto;
      min-height:0;
      padding-right:0;
      display:flex;
      flex-direction:column;
      overflow:visible;
    }

    .topbar{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:10px;
      padding:8px 2px 10px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }

    .topbarRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .topbarRowMain{
      flex-wrap:nowrap;
    }

    .topbarRowSub{
      flex-wrap:wrap;
      row-gap:8px;
    }

    .topbarTitle{
      font-weight:800;
      letter-spacing:.015em;
      font-size:22px;
      line-height:1.08;
      color:rgba(246,252,255,.98);
    }

    .topbarDate{
      opacity:.78;
      font-size:13px;
      line-height:1.2;
      color:rgba(220,244,255,.92);
    }

    .topbarActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }

    .topbarLangBtn{
      min-width:56px;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.06em;
      text-align:center;
    }

    .btn{
      min-height:44px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff; padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:14px; font-weight:700;
      user-select:none; touch-action: manipulation;
      transition: background .18s ease, border-color .18s ease, transform .18s ease, box-shadow .18s ease;
    }
    .btn:hover{ background:rgba(255,255,255,.16); border-color:rgba(255,255,255,.26); }
    .btn:focus-visible{ outline:2px solid rgba(187,232,255,.75); outline-offset:2px; }
    .btn:active{ transform: translateY(1px) scale(.985); }

    .btn.primary{
      background: rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.55);
    }

    .helpBtn{
      width:38px;
      min-width:38px;
      padding:0;
      border-radius:999px;
      font-weight:900;
      font-size:16px;
    }

    .langBtn{
      min-width:72px;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:.04em;
    }
    .langChoiceActive{
      background: rgba(255,255,255,.22) !important;
      border-color: rgba(255,255,255,.55) !important;
    }

    .profileBtn{
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      padding:8px 12px;
      max-width:180px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }



    #authRoot{
      min-height:100dvh;
      width:100%;
      display:none;
      align-items:center;
      justify-content:center;
      padding:calc(16px + env(safe-area-inset-top, 0px)) 18px calc(16px + env(safe-area-inset-bottom, 0px));
      box-sizing:border-box;
    }


    .authBackdropOrb{
      position:fixed;
      z-index:0;
      pointer-events:none;
      border-radius:999px;
      filter:blur(2px);
      opacity:.35;
    }

    .authBackdropOrb.one{
      width:210px;
      height:210px;
      background:radial-gradient(circle at 30% 30%, rgba(179,226,255,.42), rgba(120,182,221,.06));
      top:8vh;
      left:max(2vw, 8px);
    }

    .authBackdropOrb.two{
      width:180px;
      height:180px;
      background:radial-gradient(circle at 65% 30%, rgba(175,227,255,.28), rgba(107,167,212,.04));
      right:max(4vw, 12px);
      bottom:10vh;
    }

    #appRoot{
      opacity:1;
    }

    .authShell{
      width:min(420px, 100%);
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      position:relative;
      z-index:1;
    }

    .authBrand{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      color:rgba(242,252,255,.97);
    }

    .authBrandTitle{
      margin:0;
      font-size:34px;
      font-weight:800;
      letter-spacing:.01em;
      line-height:1.06;
    }

    .authBrandSubtitle{
      margin:0;
      font-size:13px;
      color:rgba(224,244,255,.82);
      font-weight:500;
      letter-spacing:.02em;
    }

    .authCard{
      width:100%;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 20px;
      padding: 20px 18px;
      backdrop-filter: blur(12px) saturate(130%);
      -webkit-backdrop-filter: blur(12px) saturate(130%);
      box-shadow: 0 10px 24px rgba(4,28,46,.20);
      display:flex;
      flex-direction:column;
      gap:14px;
      transition: transform .22s ease, box-shadow .22s ease;
    }

    .authCard.loading{
      animation: authCardPulse .7s ease-in-out infinite alternate;
    }

    .authCard.shake{
      animation: authShake .24s ease;
    }

    .authTitle{
      margin:0;
      font-size:24px;
      font-weight:700;
      letter-spacing:.01em;
      text-align:center;
      color:rgba(244,252,255,.98);
    }

    .authCardIntro{
      margin:-6px 0 2px;
      text-align:center;
      font-size:12px;
      color:rgba(228,246,255,.78);
      letter-spacing:.02em;
    }

    .authInput{
      width:100%;
      box-sizing:border-box;
      border:1px solid rgba(255,255,255,.24);
      background:rgba(255,255,255,.10);
      color:#fff;
      border-radius:12px;
      min-height:48px;
      padding:12px 14px;
      font-size:15px;
      line-height:1.2;
      outline:none;
    }

    .authInput::placeholder{ color:rgba(233,247,255,.82); }

    .authActions{
      width:100%;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .authSecondaryBtn{
      min-height:52px;
      border-radius:14px;
      font-size:16px;
      font-weight:700;
    }

    .authTopRow{
      width:100%;
      display:flex;
      justify-content:flex-end;
      margin-bottom:2px;
    }

    .authTopLangBtn{
      min-width:94px;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:700;
    }

    .authLoginBtn{
      width:100%;
      min-height:52px;
      padding:12px 14px;
      border-radius:14px;
      font-size:18px;
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    .authLoginBtn:disabled{
      cursor:not-allowed;
      opacity:.84;
    }

    .authSpinner{
      width:16px;
      height:16px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:rgba(255,255,255,.95);
      animation: authSpin .72s linear infinite;
      display:none;
      flex:0 0 auto;
    }

    .authLoginBtn.loading .authSpinner{
      display:inline-block;
    }

    .authMsg{
      min-height:20px;
      font-size:13px;
      color:rgba(231,248,255,.9);
      text-align:left;
      padding:0 2px;
    }

    .authMsg.error{
      color:rgba(255, 190, 190, .95);
    }

    .authSecureText{
      text-align:center;
      font-size:12px;
      color:rgba(228,246,255,.72);
      margin-top:2px;
      letter-spacing:.01em;
    }

    .authVersion{
      text-align:center;
      font-size:11px;
      color:rgba(227,245,255,.46);
      letter-spacing:.04em;
      margin-top:2px;
    }

    .authSignupOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(5,24,40,.42);
      z-index:30;
      padding:18px;
      box-sizing:border-box;
    }

    .authSignupOverlay.show{ display:flex; }

    .authSignupModal{
      width:min(420px, 100%);
      background: rgba(255,255,255,.13);
      border:1px solid rgba(255,255,255,.2);
      border-radius:18px;
      padding:16px;
      backdrop-filter: blur(12px) saturate(130%);
      -webkit-backdrop-filter: blur(12px) saturate(130%);
      box-shadow:0 10px 24px rgba(4,28,46,.24);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .authSignupTitle{
      margin:0;
      text-align:center;
      font-size:20px;
      font-weight:700;
    }

    .authSignupMsg{
      min-height:18px;
      font-size:12px;
      color:rgba(231,248,255,.9);
    }

    .authSignupMsg.error{ color:rgba(255,190,190,.95); }

    .authSignupActions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }

    @keyframes authSpin{
      to{ transform:rotate(360deg); }
    }

    @keyframes authCardPulse{
      from{ transform:scale(.995); box-shadow:0 10px 24px rgba(4,28,46,.20); }
      to{ transform:scale(1); box-shadow:0 14px 30px rgba(9,50,84,.26); }
    }

    @keyframes authShake{
      0%,100%{ transform:translateX(0); }
      30%{ transform:translateX(-2px); }
      70%{ transform:translateX(2px); }
    }

    .userMeta{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
    }

    #userEmail{
      font-size:12px;
      opacity:.88;
      max-width:180px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .logoutBtn{
      min-height:36px;
      font-size:11px;
      font-weight:650;
      border-radius:999px;
      padding:6px 10px;
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.14);
      color:rgba(234,247,255,.92);
    }

    .sessionActions{
      margin-top:12px;
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
    }
    .startHeroTitle{
      font-size:34px;
      line-height:1.05;
      font-weight:1000;
      letter-spacing:.01em;
    }
    .startHeroSub{
      font-size:15px;
      opacity:.86;
    }
    .startMainBtn{
      font-size:18px;
      padding:16px 30px;
      min-width:220px;
      border-radius:14px;
    }
    .startHint{
      margin-top:4px;
      font-size:12px;
      opacity:.76;
      letter-spacing:.02em;
    }

    .finishResult{
      margin-top:8px;
      text-align:center;
      font-size:13px;
      font-weight:700;
      color:rgba(245,252,255,.96);
      opacity:.95;
    }
    .finishResult .badgeText{ opacity:.85; font-weight:600; }

    .ratingNote{
      margin-bottom:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      font-weight:700;
      color:rgba(243,251,255,.97);
    }

    /* ---------- Tabs ---------- */
    .tabs{
      display:flex;
      gap:0;
      margin: 4px 0 0;
      padding:3px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      border-radius: 14px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:9px 8px;
      border-radius: 10px;
      border:0;
      background: transparent;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      color: rgba(227,246,255,.86);
    }
    .tab:active{ transform: scale(.99); }
    .tab.active{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      box-shadow:none;
    }

    .center{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
      padding:18px 6px 8px;
      text-align:center;
    }

    .centerIntro{
      min-height: 100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .sessionInfo{
      width:100%;
      box-sizing: border-box;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      margin: 8px 0 4px;
      padding: 10px 0;
      border-radius: 0;
      background: transparent;
      border: 0;
      border-top: 1px solid rgba(255,255,255,.12);
      border-bottom: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }

    .sessionInfo .left{ flex: 1 1 auto; min-width:0; }

    .sessionInfo .left .line1{
      font-weight:900; letter-spacing:.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sessionInfo .left .line2{
      opacity:.75; font-size:12px; margin-top:3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .timerBox{ flex: 0 0 120px; text-align:center; }
    .timerBox .t1{ font-size:12px; opacity:.9; }
    .timerBox .t2{ font-size:18px; font-weight:900; letter-spacing:.02em; margin-top:3px; }

    .metrics{ margin-top:10px; }
    .row{ text-align:center; margin:16px 0; }
    .label{ font-weight:800; letter-spacing:.08em; margin-bottom:8px; font-size:20px; }

    .pill{
      margin:0 auto;
      width:310px; height:56px;
      background:#fff; border-radius:999px;
      display:flex; overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      color:#111;
      touch-action: manipulation;
    }

    .pill button, .pill .val{
      flex:1; display:flex; align-items:center; justify-content:center;
      border:0; background:transparent; font-size:26px; cursor:pointer;
      touch-action: manipulation;
    }

    .pill .val{ flex:1.2; font-weight:800; font-size:24px; user-select:none; }
    .sep{ width:2px; background:#111; opacity:.8; }
    .pill button:active{ transform: scale(.97); }

    .indicators{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
      margin-top:12px;
    }
    .ind{
      background: transparent;
      border: 1px solid rgba(184,230,255,.16);
      border-radius: 10px;
      padding: 8px 8px;
    }
    .ind .k{ font-size:12px; opacity:.75; margin-bottom:6px; }
    .ind .v{ font-size:18px; font-weight:900; letter-spacing:.02em; }

    .footer{
      margin-top:auto;
      padding-top:8px;
      padding-bottom:2px;
      text-align:center;
      font-size:8px;
      opacity:.70;
      letter-spacing:.03em;
      border-top:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      position:sticky;
      bottom:0;
      background: linear-gradient(180deg, rgba(20,92,140,0), rgba(20,92,140,.35));
      z-index:3;
    }

    /* ---------- Calendar (blue translucent style) ---------- */
    .calSurface{
      background: rgba(255,255,255,.09);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 6px 6px 6px;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      overflow:hidden;
    }

    .calHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 2px 0 10px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,.14);
    }

    .calTitle{
      font-weight:700;
      letter-spacing:.02em;
      font-size:14px;
      text-align:center;
      flex:1;
      color: var(--calInk);
      opacity:.95;
    }

    .iconBtn{
      width:34px; height:34px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:1000;
      color: var(--calInk);
      box-shadow:none;
      touch-action: manipulation;
    }
    .iconBtn:active{ transform: scale(.98); }

    /* IMPORTANT: prevent horizontal scroll + force fit */
    .calGrid{
      width:100%;
      box-sizing:border-box;
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:1px;
      overflow:hidden;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 10px;
      padding: 1px;
    }

    .dow{
      text-align:center;
      font-size:11.4px;
      letter-spacing:.12em;
      font-weight:900;
      padding:7px 0;
      color: var(--calMuted);
      user-select:none;
      min-width:0;
      border: 0;
      border-radius: 0;
      background: rgba(255,255,255,.05);
    }

    /* Square day WITHOUT aspect-ratio (avoids Safari grid overflow bugs) */
    .dayCell{
      position:relative;
      border-radius: 0;
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.07);
      cursor:pointer;
      user-select:none;
      min-width:0;              /* key for grid overflow */
      overflow:hidden;           /* clip anything inside */
      box-shadow:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      touch-action: manipulation;
    }
    .dayCell:active{ transform: scale(.985); }
    .dayCell:hover{ background: rgba(255,255,255,.10); }

    .dayCell.muted{
      opacity:1;
      background: rgba(255,255,255,.03);
      border-color: rgba(255,255,255,.10);
      box-shadow: none !important;
    }
    .dayCell.muted .dayNum,
    .dayCell.muted .miniClean{ opacity:.45; }

    .dayCell.today{
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
    }

    .dayCell.hasData{
      box-shadow: none;
    }

    .dayCell.selected{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.28);
      box-shadow: none;
    }
    .dayCell.muted.selected{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.12);
      box-shadow: none;
    }


    /* Square sizing helper */
    .dayCell::before{
      content:"";
      display:block;
      padding-top:134%;
    }
    .dayContent{
      position:absolute;
      inset:3px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-width:0;
    }

    .dayTop{
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:2px;
      min-width:0;
      min-height: 9px;
    }

    .dayNum{
      font-weight:900;
      font-size:11.4px;
      letter-spacing:.01em;
      color: var(--calInk);
      min-width:0;
    }

    .dayDot{
      margin-left:auto;
      width:11px;
      height:11px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.60);
      align-self:flex-start;
      margin-top:1px;
      flex:0 0 auto;
    }
    .dayDot.good{ background:#2ce06a; box-shadow: 0 1px 3px rgba(0,0,0,.28); }
    .dayDot.regular{ background:#ffd24a; box-shadow: 0 1px 3px rgba(0,0,0,.24); }
    .dayDot.bad{ background:#ff4b4b; box-shadow: 0 1px 3px rgba(0,0,0,.30); }
    .dayCell.muted .dayDot{ opacity:.45; }

    .badge{
      display:none;
      font-size:8px;
      font-weight:900;
      letter-spacing:.04em;
      padding: 1px 3px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      color: var(--calInk);
      white-space:nowrap;
      max-width: 38px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge.today{
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.28);
    }

    .miniClean{
      margin-top: 1px;
      min-width:0;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:1px;
      font-size:10px;
      line-height:1.15;
      color: var(--calInk);
      font-weight:500;
      letter-spacing:.01em;
    }
    .miniClean .kpiInline{ min-width:0; opacity:.95; }

    /* Stats under calendar */
    .statsPanel{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .statCard{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 10px;
      padding: 10px 10px;
      color: var(--calInk);
      box-shadow: none;
      backdrop-filter: none;
      overflow:hidden;
    }
    .statHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .statHead .h{
      font-weight:700;
      letter-spacing:.01em;
      font-size:13px;
      color: var(--calInk);
    }
    .statHead .p{
      font-size:13px;
      color: rgba(255,255,255,.75);
      white-space:nowrap;
    }
    .statGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:8px;
    }
    .statItem{
      border-radius: 8px;
      padding: 7px 6px;
      text-align:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: none;
      min-width:0;
    }
    .statItem .k{
      font-size:10px; letter-spacing:.10em; font-weight:1000;
      color: rgba(255,255,255,.78);
      margin-bottom: 4px;
      white-space:nowrap;
    }
    .statItem .v{
      font-size:14px; font-weight:1000; letter-spacing:.02em;
      color: var(--calInk);
      white-space:nowrap;
    }
    .moneyLine{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color: rgba(255,255,255,.75);
    }
    .moneyLine b{ font-weight:1000; color: var(--calInk); }

    .statsMiniTitle{
      font-size:13px;
      font-weight:900;
      letter-spacing:.01em;
      color: var(--calInk);
    }
    .statsHeroNumber{
      margin-top:6px;
      font-size:32px;
      line-height:1;
      font-weight:1000;
      color: rgba(244,252,255,.98);
    }
    .statsHeroEarned{
      margin-top:3px;
      font-size:13px;
      font-weight:800;
      color: rgba(223,244,255,.90);
    }
    .statsMiniLine{
      margin-top:8px;
      font-size:12px;
      font-weight:700;
      color: rgba(214,238,252,.84);
    }
    .statsMiniChips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .statsMiniChip{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
      font-weight:800;
      color: rgba(235,248,255,.95);
    }
    .statsMiniMeta{
      margin-top:8px;
      font-size:11px;
      color: rgba(214,238,252,.78);
    }
    /* ---------- Summary ---------- */
    .sumWrap{ display:grid; gap:10px; }
    .sumCard{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 10px;
      padding: 10px;
    }
    .sumTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom: 10px;
    }
    .sumTitle{ font-weight:700; letter-spacing:.02em; font-size:14px; opacity:.95; }
    .sumSub{ font-size:12px; opacity:.85; margin-top: 4px; }
    .sumMoney{ text-align:right; font-weight:900; letter-spacing:.02em; font-size:14px; }
    .sumMoney span{
      display:block;
      font-size:11px;
      opacity:.85;
      font-weight:800;
      letter-spacing:.08em;
      margin-top: 2px;
    }
    .sumStats{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .sumPill{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      padding: 8px 6px;
      text-align:center;
    }
    .sumPill .k{
      font-size:10px;
      opacity:.85;
      letter-spacing:.08em;
      font-weight:900;
      margin-bottom: 6px;
    }
    .sumPill .v{
      font-size:16px;
      font-weight:900;
      letter-spacing:.02em;
    }

    .progWrap{ display:grid; gap:10px; }
    .progCard{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 11px;
    }
    .progTitle{ font-size:14px; font-weight:900; letter-spacing:.02em; }
    .progBig{ font-size:23px; font-weight:1000; line-height:1.1; margin-top:4px; }
    .progSub{ font-size:12px; opacity:.85; margin-top:4px; }
    .progBar{ margin-top:10px; height:12px; border-radius:999px; background: rgba(255,255,255,.14); border:1px solid rgba(200,236,255,.35); overflow:hidden; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .progBar > span{ display:block; height:100%; background: linear-gradient(90deg, rgba(80,205,255,.95), rgba(157,231,255,.95)); box-shadow: 0 0 14px rgba(120,221,255,.45); }
    .checkList{ margin-top:8px; display:grid; gap:6px; }
    .checkItem{ display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:13px; }
    .checkLeft{ display:flex; align-items:center; gap:8px; }
    .checkDot{ width:19px; height:19px; border-radius:999px; border:1px solid rgba(186,203,216,.55); background: rgba(110,130,146,.30); color: rgba(232,243,252,.92); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:900; }
    .checkItem.done .checkDot{ background: rgba(46,217,107,.36); border-color: rgba(90,245,151,.88); color:#d8ffe9; box-shadow: 0 0 10px rgba(46,217,107,.45); }
    .progCounter{ font-weight:1000; opacity:.98; font-size:19px; letter-spacing:.02em; }
    .goalLine{ margin-top:10px; font-size:12px; opacity:.92; }
    .rewardBig{ font-size:28px; font-weight:1000; margin-top:6px; line-height:1.12; }
    .compactMain{ font-size:26px; font-weight:1000; margin-top:4px; }
    .compactGrid{ margin-top:10px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; }
    .compactGrid .sumPill .v{ font-size:15px; }

    .rewardCard{ padding:16px 14px; }
    .rewardTitleRow{ display:flex; align-items:center; gap:8px; }
    .rewardIcon{ width:24px; height:24px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background: rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.24); font-size:14px; }
    .weekImpact{ margin-top:6px; font-size:12px; opacity:.88; }

    /* ---------- Modal ---------- */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(520px, 96vw);
      background: rgba(255,255,255,.11);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 8px 22px rgba(6,34,56,.16);
      padding: 14px;
      position:relative;
    }

    /* avoid stacked glass layers inside modal */
    .modal .statCard,
    .modal .reportBox,
    .modal .qrWrap{
      background: transparent;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom: 10px;
    }
    .modalTitle{ font-weight:900; font-size:16px; letter-spacing:.02em; }

    .xbtn{
      border:1px solid rgba(255,255,255,.30);
      background: rgba(255,255,255,.10);
      color:#fff;
      width:34px; height:34px;
      border-radius: 12px;
      cursor:pointer;
      font-size:16px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      touch-action: manipulation;
    }
    .xbtn:active{ transform: scale(.98); }

    .modalBody{ margin-top: 6px; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .field label{ display:block; font-size:12px; opacity:.9; margin:0 0 6px 2px; }
    .field input{
      width:100%; box-sizing:border-box;
      border-radius:12px; border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.10);
      color:#fff; padding:10px 12px; font-size:14px;
      outline:none; touch-action: manipulation;
    }
    .field input::placeholder{ color: rgba(255,255,255,.75); }

    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }


    #modal_add_day{
      align-items:flex-start;
      padding: max(10px, env(safe-area-inset-top, 0px)) 12px max(10px, env(safe-area-inset-bottom, 0px));
    }
    #modal_add_day .modal{
      width:min(560px, 100%);
      height: calc(100svh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 20px);
      max-height: calc(100dvh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 20px);
      display:flex;
      flex-direction:column;
      margin: 0 auto;
      overflow:hidden;
    }
    #modal_add_day .modalBody{
      margin-top: 2px;
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      padding-right: 2px;
      padding-bottom: 8px;
      min-width:0;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    #modal_add_day .grid2{
      gap:12px;
      margin-top:8px;
    }
    #modal_add_day .grid2 .field{ min-width:0; }
    #modal_add_day .modalActions{
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      background: rgba(14,58,88,.22);
    }

    .managerDetailActions{
      display:flex;
      justify-content:flex-end;
      margin-top:8px;
    }

    .managerAgentsTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .managerPrimaryBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin-left:auto;
      min-width:170px;
      background: rgba(210,239,255,.3);
      border-color: rgba(219,243,255,.72);
      box-shadow: 0 10px 20px rgba(6,36,61,.24);
    }
    .managerPrimaryBtn .plus{
      font-size:18px;
      font-weight:900;
      line-height:1;
    }
    .managerKpiGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:2px;
    }
    .managerKpiCard{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.12);
      padding:12px;
      box-shadow: 0 10px 24px rgba(6,34,58,.22);
    }
    .managerKpiLabel{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:800;
      color: rgba(220,242,255,.88);
    }
    .managerKpiValue{
      margin-top:8px;
      font-size:clamp(32px, 6vw, 46px);
      line-height:1;
      font-weight:1000;
      color: rgba(246,253,255,.98);
    }
    .managerAgentsList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .managerAgentCard{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.09);
      padding:12px;
      text-align:left;
      cursor:pointer;
      transition: background .18s ease, border-color .18s ease, transform .18s ease;
    }
    .managerAgentCard:hover{
      background: rgba(255,255,255,.15);
      border-color: rgba(228,246,255,.38);
      transform: translateY(-1px);
    }
    .managerAgentCard.active{
      background: rgba(222,244,255,.2);
      border-color: rgba(230,248,255,.46);
    }
    .managerAgentName{
      font-size:20px;
      font-weight:900;
      line-height:1.15;
      color: rgba(246,253,255,.98);
    }
    .managerAgentEmail{
      margin-top:4px;
      font-size:12px;
      color: rgba(209,236,252,.86);
    }
    .managerAgentMetrics{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px;
      align-items:end;
    }
    .managerMetricLabel{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color: rgba(202,232,249,.82);
      font-weight:800;
    }
    .managerMetricValue{
      margin-top:4px;
      font-size:24px;
      line-height:1;
      font-weight:900;
      color: rgba(242,251,255,.98);
    }
    .managerMetricValue.highlight{
      color: rgba(183,238,255,.98);
      text-shadow: 0 0 16px rgba(135,219,255,.32);
    }
    .managerMetricLink{
      font-size:13px;
      font-weight:900;
      color: rgba(203,238,255,.95);
      text-align:right;
      align-self:center;
      white-space:nowrap;
    }
    .managerAgentDetail{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,.16);
    }
    .btnSubtleDanger{
      min-height:30px;
      padding:4px 10px;
      font-size:11px;
      font-weight:700;
      opacity:.8;
      border-color: rgba(255,130,130,.34);
      background: rgba(255,95,95,.08);
    }
    .btnSubtleDanger:hover{
      opacity:1;
      background: rgba(255,95,95,.14);
      border-color: rgba(255,155,155,.45);
    }

    .reportBox{
      width:100%;
      box-sizing:border-box;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      padding: 10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .dayRatingRow{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .dayRatingPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      font-weight:900;
      font-size:15px;
      letter-spacing:.01em;
    }
    .dayRatingDot{ width:10px; height:10px; border-radius:50%; }
    .dayRatingPill.good .dayRatingDot{ background:#2ce06a; box-shadow:0 0 0 3px rgba(44,224,106,.18); }
    .dayRatingPill.regular .dayRatingDot{ background:#ffd24a; box-shadow:0 0 0 3px rgba(255,210,74,.18); }
    .dayRatingPill.bad .dayRatingDot{ background:#ff4b4b; box-shadow:0 0 0 3px rgba(255,75,75,.18); }
    .dayBadgeMini{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.09);
      font-size:12px;
      font-weight:800;
      opacity:.95;
    }
    .dayMetricGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:8px;
      margin-bottom:10px;
    }
    .dayMetricChip{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      padding:8px 6px;
      text-align:center;
    }
    .dayMetricChip .k{ font-size:10px; font-weight:900; letter-spacing:.08em; opacity:.85; }
    .dayMetricChip .v{ font-size:16px; font-weight:900; margin-top:4px; }
    .dayDetailsPanel{
      margin-top:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      padding:8px;
    }
    .dayDetailsPanel summary{
      cursor:pointer;
      font-size:12px;
      font-weight:800;
      letter-spacing:.04em;
      opacity:.9;
      margin:0 0 8px;
    }
    .dayDetailsPanel .reportBox{ opacity:.78; }

    #modal_day .modal{
      max-height: 90dvh;
      display:flex;
      flex-direction:column;
    }
    #modal_day .modalBody{
      overflow-y:auto;
      min-height:0;
      padding-right:2px;
    }
    #day_edit_grid{
      grid-template-columns: repeat(2, minmax(0,1fr));
    }

    /* QR */
    .qrWrap{
      margin-top:12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      padding: 12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .qrTitle{
      font-weight:900;
      letter-spacing:.02em;
      font-size:13px;
      opacity:.95;
      text-align:center;
    }
    .qrCard{
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #qr_box{ display:flex; align-items:center; justify-content:center; }
    #qr_box img, #qr_box canvas{ display:block; border-radius: 10px; }
    .qrNote{
      opacity:.90;
      font-size:13px;
      text-align:center;
      line-height:1.25;
      max-width: 420px;
    }


    /* iPad/Safari can render nested glass layers as white blocks.
       Keep calendar on a single translucent layer there. */
    @supports (-webkit-touch-callout: none){
      .calSurface{
        background: rgba(168,219,245,.12);
      }
    }

    @media (min-width: 768px){
      .app-shell{ width:min(95vw, 1020px); padding:18px 22px 30px; }
      .topbar{ gap:12px; margin-bottom:12px; }
      .topbarTitle{ font-size:28px; }
      .topbarDate{ font-size:14px; }
      .langBtn, .topbarLangBtn{ min-height:44px; font-size:13px; }
      .userChip{ font-size:13px; padding:8px 13px; max-width:280px; }
      .logoutBtn{ font-size:12px; }
      .tabs{ margin-top:8px; }
      .tab{ min-height:46px; font-size:15px; }
      .authShell{ width:min(540px, 100%); }
      .authCard{ padding:24px 22px; gap:16px; }
      .authTitle{ font-size:28px; }
      .authInput{ min-height:50px; font-size:16px; }
    }

    @media (max-width: 520px){
      .app-shell{ width:100%; padding:12px 10px 18px; }
      .card{ padding:10px; min-height:calc(100dvh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 24px); }
      .appHeader{ padding:4px 0 4px; }
      .pill{ width: 290px; }
      .grid2{ grid-template-columns: 1fr; }
      #modal_add_day{ padding: max(8px, env(safe-area-inset-top, 0px)) 8px max(8px, env(safe-area-inset-bottom, 0px)); }
      #modal_add_day .modal{ border-radius: 14px; }
      #modal_add_day .modal{ height: calc(100svh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 16px); }
      .timerBox{ flex-basis: 112px; }

      /* tighter calendar on small screens so it NEVER overflows */
      .calSurface{ padding:8px 4px 8px; }
      .statsPanel{ grid-template-columns: 1fr; }
      .calGrid{ gap:1px; }
      .dayContent{ inset:3px; }
      .dayCell{ border-radius: 0; }
      .miniClean{ gap:1px; font-size:9px; }

      .statGrid{ grid-template-columns: repeat(5, minmax(0,1fr)); }
      .sumStats{ grid-template-columns: repeat(3, 1fr); }
      .managerKpiGrid{ grid-template-columns: 1fr; }
      .managerPrimaryBtn{ width:100%; }
      .managerAgentMetrics{ grid-template-columns: 1fr 1fr; }
      .managerMetricLink{ grid-column: 1 / -1; text-align:left; }
    }


  </style>
</head>

<body>
  <div id="authRoot">
    <div class="authBackdropOrb one" aria-hidden="true"></div>
    <div class="authBackdropOrb two" aria-hidden="true"></div>
    <div class="authShell">
      <div class="authTopRow">
        <button class="btn authTopLangBtn" id="auth_lang_toggle" title="Language">ES</button>
      </div>
      <div class="authBrand">
        <h1 class="authBrandTitle">RetailFlow Tracker</h1>
        <p class="authBrandSubtitle">Control profesional de ventas retail</p>
      </div>

      <div id="authCard" class="authCard">
        <h2 class="authTitle" id="auth_login_title">Inicia sesión</h2>
        <div class="authCardIntro">Accede a tu panel de rendimiento diario</div>
        <input id="authEmail" class="authInput" type="email" placeholder="tu@email.com" autocomplete="email" />
        <input id="authPass" class="authInput" type="password" placeholder="Contraseña" autocomplete="current-password" />
        <div class="authActions">
          <button id="authSignupOpenBtn" class="btn authSecondaryBtn" onclick="authOpenSignup()">Crear cuenta</button>
          <button id="authLoginBtn" class="btn primary authLoginBtn" onclick="authLogin()">
            <span id="authLoginBtnText">Iniciar sesión</span>
            <span class="authSpinner" aria-hidden="true"></span>
          </button>
        </div>
        <div id="authMsg" class="authMsg"></div>
        <div class="authSecureText">Tus datos se guardan de forma segura en la nube</div>
      </div>

      <div class="authVersion">v1.0 · RetailFlow</div>
    </div>

    <div class="authSignupOverlay" id="auth_signup_overlay">
      <div class="authSignupModal">
        <h3 class="authSignupTitle" id="signup_title">Crear cuenta</h3>
        <input id="signupName" class="authInput" type="text" placeholder="Nombre completo" autocomplete="name" />
        <input id="signupTeamId" class="authInput" type="text" placeholder="ej: team-closeflow-001" autocomplete="organization" />
        <input id="signupEmail" class="authInput" type="email" placeholder="correo@empresa.com" autocomplete="email" />
        <input id="signupPass" class="authInput" type="password" placeholder="Contraseña" autocomplete="new-password" />
        <input id="signupPass2" class="authInput" type="password" placeholder="Repite contraseña" autocomplete="new-password" />
        <div id="signupMsg" class="authSignupMsg"></div>
        <div class="authSignupActions">
          <button class="btn" id="signup_cancel_btn" onclick="authCloseSignup()">Cancelar</button>
          <button class="btn primary" id="signupCreateBtn" onclick="authSignup()">Crear cuenta</button>
        </div>
      </div>
    </div>
  </div>

  <div id="appRoot" style="display:none;">
  <div class="app-shell">
    <div class="card">
      <div class="appHeader">
      <div class="topbar">
        <div class="topbarRow topbarRowMain">
          <div class="topbarTitle" id="today_title">RetailFlow Tracker</div>
          <button class="btn topbarLangBtn" id="lang_toggle" title="Cambiar idioma / Change language">ES</button>
        </div>
        <div class="topbarRow topbarRowSub">
          <div class="topbarDate" id="today_date"></div>
          <div class="topbarActions" id="top_actions">
            <div class="userChip"><span id="userEmail"></span></div>
            <button class="btn logoutBtn" id="logout_btn" onclick="authLogout()">Cerrar sesión</button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="counter" id="tab_counter_label">Contador</div>
        <div class="tab" data-tab="calendar" id="tab_calendar_label">Calendario</div>
        <div class="tab" data-tab="summary" id="tab_summary_label">Progreso</div>
        <div class="tab" data-tab="agents" id="tab_agents_label" style="display:none;">Agentes</div>
      </div>
      </div>

      <div class="appMain">
      <!-- ============ TAB: COUNTER ============ -->
      <div id="tab_counter">
        <div id="start_screen" class="center centerIntro">
          <div class="startHeroTitle" id="start_headline">Comienza tu jornada</div>
          <div class="startHeroSub" id="start_intro">Registra tu día de ventas</div>
          <button class="btn primary startMainBtn" id="start_day">Iniciar día</button>
          <div class="startHint" id="start_hint">Tus datos se guardan automáticamente</div>
        </div>

        <div id="session_screen" style="display:none;">
          <div class="sessionInfo">
            <div class="left">
              <div class="line1" id="who_line">—</div>
              <div class="line2" id="date_line">—</div>
            </div>
            <div class="timerBox">
              <div class="t1">Session</div>
              <div class="t2" id="timer">00:00:00</div>
            </div>
          </div>

          <div class="metrics" id="list"></div>

          <div class="indicators">
            <div class="ind">
              <div class="k">% Aggressiveness (Z/S)</div>
              <div class="v" id="aggr">—</div>
            </div>
            <div class="ind">
              <div class="k">% Close (X/Z)</div>
              <div class="v" id="close">0.0%</div>
            </div>
          </div>

          <div class="sessionActions">
            <button class="btn helpBtn" id="rating_help_btn" aria-label="Ver criterios de clasificación">?</button>
            <button class="btn primary" id="finish_day">Finalizar día</button>
          </div>
          <div id="finish_result" class="finishResult" style="display:none;"></div>
        </div>
      </div>

      <!-- ============ TAB: CALENDAR ============ -->
      <div id="tab_calendar" style="display:none;">
        <div class="calSurface">
          <div class="calHeader">
            <div class="iconBtn" id="cal_prev" aria-label="Previous month">‹</div>
            <div class="calTitle" id="cal_title">—</div>
            <div class="iconBtn" id="cal_next" aria-label="Next month">›</div>
          </div>

          <div class="calGrid" id="cal_grid"></div>

          <div class="statsPanel">
            <div class="statCard" id="week_stats"></div>
            <div class="statCard" id="month_stats"></div>
          </div>
        </div>
      </div>

      <!-- ============ TAB: SUMMARY ============ -->
      <div id="tab_summary" style="display:none;">
        <div class="sumWrap" id="sum_wrap"></div>
      </div>

      <!-- ============ TAB: AGENTS (MANAGER) ============ -->
      <div id="tab_agents" style="display:none;">
        <div class="calSurface" style="display:flex; flex-direction:column; gap:10px;">
          <div class="managerAgentsTop">
            <div class="statsMiniTitle" id="agents_section_title">Agentes</div>
            <button class="btn managerPrimaryBtn" id="agents_add_btn"><span class="plus">+</span>Agregar agente</button>
          </div>
          <div class="managerKpiGrid" id="manager_team_kpis">
            <div class="managerKpiCard">
              <div class="managerKpiLabel" id="agents_kpi_active_label">Agentes activos</div>
              <div class="managerKpiValue" id="kpi_agents_active">0</div>
            </div>
            <div class="managerKpiCard">
              <div class="managerKpiLabel" id="agents_kpi_week_label">Ventas semana (X)</div>
              <div class="managerKpiValue" id="kpi_team_week">0</div>
            </div>
            <div class="managerKpiCard">
              <div class="managerKpiLabel" id="agents_kpi_month_label">Ventas mes (X)</div>
              <div class="managerKpiValue" id="kpi_team_month">0</div>
            </div>
          </div>
          <div id="agents_error" style="min-height:18px; font-size:12px; opacity:.9;"></div>
          <div id="agents_list" class="managerAgentsList"></div>

          <div id="manager_agent_detail" class="managerAgentDetail" style="display:none;">
            <div class="calHeader">
              <div class="iconBtn" id="mgr_cal_prev" aria-label="Previous month">‹</div>
              <div class="calTitle" id="mgr_cal_title">—</div>
              <div class="iconBtn" id="mgr_cal_next" aria-label="Next month">›</div>
            </div>
            <div class="calGrid" id="mgr_cal_grid"></div>
            <div class="statsPanel">
              <div class="statCard" id="mgr_week_stats"></div>
              <div class="statCard" id="mgr_month_stats"></div>
            </div>
            <div class="managerDetailActions">
              <button class="btn btnSubtleDanger" id="manager_remove_agent_btn" style="display:none;">Eliminar agente</button>
            </div>
          </div>
        </div>
      </div>


      </div>
    </div>
  </div>

  <!-- Modal: Start day -->
  <div class="overlay" id="modal_start">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Start day">
      <div class="modalHeader">
        <div class="modalTitle" id="start_modal_title">Iniciar día</div>
        <button class="xbtn" id="start_x" aria-label="Close">×</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.9; font-size:13px;" id="start_modal_intro">
          Confirma tu perfil y agrega la tienda del día.
        </div>
        <div style="margin-top:8px; font-weight:800;" id="start_profile_name">—</div>
        <div class="grid2">
          <div class="field" style="grid-column:1/-1;">
            <label id="start_store_label">Tienda del día</label>
            <input id="start_store" placeholder="Ej: 2770 Valwood - Irving" />
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="start_cancel">Cancel</button>
          <button class="btn primary" id="start_confirm">Start</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Profile -->
  <div class="overlay" id="modal_profile">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Profile">
      <div class="modalHeader">
        <div class="modalTitle" id="profile_modal_title">Perfil</div>
        <button class="xbtn" id="profile_x" aria-label="Close">×</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <label id="profile_name_label">Nombre</label>
          <input id="profile_name" placeholder="Ej: Alen Cordero" autocomplete="name" />
        </div>
        <div class="modalActions">
          <button class="btn" id="profile_reset">Reset datos</button>
          <button class="btn primary" id="profile_save">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Day summary -->
  <div class="overlay" id="modal_report">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Day summary">
      <div class="modalHeader">
        <div class="modalTitle" id="report_modal_title">Resumen del día</div>
        <button class="xbtn" id="report_x" aria-label="Back">×</button>
      </div>
      <div class="modalBody">
        <div id="report_day_rating" class="ratingNote" style="display:none;"></div>

        <div id="qr_wrap" class="qrWrap" style="display:none;">
          <div class="qrTitle" id="qr_title">Abrir reporte en el teléfono</div>
          <div class="qrCard">
            <div id="qr_box"></div>
          </div>
          <div class="qrNote" id="qr_note">
            Escanea el QR y envía el reporte desde tu teléfono.
          </div>
        </div>

        <div class="reportBox" id="report_box">—</div>

        <div class="modalActions" id="report_actions">
          <button class="btn" id="copy_btn">Copiar</button>
          <button class="btn primary" id="share_btn">Compartir</button>
          <button class="btn primary" id="end_btn" style="display:none;">End day</button>
        </div>

        <div id="report_hint" style="margin-top:10px; opacity:.8; font-size:12px;">
          Copia o comparte para terminar el día y resetear.
        </div>
        <div id="report_save_status" style="margin-top:6px; min-height:18px; font-size:12px; opacity:.95;"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Day details (calendar click) -->
  <div class="overlay" id="modal_day">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Day details">
      <div class="modalHeader">
        <div class="modalTitle" id="day_modal_title">Day details</div>
        <button class="xbtn" id="day_x" aria-label="Close">×</button>
      </div>

      <div class="modalBody">
        <div class="dayRatingRow" id="day_modal_rating"></div>
        <div class="dayMetricGrid" id="day_modal_kpis"></div>
        <div class="statCard" id="day_modal_meta" style="margin:0;"></div>

        <details class="dayDetailsPanel" id="day_details_panel" open>
          <summary id="day_details_summary">Detalles</summary>
          <div class="reportBox" id="day_modal_report">—</div>
        </details>

        <div class="grid2" id="day_edit_grid" style="display:none; margin-top:10px;">
          <div class="field"><label>S</label><input id="day_edit_s" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>Z</label><input id="day_edit_z" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>CC</label><input id="day_edit_cc" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>C</label><input id="day_edit_c" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>X</label><input id="day_edit_x" type="number" min="0" inputmode="numeric" /></div>
        </div>

        <div class="modalActions">
          <button class="btn" id="day_copy">Copiar</button>
          <button class="btn" id="day_share">Compartir</button>
          <button class="btn primary" id="day_add_missing" style="display:none;">Agregar día</button>
          <button class="btn" id="day_edit">Editar día</button>
          <button class="btn" id="day_delete">Borrar día</button>
          <button class="btn primary" id="day_save" style="display:none;">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>



  <div class="overlay" id="modal_add_agent">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Add agent">
      <div class="modalHeader">
        <div class="modalTitle" id="add_agent_title">Agregar agente</div>
        <button class="xbtn" id="add_agent_x" aria-label="Close">×</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <label id="add_agent_email_label">Email del agente</label>
          <input id="add_agent_email" type="email" placeholder="agente@empresa.com" />
        </div>
        <div id="add_agent_msg" style="min-height:18px; font-size:12px;"></div>
        <div class="modalActions">
          <button class="btn" id="add_agent_cancel">Cancelar</button>
          <button class="btn primary" id="add_agent_confirm">Asignar</button>
        </div>
      </div>
    </div>
  </div>



  <div class="overlay" id="modal_add_day">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Add day">
      <div class="modalHeader">
        <div class="modalTitle" id="add_day_title">Agregar día</div>
        <button class="xbtn" id="add_day_x" aria-label="Close">×</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="field"><label id="add_day_date_label">Fecha</label><input id="add_day_date" type="date" /></div>
          <div class="field"><label id="add_day_rep_label">Nombre</label><input id="add_day_rep" type="text" /></div>
          <div class="field" style="grid-column:1/-1;"><label id="add_day_store_label">Tienda</label><input id="add_day_store" type="text" /></div>
          <div class="field"><label id="add_day_start_label">Inicio (opcional)</label><input id="add_day_start" type="time" /></div>
          <div class="field"><label id="add_day_end_label">Fin (opcional)</label><input id="add_day_end" type="time" /></div>
          <div class="field"><label>S</label><input id="add_day_s" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>Z</label><input id="add_day_z" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>CC</label><input id="add_day_cc" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>C</label><input id="add_day_c" type="number" min="0" inputmode="numeric" /></div>
          <div class="field"><label>X</label><input id="add_day_xv" type="number" min="0" inputmode="numeric" /></div>
        </div>
        <div id="add_day_msg" style="min-height:18px; font-size:12px;"></div>
        <div class="modalActions">
          <button class="btn" id="add_day_cancel">Cancelar</button>
          <button class="btn primary" id="add_day_confirm">Guardar día</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Rating help -->
  <div class="overlay" id="modal_rating_help">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Criterios de clasificación">
      <div class="modalHeader">
        <div class="modalTitle" id="rating_help_title">Day rating rules</div>
        <button class="xbtn" id="rating_help_x" aria-label="Close">×</button>
      </div>
      <div class="modalBody" id="rating_help_body" style="font-size:13px; line-height:1.45;"></div>
    </div>
  </div>

  </div>

  <!-- Modal: Language -->
  <div class="overlay" id="modal_language">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Language">
      <div class="modalHeader">
        <div class="modalTitle" id="lang_modal_title">Idioma</div>
        <button class="xbtn" id="lang_x" aria-label="Close">×</button>
      </div>
      <div class="modalBody">
        <div id="lang_modal_intro" style="opacity:.9; font-size:13px; margin-bottom:12px;">Selecciona el idioma:</div>
        <div class="modalActions">
          <button class="btn" id="lang_es">Español</button>
          <button class="btn" id="lang_en">English</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

<script>
  const metrics = ["S","Z","CC","C","X"];
  const STATE_KEY = "kpi_state_v44";
  const HISTORY_KEY = "kpi_history_v1";
  const HISTORY_KEY_PREFIX = "kpi_history_v1_uid";
  const TEAM_KEY = "kpi_team_v1";
  const PROFILE_KEY = "kpi_profile_v1";
  const LANG_KEY = "app_lang";
  const LEGACY_LANG_KEY = "kpi_lang_v1";
  const AGGR_MIN_STOPS = 20;
  const MONEY_PER_X = 100;

  const i18n = {
    es: {
      tabCounter: "Contador",
      tabCalendar: "Calendario",
      tabSummary: "Progreso",
      languageBtn: "Idioma",
      languageModalTitle: "Idioma",
      languageModalIntro: "Selecciona el idioma:",
      languageSpanish: "Español",
      languageEnglish: "Inglés",
      session: "Sesión",
      appTitle: "RetailFlow Tracker",
      loginTitle: "Inicia sesión",
      loginEmailPlaceholder: "tu@email.com",
      loginPassPlaceholder: "Contraseña",
      loginBtn: "Iniciar sesión",
      signupBtn: "Crear cuenta",
      signupTitle: "Crear cuenta",
      logoutBtn: "Cerrar sesión",
      startHeadline: "Comienza tu jornada",
      startIntro: "Registra tu día de ventas",
      startHint: "Tus datos se guardan automáticamente",
      startDay: "Iniciar día",
      profileBtn: "Perfil",
      profileTitle: "Perfil",
      profileSave: "Guardar",
      profileReset: "Reset datos",
      finishDay: "Finalizar día",
      startModalTitle: "Iniciar día",
      startModalIntro: "Confirma tu perfil y agrega la tienda del día.",
      profileForDay: "Perfil",
      nameLabel: "Nombre",
      storeLabel: "Tienda del día",
      cancel: "Cancelar",
      start: "Comenzar",
      date: "Fecha",
      day: "Día",
      begins: "Inicio",
      missingProfile: "Primero guarda tu nombre en Perfil.",
      missingStore: "Por favor ingresa la tienda del día.",
      endConfirm: "¿Seguro que quieres finalizar el día y resetear?",
      endDayNow: "Finalizar día",
      savingDay: "Guardando…",
      savedOk: "Guardado ✓",
      saveError: "Error al guardar",
      finishResult: "Resultado",
      dayResult: "Resultado del día",
      weekStatsTitle: "Stats de la semana",
      monthStatsTitle: "Stats del mes",
      avgStopsPerDay: "Promedio S/día",
      avgStopsPerDayLabel: "Promedio stops/día",
      earnedWord: "ganado",
      calendarMonths: ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],
      calendarWeekdays: ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"],
      hoursWorked: "Horas trabajadas",
      workedDays: "Días trabajados",
      earnedLabel: "GANADO",
      stopsLabel: "Stops",
      aggLabel: "Agg",
      closeLabel: "Close",
      weekLabel: "Semana",
      monthLabel: "Mes",
      salesWord: "ventas",
      currentWeek: "Semana actual",
      currentMonth: "Mes actual",
      progressLevelTitle: "Tu nivel",
      currentLevel: "Nivel actual",
      nextLevel: "Siguiente nivel",
      levelSeller: "VENDEDOR",
      levelTrainer: "ENTRENADOR",
      pathToNextLevel: "Camino al siguiente nivel",
      reqA: "3 semanas consecutivas con +12 ventas",
      weekN: "Semana",
      completed: "completada",
      pending: "pendiente",
      reqB: "3 personas entrenadas generando cheque",
      nextGoalWeek: "Siguiente objetivo recomendado esta semana: llegar a 12+ ventas.",
      unlocks: "Desbloqueas",
      unlockReward: "+$10 override por venta de tu equipo",
      unlockRewardNote: "Se desbloquea al completar ambos requisitos.",
      weekCardTitle: "Tu semana actual",
      monthCardTitle: "Tu mes actual",
      salesX: "Ventas (X)",
      trainedAgents: "Entrenados con cheque",
      requirementsCompleted: "requisitos completados",
      firstStepGuide: "Primer paso: consigue 12 ventas esta semana.",
      weekImpact: "Este rendimiento impacta tu progreso hacia ENTRENADOR",
      rewardIcon: "🏆",
      historical: "Histórico",
      sinceFirstDay: "Desde tu primer día registrado",
      bestDay: "Mejor día",
      noSavedDays: "Aún no hay días finalizados guardados.",
      avgXPerDay: "Prom. X/día",
      days: "Días",
      dayRatingRules: "Criterios de clasificación del día",
      quickCriteria: "Criterios rápidos:",
      specialBadges: "Badges especiales:",
      goodDayRule: "<b>Buen día (punto verde)</b>: S es 80 o más + Agresividad es 10% o más, O X es 2 o más.",
      regularDayRule: "<b>Día regular (punto amarillo)</b>: S está entre 50 y 79, O S es 80 o más + Agresividad menor a 10%.",
      badDayRule: "<b>Mal día (punto rojo)</b>: S es menor a 50 + X es 0.",
      luckyDayRule: "<b>🍀 Día con suerte</b>: S menor a 50 + X 1 o más (el punto sigue amarillo).",
      solidDayRule: "<b>🎯 Día sólido (sin resultado)</b>: S 80 o más + Agresividad 10% o más + X 0 (el punto sigue verde).",
      goodDay: "Buen día",
      regularDay: "Regular",
      badDay: "Mal día",
      luckyBadge: "🍀 Día con suerte",
      solidBadge: "🎯 Día sólido (sin resultado)",
      dayDetailsSummary: "Detalles",
      dayDetailsTitle: "Detalle del día",
      dayNoDataTitle: "Sin datos",
      dayNoDataSaved: "No hay un día finalizado guardado.",
      dayNoDataTip: "Tip: finaliza el día para que aparezca aquí.",
      startLbl: "Inicio",
      endLbl: "Fin",
      durLbl: "Dur",
      resultLbl: "Resultado",
      reportModalTitle: "Resumen del día",
      qrTitle: "Abrir reporte en el teléfono",
      qrNote: "Escanea el QR y envía el reporte desde tu teléfono.",
      reportHint: "Copia o comparte para terminar el día y resetear.",
      copyBtn: "Copiar",
      shareBtn: "Compartir",
      monthDayYear: { month: "long", day: "numeric", year: "numeric" },
      monthDay: { month: "long", day: "numeric" },
      weekRangeJoin: "al",
      tabAgents: "Agentes",
      agentsTitle: "Agentes",
      agentsSearchPlaceholder: "Buscar agente",
      addAgent: "Agregar agente",
      addAgentByEmail: "Email del agente",
      assignAgentBtn: "Asignar",
      userNotFoundInTeam: "Usuario no encontrado en este equipo",
      agentAlreadyAssigned: "Este agente ya está asignado.",
      weekXLabel: "Semana X",
      monthXLabel: "Mes X",
      addAgentSaved: "Agente asignado correctamente.",
      addAgentError: "No se pudo agregar el agente.",
      agentsEmpty: "No hay agentes asignados.",
      removeAgent: "Eliminar agente",
      removeAgentConfirm: "¿Eliminar este agente de tu lista?",
      removeAgentSaved: "Agente eliminado correctamente.",
      removeAgentError: "No se pudo eliminar el agente.",
      agentTrail: "Agentes",
      viewDetails: "Ver detalles",
      hideDetails: "Ocultar detalles",
      activeAgentsLabel: "Agentes activos",
      teamWeekSalesLabel: "Ventas semana (X)",
      teamMonthSalesLabel: "Ventas mes (X)",
      readOnlyManager: "Solo lectura (manager)",
      managerRulesNote: "Reglas sugeridas: agents solo escriben sus días; managers leen solo agentes asignados en su team; assignments sólo bajo su managerUid; acceso aislado por team.",
      addDay: "Agregar día",
      addDayTitle: "Agregar día",
      addDaySave: "Guardar día",
      addDayNeedAgent: "Primero selecciona un agente.",
      addDaySaved: "Día agregado correctamente.",
      optionalTime: "(opcional)"
    },
    en: {
      tabCounter: "Counter",
      tabCalendar: "Calendar",
      tabSummary: "Progress",
      languageBtn: "Language",
      languageModalTitle: "Language",
      languageModalIntro: "Select your language:",
      languageSpanish: "Spanish",
      languageEnglish: "English",
      session: "Session",
      appTitle: "RetailFlow Tracker",
      loginTitle: "Sign in",
      loginEmailPlaceholder: "your@email.com",
      loginPassPlaceholder: "Password",
      loginBtn: "Sign in",
      signupBtn: "Create account",
      signupTitle: "Create account",
      logoutBtn: "Log out",
      startHeadline: "Start your day",
      startIntro: "Track your sales day",
      startHint: "Your data is saved automatically",
      startDay: "Start day",
      profileBtn: "Profile",
      profileTitle: "Profile",
      profileSave: "Save",
      profileReset: "Reset data",
      finishDay: "End day",
      startModalTitle: "Start day",
      startModalIntro: "Confirm your profile and add today's store.",
      profileForDay: "Profile",
      nameLabel: "Name",
      storeLabel: "Store for today",
      cancel: "Cancel",
      start: "Start",
      date: "Date",
      day: "Day",
      begins: "Start",
      missingProfile: "Please save your name first in Profile.",
      missingStore: "Please enter today's store.",
      endConfirm: "Are you sure you want to end the day and reset?",
      endDayNow: "End day",
      savingDay: "Saving…",
      savedOk: "Saved ✓",
      saveError: "Error saving",
      finishResult: "Result",
      dayResult: "Day result",
      weekStatsTitle: "Week stats",
      monthStatsTitle: "Month stats",
      avgStopsPerDay: "Avg S/day",
      avgStopsPerDayLabel: "Average stops/day",
      earnedWord: "earned",
      calendarMonths: ["January","February","March","April","May","June","July","August","September","October","November","December"],
      calendarWeekdays: ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],
      hoursWorked: "Hours worked",
      workedDays: "Days worked",
      earnedLabel: "EARNED",
      stopsLabel: "Stops",
      aggLabel: "Agg",
      closeLabel: "Close",
      weekLabel: "Week",
      monthLabel: "Month",
      salesWord: "sales",
      currentWeek: "Current week",
      currentMonth: "Current month",
      progressLevelTitle: "Your level",
      currentLevel: "Current level",
      nextLevel: "Next level",
      levelSeller: "SELLER",
      levelTrainer: "TRAINER",
      pathToNextLevel: "Path to next level",
      reqA: "3 consecutive weeks with 12+ sales",
      weekN: "Week",
      completed: "completed",
      pending: "pending",
      reqB: "3 trained people generating check",
      nextGoalWeek: "Recommended next goal this week: reach 12+ sales.",
      unlocks: "You unlock",
      unlockReward: "+$10 override per sale from your team",
      unlockRewardNote: "Unlocked after completing both requirements.",
      weekCardTitle: "Your current week",
      monthCardTitle: "Your current month",
      salesX: "Sales (X)",
      trainedAgents: "Trained generating check",
      requirementsCompleted: "requirements completed",
      firstStepGuide: "First step: get 12 sales this week.",
      weekImpact: "This performance impacts your progress toward TRAINER",
      rewardIcon: "🏆",
      historical: "Historical",
      sinceFirstDay: "Since your first recorded day",
      bestDay: "Best day",
      noSavedDays: "No completed days saved yet.",
      avgXPerDay: "Avg X/day",
      days: "Days",
      dayRatingRules: "Day rating rules",
      quickCriteria: "Quick criteria:",
      specialBadges: "Special badges:",
      goodDayRule: "<b>Good day (green dot)</b>: S is 80 or more + Aggressiveness is 10% or more, OR X is 2 or more.",
      regularDayRule: "<b>Regular day (yellow dot)</b>: S is between 50 and 79, OR S is 80 or more + Aggressiveness under 10%.",
      badDayRule: "<b>Bad day (red dot)</b>: S is under 50 + X is 0.",
      luckyDayRule: "<b>🍀 Lucky day</b>: S under 50 + X 1 or more (dot stays yellow).",
      solidDayRule: "<b>🎯 Solid day (no result)</b>: S 80 or more + Aggressiveness 10% or more + X 0 (dot stays green).",
      goodDay: "Good day",
      regularDay: "Regular",
      badDay: "Bad day",
      luckyBadge: "🍀 Lucky day",
      solidBadge: "🎯 Solid day (no result)",
      dayDetailsSummary: "Details",
      dayDetailsTitle: "Day details",
      dayNoDataTitle: "No data",
      dayNoDataSaved: "There is no completed saved day.",
      dayNoDataTip: "Tip: finish the day so it appears here.",
      startLbl: "Start",
      endLbl: "End",
      durLbl: "Dur",
      resultLbl: "Result",
      reportModalTitle: "Day summary",
      qrTitle: "Open report on your phone",
      qrNote: "Scan the QR and send the report from your phone.",
      reportHint: "Copy or share to end the day and reset.",
      copyBtn: "Copy",
      shareBtn: "Share",
      monthDayYear: { month: "long", day: "numeric", year: "numeric" },
      monthDay: { month: "long", day: "numeric" },
      weekRangeJoin: "to",
      tabAgents: "Agents",
      agentsTitle: "Agents",
      agentsSearchPlaceholder: "Search agent",
      addAgent: "Add agent",
      addAgentByEmail: "Agent email",
      assignAgentBtn: "Assign",
      userNotFoundInTeam: "User not found in this team",
      agentAlreadyAssigned: "This agent is already assigned.",
      weekXLabel: "Week X",
      monthXLabel: "Month X",
      addAgentSaved: "Agent assigned successfully.",
      addAgentError: "Could not add agent.",
      agentsEmpty: "No assigned agents.",
      removeAgent: "Remove agent",
      removeAgentConfirm: "Remove this agent from your list?",
      removeAgentSaved: "Agent removed successfully.",
      removeAgentError: "Could not remove the agent.",
      agentTrail: "Agents",
      viewDetails: "View details",
      hideDetails: "Hide details",
      activeAgentsLabel: "Active agents",
      teamWeekSalesLabel: "Team week sales (X)",
      teamMonthSalesLabel: "Team month sales (X)",
      readOnlyManager: "Read-only (manager)",
      managerRulesNote: "Suggested rules: agents can write only own days; managers can read only assigned agents within team; assignments only under own managerUid; team data isolation required.",
      addDay: "Add day",
      addDayTitle: "Add day",
      addDaySave: "Save day",
      addDayNeedAgent: "Select an agent first.",
      addDaySaved: "Day added successfully.",
      optionalTime: "(optional)"
    }
  };

  const fmtPct = (n) => (Number.isFinite(n) ? (n * 100).toFixed(1) + "%" : "0.0%");
  const pad2 = (n) => String(n).padStart(2,"0");
  const fmtHours = (ms) => ((ms || 0) / 3600000).toFixed(1) + "h";

  function classifyDay(values = {}) {
    const S = Number(values.S || 0);
    const Z = Number(values.Z || 0);
    const X = Number(values.X || 0);
    const aggr = S > 0 ? ((Z / S) * 100) : 0;

    let dayRating = "regular";
    if ((S >= 80 && aggr >= 10) || X >= 2) dayRating = "good";
    else if ((S >= 50 && S < 80) || (S >= 80 && aggr < 10)) dayRating = "regular";
    else if (S < 50 && X === 0) dayRating = "bad";

    let dayBadge = "";
    if (S < 50 && X >= 1) dayBadge = "lucky";
    else if (S >= 80 && aggr >= 10 && X === 0) dayBadge = "solid_no_result";

    return { dayRating, dayBadge, aggr };
  }

  function ratingLabel(rating) {
    if (rating === "good") return t("goodDay");
    if (rating === "bad") return t("badDay");
    return t("regularDay");
  }

  function badgeLabel(badge) {
    if (badge === "lucky") return t("luckyBadge");
    if (badge === "solid_no_result") return t("solidBadge");
    return "";
  }

  function ratingLine(rating, badge) {
    const b = badgeLabel(badge);
    const base = ratingLabel(rating);
    return b ? `${base} · ${b}` : base;
  }

  function ratingColor(rating){
    if (rating === "good") return "#6be795";
    if (rating === "bad") return "#ff7f7f";
    return "#f6d867";
  }

  const isoDateLocal = (d = new Date()) => {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const fmtTime = (ts) => {
    if (!ts) return "—";
    const d = new Date(ts);
    let h = d.getHours();
    const m = d.getMinutes();
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${pad2(m)} ${ampm}`;
  };

  const fmtDuration = (ms) => {
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  };

  const localeForLang = () => currentLang === "es" ? "es-ES" : "en-US";

  const monthName = (y, m) => {
    const month = (t("calendarMonths") || [])[m] || "";
    return `${month} ${y}`;
  };

  function prettyDateFromISO(iso) {
    if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso || "-";
    const [y,m,d] = iso.split("-").map(Number);
    const date = new Date(y, m-1, d);
    return date.toLocaleDateString(localeForLang(), t("monthDayYear"));
  }

  function prettyDateRange(startDate, endDate) {
    const a = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const b = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
    const sameYear = a.getFullYear() === b.getFullYear();
    const left = a.toLocaleDateString(localeForLang(), t("monthDay"));
    const right = b.toLocaleDateString(localeForLang(), sameYear ? t("monthDay") : t("monthDayYear"));
    return `${left} ${t("weekRangeJoin")} ${right}`;
  }

  const startOfWeekMon = (d) => {
    const out = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = out.getDay();
    const diff = (day === 0) ? -6 : (1 - day);
    out.setDate(out.getDate() + diff);
    out.setHours(0,0,0,0);
    return out;
  };

  const endOfWeekSun = (d) => {
    const s = startOfWeekMon(d);
    const e = new Date(s);
    e.setDate(e.getDate() + 6);
    e.setHours(23,59,59,999);
    return e;
  };

  document.addEventListener("dblclick", (e) => e.preventDefault(), { passive:false });

  // ---------- History ----------
  function resolveHistoryUid() {
    return (state?.uid || window.firebaseAuth?.currentUser?.uid || "").trim();
  }

  function historyStorageKey(uid = resolveHistoryUid()) {
    return uid ? `${HISTORY_KEY_PREFIX}:${uid}` : HISTORY_KEY;
  }

  function loadHistory() {
    try {
      const h = JSON.parse(localStorage.getItem(historyStorageKey()) || "{}");
      return (h && typeof h === "object") ? h : {};
    } catch {
      return {};
    }
  }
  function saveHistory(hist) {
    try { localStorage.setItem(historyStorageKey(), JSON.stringify(hist)); } catch {}
  }
  function upsertDayInHistory(dayISO, payload) {
    const hist = loadHistory();
    hist[dayISO] = payload;
    saveHistory(hist);
  }

  function sumRecords(records) {
    const totals = { S:0, Z:0, CC:0, C:0, X:0, days:0, durationMs:0 };
    records.forEach(r => {
      totals.days += 1;
      metrics.forEach(k => totals[k] += (r.values?.[k] || 0));
      totals.durationMs += (r.durationMs || 0);
    });
    return totals;
  }

  function recordsInRange(startDate, endDate) {
    const hist = loadHistory();
    const out = [];
    const startISO = isoDateLocal(startDate);
    const endISO = isoDateLocal(endDate);

    Object.keys(hist).forEach(iso => {
      if (iso >= startISO && iso <= endISO) out.push(hist[iso]);
    });

    out.sort((a,b) => (a.date || "").localeCompare(b.date || ""));
    return out;
  }

  function recordsInMonth(year, monthIdx) {
    const start = new Date(year, monthIdx, 1);
    const end = new Date(year, monthIdx + 1, 0);
    return recordsInRange(start, end);
  }

  function historyForAgent(agentUid) {
    if (!agentUid || agentUid === state.uid) return loadHistory();
    return managerState.records[agentUid] || {};
  }

  function recordsInRangeForAgent(agentUid, startDate, endDate) {
    const hist = historyForAgent(agentUid);
    const out = [];
    const startISO = isoDateLocal(startDate);
    const endISO = isoDateLocal(endDate);
    Object.keys(hist).forEach((iso) => { if (iso >= startISO && iso <= endISO) out.push(hist[iso]); });
    out.sort((a, b) => (a.date || "").localeCompare(b.date || ""));
    return out;
  }

  function recordsInMonthForAgent(agentUid, year, monthIdx) {
    const start = new Date(year, monthIdx, 1);
    const end = new Date(year, monthIdx + 1, 0);
    return recordsInRangeForAgent(agentUid, start, end);
  }

  // ---------- Load session state ----------
  const saved = JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
  const savedProfile = JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
  const savedLang = localStorage.getItem(LANG_KEY) || localStorage.getItem(LEGACY_LANG_KEY);
  let currentLang = (savedLang === "en" || savedLang === "es") ? savedLang : "es";
  const state = {
    active: !!saved.active,
    date: saved.date || isoDateLocal(),
    rep: saved.rep || savedProfile.rep || "",
    store: saved.store || "",
    values: saved.values || {},
    sessionStart: saved.sessionStart || null,
    teamId: (typeof saved.teamId === "string" ? saved.teamId : "") || "",
    role: saved.role || "agent",
    uid: "",
  };
  metrics.forEach(k => { if (typeof state.values[k] !== "number") state.values[k] = 0; });
  const managerState = {
    selectedAgentUid: "",
    selectedAgentName: "",
    selectedAgentEmail: "",
    addDayTargetUid: "",
    addDayTargetName: "",
    list: [],
    search: "",
    monthCache: new Map(),
    records: {},
    calCursor: (() => { const d = new Date(); return { y: d.getFullYear(), m: d.getMonth() }; })(),
  };


  // ---------- DOM ----------
  const todayDateEl = document.getElementById("today_date");
  const startIntro = document.getElementById("start_intro");
  const startHeadline = document.getElementById("start_headline");
  const startHint = document.getElementById("start_hint");
  const startDayBtn = document.getElementById("start_day");
  const finishDayBtn = document.getElementById("finish_day");
  const langToggleBtn = document.getElementById("lang_toggle");
  const authLangToggleBtn = document.getElementById("auth_lang_toggle");
  const modalLanguage = document.getElementById("modal_language");
  const langEsBtn = document.getElementById("lang_es");
  const langEnBtn = document.getElementById("lang_en");

  // Tabs
  const tabEls = Array.from(document.querySelectorAll(".tab"));
  const tabCounter = document.getElementById("tab_counter");
  const tabCalendar = document.getElementById("tab_calendar");
  const tabSummary = document.getElementById("tab_summary");
  const tabAgents = document.getElementById("tab_agents");
  const tabAgentsLabel = document.getElementById("tab_agents_label");

  // Counter
  const startScreen = document.getElementById("start_screen");
  const sessionScreen = document.getElementById("session_screen");
  const list = document.getElementById("list");
  const whoLine = document.getElementById("who_line");
  const dateLine = document.getElementById("date_line");
  const timerEl = document.getElementById("timer");
  const aggrEl = document.getElementById("aggr");
  const closeEl = document.getElementById("close");

  // Calendar
  const calTitle = document.getElementById("cal_title");
  const calGrid = document.getElementById("cal_grid");
  const weekStatsEl = document.getElementById("week_stats");
  const monthStatsEl = document.getElementById("month_stats");
  const mgrCalTitle = document.getElementById("mgr_cal_title");
  const mgrCalGrid = document.getElementById("mgr_cal_grid");
  const mgrWeekStatsEl = document.getElementById("mgr_week_stats");
  const mgrMonthStatsEl = document.getElementById("mgr_month_stats");
  const agentsListEl = document.getElementById("agents_list");
  const agentsErrorEl = document.getElementById("agents_error");
  const kpiAgentsActiveEl = document.getElementById("kpi_agents_active");
  const kpiTeamWeekEl = document.getElementById("kpi_team_week");
  const kpiTeamMonthEl = document.getElementById("kpi_team_month");
  const managerAgentDetailEl = document.getElementById("manager_agent_detail");
  const managerRemoveAgentBtn = document.getElementById("manager_remove_agent_btn");

  // Summary
  const sumWrap = document.getElementById("sum_wrap");

  // Modals
  const modalStart = document.getElementById("modal_start");
  const modalProfile = document.getElementById("modal_profile");
  const modalReport = document.getElementById("modal_report");
  const modalAddAgent = document.getElementById("modal_add_agent");
  const modalAddDay = document.getElementById("modal_add_day");
  const startStore = document.getElementById("start_store");
  const startProfileName = document.getElementById("start_profile_name");
  const profileNameInput = document.getElementById("profile_name");
  const reportBox = document.getElementById("report_box");

  // QR
  const qrWrap = document.getElementById("qr_wrap");
  const qrBox = document.getElementById("qr_box");

  // Report actions
  const reportHint = document.getElementById("report_hint");
  const reportSaveStatus = document.getElementById("report_save_status");
  const reportDayRating = document.getElementById("report_day_rating");
  const endBtn = document.getElementById("end_btn");
  const copyBtn = document.getElementById("copy_btn");
  const shareBtn = document.getElementById("share_btn");

  // Day details modal
  const modalDay = document.getElementById("modal_day");
  const dayX = document.getElementById("day_x");
  const dayModalTitle = document.getElementById("day_modal_title");
  const dayModalRating = document.getElementById("day_modal_rating");
  const dayModalKpis = document.getElementById("day_modal_kpis");
  const dayModalMeta = document.getElementById("day_modal_meta");
  const dayModalReport = document.getElementById("day_modal_report");
  const dayCopyBtn = document.getElementById("day_copy");
  const dayShareBtn = document.getElementById("day_share");
  const dayAddMissingBtn = document.getElementById("day_add_missing");
  const dayEditBtn = document.getElementById("day_edit");
  const dayDeleteBtn = document.getElementById("day_delete");
  const daySaveBtn = document.getElementById("day_save");
  const dayEditGrid = document.getElementById("day_edit_grid");
  const dayEditS = document.getElementById("day_edit_s");
  const dayEditZ = document.getElementById("day_edit_z");
  const dayEditCC = document.getElementById("day_edit_cc");
  const dayEditC = document.getElementById("day_edit_c");
  const dayEditX = document.getElementById("day_edit_x");
  const finishResult = document.getElementById("finish_result");
  const modalRatingHelp = document.getElementById("modal_rating_help");

  // ---------- Save session ----------
  function saveStateNow() { localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
  function saveState() { try { saveStateNow(); } catch {} }

  function sanitizeTeamId(raw) {
    return String(raw || "").trim().toLowerCase().replace(/[^a-z0-9_-]/g, "");
  }

  function setTeamId(teamId) {
    const clean = sanitizeTeamId(teamId);
    state.teamId = clean;
    if (clean) {
      try { localStorage.setItem(TEAM_KEY, clean); } catch {}
    } else {
      try { localStorage.removeItem(TEAM_KEY); } catch {}
    }
    saveState();
    console.log("TEAM resolved", clean || "(none)");
    return clean;
  }

  async function hydrateCacheFromCloudForVisibleRanges() {
    const uid = window.firebaseAuth?.currentUser?.uid;
    if (!uid || !state.teamId || typeof window.cloudGetDaysInRange !== "function") return;

    const now = new Date();
    const monthStartISO = isoDateLocal(new Date(calCursor.y, calCursor.m, 1));
    const monthEndISO = isoDateLocal(new Date(calCursor.y, calCursor.m + 1, 0));
    const weekStartISO = isoDateLocal(startOfWeekMon(now));
    const weekEndISO = isoDateLocal(endOfWeekSun(now));

    try {
      const [monthDocs, weekDocs] = await Promise.all([
        window.cloudGetDaysInRange(state.teamId, uid, monthStartISO, monthEndISO),
        window.cloudGetDaysInRange(state.teamId, uid, weekStartISO, weekEndISO),
      ]);
      const hist = loadHistory();
      let changed = 0;
      [...monthDocs, ...weekDocs].forEach((rec) => {
        if (!rec?.date) return;
        const prev = JSON.stringify(hist[rec.date] || null);
        const next = JSON.stringify(rec);
        if (prev !== next) {
          hist[rec.date] = rec;
          changed += 1;
        }
      });
      if (changed > 0) saveHistory(hist);
      console.log(`Hydrated ${monthDocs.length + weekDocs.length} docs`);
    } catch (err) {
      console.warn("Firestore hydrate failed, using local cache", err);
    }
  }

  window.addEventListener("pagehide", () => { try { saveStateNow(); } catch {} });
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") { try { saveStateNow(); } catch {} }
  });

  function t(key) {
    return i18n[currentLang][key] || i18n.es[key] || key;
  }

  function shortLangLabel() {
    return currentLang === "en" ? "EN" : "ES";
  }

  function saveProfile(rep) {
    try {
      localStorage.setItem(PROFILE_KEY, JSON.stringify({ rep }));
    } catch {}
  }

  function applyTranslations() {
    document.documentElement.lang = currentLang;
    document.getElementById("tab_counter_label").textContent = t("tabCounter");
    document.getElementById("tab_calendar_label").textContent = t("tabCalendar");
    document.getElementById("tab_summary_label").textContent = t("tabSummary");
    document.getElementById("tab_agents_label").textContent = t("tabAgents");
    document.getElementById("today_title").textContent = t("appTitle");
    const loginTitleEl = document.getElementById("auth_login_title");
    if (loginTitleEl) loginTitleEl.textContent = t("loginTitle");
    const authEmailEl = document.getElementById("authEmail");
    const authPassEl = document.getElementById("authPass");
    if (authEmailEl) authEmailEl.placeholder = t("loginEmailPlaceholder");
    if (authPassEl) authPassEl.placeholder = t("loginPassPlaceholder");
    const authSignupBtn = document.getElementById("authSignupOpenBtn");
    if (authSignupBtn) authSignupBtn.textContent = t("signupBtn");
    const authLoginBtnText = document.getElementById("authLoginBtnText");
    if (authLoginBtnText && !document.getElementById("authLoginBtn")?.classList.contains("loading")) authLoginBtnText.textContent = t("loginBtn");
    const logoutBtn = document.getElementById("logout_btn");
    if (logoutBtn) logoutBtn.textContent = t("logoutBtn");
    const signupTitleEl = document.getElementById("signup_title");
    if (signupTitleEl) signupTitleEl.textContent = t("signupTitle");
    const signupCancelBtn = document.getElementById("signup_cancel_btn");
    if (signupCancelBtn) signupCancelBtn.textContent = t("cancel");
    const signupCreateBtn = document.getElementById("signupCreateBtn");
    if (signupCreateBtn && !signupCreateBtn.disabled) signupCreateBtn.textContent = t("signupBtn");
    startHeadline.textContent = t("startHeadline");
    startIntro.textContent = t("startIntro");
    startHint.textContent = t("startHint");
    startDayBtn.textContent = t("startDay");
    finishDayBtn.textContent = t("finishDay");
    document.getElementById("start_modal_title").textContent = t("startModalTitle");
    document.getElementById("start_modal_intro").textContent = t("startModalIntro");
    document.getElementById("start_store_label").textContent = t("storeLabel");
    document.getElementById("start_cancel").textContent = t("cancel");
    document.getElementById("start_confirm").textContent = t("start");
    document.getElementById("profile_modal_title").textContent = t("profileTitle");
    document.getElementById("profile_name_label").textContent = t("nameLabel");
    document.getElementById("profile_save").textContent = t("profileSave");
    document.getElementById("profile_reset").textContent = t("profileReset");
    langToggleBtn.textContent = shortLangLabel();
    if (authLangToggleBtn) authLangToggleBtn.textContent = shortLangLabel();
    langToggleBtn.title = t("languageBtn");
    if (authLangToggleBtn) authLangToggleBtn.title = t("languageBtn");
    document.getElementById("lang_modal_title").textContent = t("languageModalTitle");
    document.getElementById("lang_modal_intro").textContent = t("languageModalIntro");
    langEsBtn.textContent = t("languageSpanish");
    langEnBtn.textContent = t("languageEnglish");
    langEsBtn.classList.toggle("langChoiceActive", currentLang === "es");
    langEnBtn.classList.toggle("langChoiceActive", currentLang === "en");
    document.querySelector(".t1").textContent = t("session");
    document.getElementById("rating_help_title").textContent = t("dayRatingRules");
    document.getElementById("day_details_summary").textContent = t("dayDetailsSummary");
    document.getElementById("report_modal_title").textContent = t("reportModalTitle");
    document.getElementById("qr_title").textContent = t("qrTitle");
    document.getElementById("qr_note").textContent = t("qrNote");
    document.getElementById("report_hint").textContent = t("reportHint");
    copyBtn.textContent = t("copyBtn");
    shareBtn.textContent = t("shareBtn");

    const agentsAddBtnEl = document.getElementById("agents_add_btn");
    if (agentsAddBtnEl) agentsAddBtnEl.innerHTML = `<span class="plus">+</span>${t("addAgent")}`;
    const agentsSectionTitleEl = document.getElementById("agents_section_title");
    if (agentsSectionTitleEl) agentsSectionTitleEl.textContent = t("agentsTitle");
    const agentsKpiActiveLabelEl = document.getElementById("agents_kpi_active_label");
    if (agentsKpiActiveLabelEl) agentsKpiActiveLabelEl.textContent = t("activeAgentsLabel");
    const agentsKpiWeekLabelEl = document.getElementById("agents_kpi_week_label");
    if (agentsKpiWeekLabelEl) agentsKpiWeekLabelEl.textContent = t("teamWeekSalesLabel");
    const agentsKpiMonthLabelEl = document.getElementById("agents_kpi_month_label");
    if (agentsKpiMonthLabelEl) agentsKpiMonthLabelEl.textContent = t("teamMonthSalesLabel");
    const addAgentTitleEl = document.getElementById("add_agent_title");
    if (addAgentTitleEl) addAgentTitleEl.textContent = t("addAgent");
    const addAgentEmailLabelEl = document.getElementById("add_agent_email_label");
    if (addAgentEmailLabelEl) addAgentEmailLabelEl.textContent = t("addAgentByEmail");
    const addAgentCancelEl = document.getElementById("add_agent_cancel");
    if (addAgentCancelEl) addAgentCancelEl.textContent = t("cancel");
    const addAgentConfirmEl = document.getElementById("add_agent_confirm");
    if (addAgentConfirmEl) addAgentConfirmEl.textContent = t("assignAgentBtn");
    const addDayTitleEl = document.getElementById("add_day_title");
    if (addDayTitleEl) addDayTitleEl.textContent = t("addDayTitle");
    const addDayDateLabelEl = document.getElementById("add_day_date_label");
    if (addDayDateLabelEl) addDayDateLabelEl.textContent = t("date");
    const addDayRepLabelEl = document.getElementById("add_day_rep_label");
    if (addDayRepLabelEl) addDayRepLabelEl.textContent = t("nameLabel");
    const addDayStoreLabelEl = document.getElementById("add_day_store_label");
    if (addDayStoreLabelEl) addDayStoreLabelEl.textContent = t("storeLabel");
    const addDayStartLabelEl = document.getElementById("add_day_start_label");
    if (addDayStartLabelEl) addDayStartLabelEl.textContent = `${t("startLbl")} ${t("optionalTime")}`;
    const addDayEndLabelEl = document.getElementById("add_day_end_label");
    if (addDayEndLabelEl) addDayEndLabelEl.textContent = `${t("endLbl")} ${t("optionalTime")}`;
    const addDayCancelEl = document.getElementById("add_day_cancel");
    if (addDayCancelEl) addDayCancelEl.textContent = t("cancel");
    const addDayConfirmEl = document.getElementById("add_day_confirm");
    if (addDayConfirmEl) addDayConfirmEl.textContent = t("addDaySave");
    endBtn.textContent = t("endDayNow");
    dayCopyBtn.textContent = t("copyBtn");
    dayShareBtn.textContent = t("shareBtn");
    if (dayAddMissingBtn) dayAddMissingBtn.textContent = t("addDay");
    if (managerRemoveAgentBtn) managerRemoveAgentBtn.textContent = t("removeAgent");
    document.getElementById("rating_help_body").innerHTML = `
      <div style="font-weight:700; margin-bottom:8px;">${t("quickCriteria")}</div>
      <ul style="margin:0 0 10px 18px; padding:0;">
        <li>${t("goodDayRule")}</li>
        <li>${t("regularDayRule")}</li>
        <li>${t("badDayRule")}</li>
      </ul>
      <div style="font-weight:700; margin-bottom:8px;">${t("specialBadges")}</div>
      <ul style="margin:0 0 0 18px; padding:0;">
        <li>${t("luckyDayRule")}</li>
        <li>${t("solidDayRule")}</li>
      </ul>
    `;
    renderHeader();
    if (state.active) renderSessionInfo();
  }

  function setLanguage(lang) {
    currentLang = lang === "en" ? "en" : "es";
    try { localStorage.setItem(LANG_KEY, currentLang); } catch {}
    try { localStorage.removeItem(LEGACY_LANG_KEY); } catch {}
    closeModal(modalLanguage);
    applyTranslations();
    renderCalendarStats();
    renderProgress();
  }

  // ---------- UI ----------
  const valEls = {};
  function renderHeader() {
    todayDateEl.textContent = `${t("date")}: ${prettyDateFromISO(state.date)}`;
  }

  function renderSessionInfo() {
    whoLine.textContent = `${state.rep || "—"} • ${state.store || "—"}`;
    dateLine.textContent = `${t("day")}: ${prettyDateFromISO(state.date)} • ${t("begins")}: ${fmtTime(state.sessionStart)}`;
  }

  function renderMetrics() {
    list.innerHTML = "";
    metrics.forEach(k => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="label">${k}</div>
        <div class="pill">
          <button aria-label="minus ${k}" data-k="${k}" data-d="-1">−</button>
          <div class="sep"></div>
          <div class="val" id="v_${k}">${state.values[k]}</div>
          <div class="sep"></div>
          <button aria-label="plus ${k}" data-k="${k}" data-d="1">+</button>
        </div>
      `;
      list.appendChild(row);
    });
    metrics.forEach(k => { valEls[k] = document.getElementById("v_" + k); });
  }

  function renderIndicators() {
    const S = state.values.S;
    const Z = state.values.Z;
    const X = state.values.X;

    if (S >= AGGR_MIN_STOPS) aggrEl.textContent = fmtPct(S > 0 ? (Z / S) : 0);
    else aggrEl.textContent = `— (min ${AGGR_MIN_STOPS} S)`;

    closeEl.textContent = fmtPct(Z > 0 ? (X / Z) : 0);
  }

  function showStartScreen() {
    state.active = false;
    startScreen.style.display = "";
    sessionScreen.style.display = "none";
    renderHeader();
  }

  function showSessionScreen() {
    startScreen.style.display = "none";
    sessionScreen.style.display = "";
    renderHeader();
    renderSessionInfo();
    renderMetrics();
    renderIndicators();
  }

  // ---------- Timer ----------
  let timerInterval = null;
  function startTimerLoop() {
    stopTimerLoop();
    timerInterval = setInterval(() => {
      if (!state.active || !state.sessionStart) return;
      timerEl.textContent = fmtDuration(Date.now() - state.sessionStart);
    }, 1000);

    if (state.active && state.sessionStart) timerEl.textContent = fmtDuration(Date.now() - state.sessionStart);
    else timerEl.textContent = "00:00:00";
  }
  function stopTimerLoop() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
  }

  // ---------- Modals helpers ----------
  function openModal(el) { el.classList.add("show"); }
  function closeModal(el) { el.classList.remove("show"); }

  function clickOutsideToClose(overlayEl, allow) {
    overlayEl.addEventListener("click", (e) => {
      if (!allow) return;
      if (e.target === overlayEl) closeModal(overlayEl);
    });
  }
  clickOutsideToClose(modalStart, true);
  clickOutsideToClose(modalProfile, true);
  clickOutsideToClose(modalReport, false);
  clickOutsideToClose(modalAddAgent, true);
  clickOutsideToClose(modalAddDay, true);
  clickOutsideToClose(modalDay, true);
  clickOutsideToClose(modalRatingHelp, true);
  dayX.addEventListener("click", () => closeModal(modalDay));
  document.getElementById("rating_help_x").addEventListener("click", () => closeModal(modalRatingHelp));

  // ---------- Session logic ----------
  function startDay(rep, store) {
    finishResult.textContent = "";
    reportDayRating.style.display = "none";
    reportDayRating.textContent = "";
    state.date = isoDateLocal();
    state.rep = rep;
    state.store = store;
    metrics.forEach(k => state.values[k] = 0);
    state.sessionStart = Date.now();
    state.active = true;
    saveStateNow();
    showSessionScreen();
    startTimerLoop();
  }

  function buildReportText(dayData) {
    const values = dayData?.values || {};
    const S = Number(values.S || 0);
    const Z = Number(values.Z || 0);
    const CC = Number(values.CC || 0);
    const C = Number(values.C || 0);
    const X = Number(values.X || 0);

    const aggr = (S >= AGGR_MIN_STOPS && S > 0) ? (Z / S) : null;
    const close = (Z > 0) ? (X / Z) : null;

    const aggrLine = (aggr !== null)
      ? `% Aggressiveness (Z/S): ${fmtPct(aggr)}`
      : `% Aggressiveness (Z/S): — (min ${AGGR_MIN_STOPS} S)`;

    const closeLine = (close !== null)
      ? `% Close (X/Z): ${fmtPct(close)}`
      : `% Close (X/Z): —`;

    const hasTime = Number(dayData?.startTs || 0) > 0 || Number(dayData?.endTs || 0) > 0 || Number(dayData?.durationMs || 0) > 0;
    const timeLines = hasTime
      ? [`Start: ${fmtTime(dayData?.startTs)}`, `End: ${fmtTime(dayData?.endTs)}`, `Duration: ${fmtDuration(dayData?.durationMs || 0)}`, ``]
      : [];

    return [
      `Name: ${dayData?.rep || "-"}`,
      `Store: ${dayData?.store || "-"}`,
      `Date: ${prettyDateFromISO(dayData?.date || "-")}`,
      ``,
      ...timeLines,
      `S: ${S} | Z: ${Z} | CC: ${CC} | C: ${C} | X: ${X}`,
      aggrLine,
      closeLine
    ].join("\n");
  }

  function buildReport(endTs) {
    const startTs = state.sessionStart || endTs;
    return buildReportText({
      date: state.date,
      rep: state.rep || "",
      store: state.store || "",
      startTs,
      endTs,
      durationMs: Math.max(0, endTs - startTs),
      values: { ...state.values },
    });
  }

  async function persistCompletedDay(endTs, reportText) {
    const startTs = state.sessionStart || endTs;
    const ratingInfo = classifyDay(state.values);
    const payload = {
      date: state.date,
      rep: state.rep || "",
      store: state.store || "",
      startTs,
      endTs,
      durationMs: Math.max(0, endTs - startTs),
      values: { ...state.values },
      money: (state.values.X || 0) * MONEY_PER_X,
      reportText: reportText || "",
      dayRating: ratingInfo.dayRating,
      dayBadge: ratingInfo.dayBadge
    };
    const hist = loadHistory();
    hist[state.date] = payload;
    saveHistory(hist);

    const uid = window.firebaseAuth?.currentUser?.uid;
    if (!uid) {
      console.warn("Firestore day save skipped: missing uid");
      return { localSaved: true, cloudSaved: false, reason: "missing-uid" };
    }

    if (!state.teamId && typeof window.resolveTeamIdForUser === "function") {
      try {
        const resolvedTeamId = await window.resolveTeamIdForUser(uid);
        if (resolvedTeamId) setTeamId(resolvedTeamId);
      } catch (e) {
        console.warn("Unable to resolve teamId before day write", e);
      }
    }

    if (!state.teamId) {
      console.warn("Firestore day save skipped: missing teamId", { uid, teamId: state.teamId });
      return { localSaved: true, cloudSaved: false, reason: "missing-team" };
    }

    try {
      if (typeof window.ensureTeamMembership === "function") {
        await window.ensureTeamMembership(state.teamId, uid);
      }
      const res = await window.cloudUpsertDay(state.teamId, uid, state.date, payload);
      console.log("Saved day:", state.date, payload);
      console.log("Saved to Firestore", res?.path || "-");
      return { localSaved: true, cloudSaved: true, path: res?.path || "" };
    } catch (err) {
      console.error("Firestore save failed", err);
      const reason = `${err?.code || ""} ${err?.message || err}`.trim();
      console.error("Firestore save failed (actionable): check Firestore Rules/Auth/Network.", reason);
      return { localSaved: true, cloudSaved: false, error: err };
    }
  }

  function finalizeAndReset() {
    state.active = false;
    finishResult.textContent = "";
    reportDayRating.style.display = "none";
    reportDayRating.textContent = "";
    state.store = "";
    state.sessionStart = null;
    state.date = isoDateLocal();
    metrics.forEach(k => state.values[k] = 0);
    saveStateNow();
    stopTimerLoop();
    timerEl.textContent = "00:00:00";
    closeModal(modalReport);
    showStartScreen();
    renderCalendar();
    renderProgress();
  }

  function setReportMode(mode) {
    const isPhone = mode === "phone";
    console.log("setReportMode", mode, { isPhone });
    copyBtn.style.display = isPhone ? "" : "none";
    shareBtn.style.display = isPhone ? "" : "none";
    reportHint.style.display = isPhone ? "" : "none";
    endBtn.style.display = isPhone ? "none" : "";
    if (reportSaveStatus && !isPhone) reportSaveStatus.textContent = "";
  }

  // ---------- QR ----------
  function makeShareUrlFromReport(text) {
    const payload = LZString.compressToEncodedURIComponent(text);
    return `${location.origin}${location.pathname}#r=${payload}`;
  }

  function showQRForText(text) {
    qrBox.innerHTML = "";
    qrWrap.style.display = "";
    const url = makeShareUrlFromReport(text);
    new QRCode(qrBox, { text: url, width: 176, height: 176, correctLevel: QRCode.CorrectLevel.L });
  }

  function tryLoadReportFromHash() {
    const h = location.hash || "";
    if (!h.startsWith("#r=")) return false;
    try {
      const payload = h.slice(3);
      const text = LZString.decompressFromEncodedURIComponent(payload);
      if (!text) return false;
      reportBox.textContent = text;
      qrWrap.style.display = "none";
      setReportMode("phone");
      openModal(modalReport);
      return true;
    } catch {
      return false;
    }
  }

  // ---------- Day details modal logic ----------
  function buildFullReportFromRecord(rec){
    if (!rec) return "No data for this day.";
    return buildReportText(rec);
  }

  function openManagerAddDayModal({ dateISO = isoDateLocal(), agentUid = "", agentName = "" } = {}) {
    const msg = document.getElementById("add_day_msg");
    const modalBody = document.querySelector("#modal_add_day .modalBody");
    managerState.addDayTargetUid = agentUid || managerState.selectedAgentUid || state.uid;
    managerState.addDayTargetName = agentName || managerState.selectedAgentName || state.rep || "";
    if (msg) msg.textContent = "";
    if (modalBody) modalBody.scrollTop = 0;
    document.getElementById("add_day_date").value = dateISO;
    document.getElementById("add_day_rep").value = managerState.addDayTargetName || "";
    document.getElementById("add_day_store").value = "";
    document.getElementById("add_day_start").value = "";
    document.getElementById("add_day_end").value = "";
    ["s","z","cc","c","xv"].forEach((k) => { const el = document.getElementById(`add_day_${k}`); if (el) el.value = "0"; });
    openModal(modalAddDay);
  }

  function openDayModal(iso, agentUid = state.uid){
    const hist = historyForAgent(agentUid);
    const rec = hist[iso];
    activeDayISO = iso;
    activeDayAgentUid = agentUid || state.uid;

    dayModalTitle.textContent = rec ? `${t("dayDetailsTitle")} • ${prettyDateFromISO(iso)}` : `${t("dayNoDataTitle")} • ${prettyDateFromISO(iso)}`;
    dayEditGrid.style.display = "none";
    daySaveBtn.style.display = "none";
    dayEditBtn.textContent = "Editar día";
    const isReadOnly = agentUid !== state.uid;

    if (!rec){
      dayModalRating.innerHTML = "";
      dayModalKpis.innerHTML = "";
      dayModalMeta.innerHTML = `
        <div class="statHead">
          <div class="h">${t("dayNoDataSaved")}</div>
          <div class="p">${t("dayNoDataTip")}</div>
        </div>
      `;
      dayModalReport.textContent = "—";
      dayCopyBtn.style.display = "none";
      dayShareBtn.style.display = "none";
      if (dayAddMissingBtn) dayAddMissingBtn.style.display = state.role === "manager" ? "" : "none";
      dayEditBtn.style.display = "none";
      dayDeleteBtn.style.display = "none";
      openModal(modalDay);
      return;
    }

    const X = rec.values?.X ?? 0;
    const ratingInfo = classifyDay(rec.values || {});
    const rating = rec.dayRating || ratingInfo.dayRating;
    const badge = rec.dayBadge ?? ratingInfo.dayBadge;

    dayModalRating.innerHTML = `
      <div class="dayRatingPill ${rating}">
        <span class="dayRatingDot"></span>
        <span>${ratingLabel(rating)}</span>
      </div>
      ${badge ? `<div class="dayBadgeMini">${badgeLabel(badge)}</div>` : ""}
    `;

    dayModalKpis.innerHTML = ["S","Z","CC","C","X"].map(k => `
      <div class="dayMetricChip">
        <div class="k">${k}</div>
        <div class="v">${rec.values?.[k] ?? 0}</div>
      </div>
    `).join("");

    const hasTimeMeta = Number(rec.startTs || 0) > 0 || Number(rec.endTs || 0) > 0 || Number(rec.durationMs || 0) > 0;
    const timeMetaLine = hasTimeMeta
      ? `<div class="p">${t("startLbl")}: ${fmtTime(rec.startTs)} • ${t("endLbl")}: ${fmtTime(rec.endTs)} • ${t("durLbl")}: ${fmtDuration(rec.durationMs || 0)}</div>`
      : "";
    dayModalMeta.innerHTML = `
      <div class="statHead">
        <div>
          <div class="h">${rec.rep || "—"} • ${rec.store || "—"}</div>
          ${timeMetaLine}
          <div class="p">${t("resultLbl")}: ${ratingLine(rating, badge)}</div>
        </div>
      </div>
    `;

    dayEditS.value = rec.values?.S ?? 0;
    dayEditZ.value = rec.values?.Z ?? 0;
    dayEditCC.value = rec.values?.CC ?? 0;
    dayEditC.value = rec.values?.C ?? 0;
    dayEditX.value = rec.values?.X ?? 0;

    dayModalReport.textContent = buildFullReportFromRecord(rec);
    dayCopyBtn.style.display = "";
    dayShareBtn.style.display = "";
    if (dayAddMissingBtn) dayAddMissingBtn.style.display = "none";
    dayEditBtn.style.display = isReadOnly ? "none" : "";
    dayDeleteBtn.style.display = (isReadOnly && state.role !== "manager") ? "none" : "";
    if (isReadOnly) dayModalMeta.innerHTML += `<div class="p" style="margin-top:6px;">${t("readOnlyManager")}</div>`;
    openModal(modalDay);
  }

  async function copyOrShareText(text, kind){
    if (!text) return;

    if (kind === "share" && navigator.share) {
      await navigator.share({ title: "KPI Day", text });
      return;
    }

    if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(text);
      alert(kind === "share" ? "No native Share here. Copied to clipboard." : "Copied.");
    } else {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("Copied.");
    }
  }

  dayCopyBtn.addEventListener("click", async () => { try { await copyOrShareText(dayModalReport.textContent, "copy"); } catch {} });
  dayShareBtn.addEventListener("click", async () => { try { await copyOrShareText(dayModalReport.textContent, "share"); } catch {} });
  dayAddMissingBtn?.addEventListener("click", () => {
    if (!activeDayISO || !activeDayAgentUid || state.role !== "manager") return;
    closeModal(modalDay);
    const isOwnDay = activeDayAgentUid === state.uid;
    openManagerAddDayModal({
      dateISO: activeDayISO,
      agentUid: activeDayAgentUid,
      agentName: isOwnDay ? (state.rep || "") : (managerState.selectedAgentName || ""),
    });
  });

  dayEditBtn.addEventListener("click", () => {
    const detailsPanel = document.getElementById("day_details_panel");
    if (dayEditGrid.style.display === "none") {
      dayEditGrid.style.display = "grid";
      daySaveBtn.style.display = "";
      dayEditBtn.textContent = "Cancelar edición";
      if (detailsPanel) detailsPanel.open = false;
    } else {
      dayEditGrid.style.display = "none";
      daySaveBtn.style.display = "none";
      dayEditBtn.textContent = "Editar día";
      if (detailsPanel) detailsPanel.open = true;
    }
  });

  daySaveBtn.addEventListener("click", async () => {
    if (!activeDayISO || activeDayAgentUid !== state.uid) return;
    const hist = loadHistory();
    const rec = hist[activeDayISO];
    if (!rec) return;
    const n = (v) => Math.max(0, parseInt(v || 0, 10) || 0);
    rec.values = {
      ...rec.values,
      S: n(dayEditS.value),
      Z: n(dayEditZ.value),
      CC: n(dayEditCC.value),
      C: n(dayEditC.value),
      X: n(dayEditX.value),
    };
    rec.money = (rec.values.X || 0) * MONEY_PER_X;
    const ratingInfo = classifyDay(rec.values || {});
    rec.dayRating = ratingInfo.dayRating;
    rec.dayBadge = ratingInfo.dayBadge;
    upsertDayInHistory(activeDayISO, rec);
    const uid = window.firebaseAuth?.currentUser?.uid;
    if (uid && state.teamId && typeof window.cloudUpsertDay === "function") {
      try {
        await window.cloudUpsertDay(state.teamId, uid, activeDayISO, rec);
      } catch (err) {
        console.warn("Firestore write failed, using local cache", err);
      }
    }
    renderCalendar();
    renderCalendarStats();
    renderProgress();
    openDayModal(activeDayISO);
  });

  dayDeleteBtn.addEventListener("click", async () => {
    if (!activeDayISO || !activeDayAgentUid) return;
    const canDeleteOwn = activeDayAgentUid === state.uid;
    const canDeleteAsManager = state.role === "manager";
    if (!canDeleteOwn && !canDeleteAsManager) return;
    if (!confirm(`¿Borrar el día ${activeDayISO}?`)) return;

    if (canDeleteOwn) {
      const hist = loadHistory();
      delete hist[activeDayISO];
      saveHistory(hist);
    } else {
      managerState.records[activeDayAgentUid] = managerState.records[activeDayAgentUid] || {};
      delete managerState.records[activeDayAgentUid][activeDayISO];
      managerState.monthCache.delete(`${activeDayAgentUid}:${managerState.calCursor.y}-${managerState.calCursor.m}`);
    }

    if (state.teamId && typeof window.cloudDeleteDay === "function") {
      try {
        await window.cloudDeleteDay(state.teamId, activeDayAgentUid, activeDayISO);
      } catch (err) {
        console.warn("Firestore write failed, using local cache", err);
      }
    }

    closeModal(modalDay);
    if (canDeleteOwn) {
      renderCalendar();
      renderCalendarStats();
      renderProgress();
    } else {
      await renderManagerAgentCalendar();
      await renderManagerAgentsList();
    }
  });

  // ---------- Metrics interactions ----------
  function bump(k, d) {
    const prev = state.values[k];
    const next = Math.max(0, prev + d);
    if (next === prev) return;
    state.values[k] = next;
    valEls[k].textContent = next;
    renderIndicators();
    saveState();
  }

  let holdTimer = null;
  let holdInterval = null;
  function startHold(k, d) {
    bump(k, d);
    holdTimer = setTimeout(() => { holdInterval = setInterval(() => bump(k, d), 90); }, 250);
  }
  function stopHold() {
    clearTimeout(holdTimer); holdTimer = null;
    clearInterval(holdInterval); holdInterval = null;
  }

  document.addEventListener("pointerdown", (e) => {
    if (!state.active) return;
    const b = e.target.closest("button[data-k]");
    if (!b) return;
    e.preventDefault();
    startHold(b.dataset.k, Number(b.dataset.d));
  }, { passive:false });

  document.addEventListener("pointerup", stopHold);
  document.addEventListener("pointercancel", stopHold);
  document.addEventListener("pointerleave", stopHold);
  window.addEventListener("blur", stopHold);
  document.addEventListener("visibilitychange", () => { if (document.visibilityState === "hidden") stopHold(); });


  async function loadManagerAgents() {
    const managerUid = state.uid;
    if (!state.teamId || !managerUid || state.role !== "manager" || typeof window.cloudListAssignedAgents !== "function") return;
    try {
      managerState.list = await window.cloudListAssignedAgents(state.teamId, managerUid);
      console.log("agents list loaded", managerState.list.length);
      renderManagerAgentsList();
    } catch (err) {
      agentsErrorEl.textContent = String(err?.message || err);
    }
  }

  async function ensureManagerAgentMonth(agentUid, y, m) {
    if (!agentUid || typeof window.cloudGetDaysInRange !== "function") return;
    const key = `${agentUid}:${y}-${m}`;
    if (managerState.monthCache.has(key)) return;
    const startISO = isoDateLocal(new Date(y, m, 1));
    const endISO = isoDateLocal(new Date(y, m + 1, 0));
    const docs = await window.cloudGetDaysInRange(state.teamId, agentUid, startISO, endISO);
    managerState.records[agentUid] = managerState.records[agentUid] || {};
    docs.forEach((d) => { if (d?.date) managerState.records[agentUid][d.date] = d; });
    managerState.monthCache.set(key, true);
    console.log("agent month days fetched", { agentUid, startISO, endISO, count: docs.length });
  }

  async function renderManagerAgentsList() {
    const q = (managerState.search || "").toLowerCase();
    const filtered = managerState.list.filter((a) => (a.displayName || "").toLowerCase().includes(q) || (a.email || "").toLowerCase().includes(q) || (a.uid || "").toLowerCase().includes(q));

    if (managerState.selectedAgentUid && !filtered.some((agent) => agent.uid === managerState.selectedAgentUid)) {
      managerState.selectedAgentUid = "";
      managerState.selectedAgentName = "";
      managerState.selectedAgentEmail = "";
      if (managerRemoveAgentBtn) managerRemoveAgentBtn.style.display = "none";
      managerAgentDetailEl.style.display = "none";
    }

    agentsListEl.innerHTML = "";

    const now = new Date();
    let totalWeekX = 0;
    let totalMonthX = 0;
    const rowsData = [];

    for (const agent of filtered) {
      await ensureManagerAgentMonth(agent.uid, now.getFullYear(), now.getMonth());
      const weekTotals = sumRecords(recordsInRangeForAgent(agent.uid, startOfWeekMon(now), endOfWeekSun(now)));
      const monthTotals = sumRecords(recordsInMonthForAgent(agent.uid, now.getFullYear(), now.getMonth()));
      const weekX = weekTotals.X || 0;
      const monthX = monthTotals.X || 0;
      totalWeekX += weekX;
      totalMonthX += monthX;
      rowsData.push({ agent, weekX, monthX });
    }

    if (kpiAgentsActiveEl) kpiAgentsActiveEl.textContent = String(filtered.length);
    if (kpiTeamWeekEl) kpiTeamWeekEl.textContent = String(totalWeekX);
    if (kpiTeamMonthEl) kpiTeamMonthEl.textContent = String(totalMonthX);

    if (!filtered.length) {
      agentsListEl.innerHTML = `<div class="statCard">${t("agentsEmpty")}</div>`;
      return;
    }

    rowsData.sort((a,b) => b.monthX - a.monthX);
    for (const rowData of rowsData) {
      const agent = rowData.agent;
      const row = document.createElement("div");
      const selected = managerState.selectedAgentUid === agent.uid;
      row.className = `managerAgentCard ${selected ? "active" : ""}`;
      row.setAttribute("role", "button");
      row.setAttribute("tabindex", "0");
      row.setAttribute("aria-expanded", selected ? "true" : "false");
      row.innerHTML = `
        <div class="managerAgentName">${agent.displayName || agent.email || agent.uid}</div>
        <div class="managerAgentEmail">${agent.email || ""}</div>
        <div class="managerAgentMetrics">
          <div>
            <div class="managerMetricLabel">${t("weekXLabel")}</div>
            <div class="managerMetricValue ${rowData.weekX > 10 ? "highlight" : ""}">${rowData.weekX}</div>
          </div>
          <div>
            <div class="managerMetricLabel">${t("monthXLabel")}</div>
            <div class="managerMetricValue">${rowData.monthX}</div>
          </div>
          <div class="managerMetricLink">${selected ? t("hideDetails") : t("viewDetails")}</div>
        </div>`;

      const toggleCard = async () => {
        const shouldCollapse = managerState.selectedAgentUid === agent.uid;
        if (shouldCollapse) {
          managerState.selectedAgentUid = "";
          managerState.selectedAgentName = "";
          managerState.selectedAgentEmail = "";
          managerAgentDetailEl.style.display = "none";
          if (managerRemoveAgentBtn) managerRemoveAgentBtn.style.display = "none";
          await renderManagerAgentsList();
          return;
        }

        managerState.selectedAgentUid = agent.uid;
        managerState.selectedAgentName = agent.displayName || agent.email || agent.uid;
        managerState.selectedAgentEmail = agent.email || "";
        managerState.addDayTargetUid = agent.uid;
        managerState.addDayTargetName = managerState.selectedAgentName;
        if (managerRemoveAgentBtn) managerRemoveAgentBtn.style.display = "";
        await renderManagerAgentsList();
      };

      row.addEventListener("click", async (ev) => {
        if (ev.target.closest("#manager_agent_detail")) return;
        await toggleCard();
      });
      row.addEventListener("keydown", async (ev) => {
        if (ev.key !== "Enter" && ev.key !== " ") return;
        ev.preventDefault();
        await toggleCard();
      });

      agentsListEl.appendChild(row);

      if (selected) {
        row.appendChild(managerAgentDetailEl);
        managerAgentDetailEl.style.display = "";
        await renderManagerAgentCalendar();
      }
    }
  }

  async function renderManagerAgentCalendar() {
    if (!managerState.selectedAgentUid) return;
    await ensureManagerAgentMonth(managerState.selectedAgentUid, managerState.calCursor.y, managerState.calCursor.m);
    renderCalendarCore({
      y: managerState.calCursor.y,
      m: managerState.calCursor.m,
      titleEl: mgrCalTitle,
      gridEl: mgrCalGrid,
      selectedISO: selectedDayISO,
      agentUid: managerState.selectedAgentUid,
      onClick: (iso) => { selectedDayISO = iso; openDayModal(iso, managerState.selectedAgentUid); renderManagerAgentCalendar(); },
    });
    const now = new Date();
    const weekTotals = sumRecords(recordsInRangeForAgent(managerState.selectedAgentUid, startOfWeekMon(now), endOfWeekSun(now)));
    const monthTotals = sumRecords(recordsInMonthForAgent(managerState.selectedAgentUid, managerState.calCursor.y, managerState.calCursor.m));
    renderCompactStatCard(mgrWeekStatsEl, t("weekStatsTitle"), weekTotals);
    renderCompactStatCard(mgrMonthStatsEl, t("monthStatsTitle"), monthTotals);
  }

  function renderManagerAgentsTab() {
    if (state.role !== "manager") return;
    renderManagerAgentsList();
  }

  // ---------- Tabs logic ----------
  function setActiveTab(tabName) {
    const nextTab = (tabName === "agents" && state.role !== "manager") ? "counter" : tabName;
    tabEls.forEach(t => {
      const tabValue = t.dataset.tab;
      const canShow = (tabValue !== "agents") || state.role === "manager";
      t.style.display = canShow ? "" : "none";
      t.classList.toggle("active", tabValue === nextTab);
    });
    tabCounter.style.display = (nextTab === "counter") ? "" : "none";
    tabCalendar.style.display = (nextTab === "calendar") ? "" : "none";
    tabSummary.style.display = (nextTab === "summary") ? "" : "none";
    if (tabAgents) tabAgents.style.display = (nextTab === "agents" && state.role === "manager") ? "" : "none";
    if (nextTab === "calendar") renderCalendar();
    if (nextTab === "summary") renderProgress();
    if (nextTab === "agents") renderManagerAgentsTab();
  }

  window.setActiveTab = setActiveTab;
  window.loadManagerAgents = loadManagerAgents;

  document.getElementById("tabs").addEventListener("click", (e) => {
    const t = e.target.closest(".tab");
    if (!t) return;
    setActiveTab(t.dataset.tab);
  });


  document.getElementById("mgr_cal_prev")?.addEventListener("click", async () => {
    managerState.calCursor.m -= 1;
    if (managerState.calCursor.m < 0) { managerState.calCursor.m = 11; managerState.calCursor.y -= 1; }
    await renderManagerAgentCalendar();
  });
  document.getElementById("mgr_cal_next")?.addEventListener("click", async () => {
    managerState.calCursor.m += 1;
    if (managerState.calCursor.m > 11) { managerState.calCursor.m = 0; managerState.calCursor.y += 1; }
    await renderManagerAgentCalendar();
  });
  async function removeSelectedManagerAgent() {
    const agentUid = managerState.selectedAgentUid;
    if (!agentUid) return;
    if (!confirm(t("removeAgentConfirm"))) return;
    try {
      await window.cloudRemoveAssignedAgent(state.teamId, state.uid, agentUid);
      managerState.list = managerState.list.filter((a) => a.uid !== agentUid);
      delete managerState.records[agentUid];
      managerState.monthCache = new Map(Array.from(managerState.monthCache.entries()).filter(([k]) => !k.startsWith(`${agentUid}:`)));
      managerState.selectedAgentUid = "";
      managerState.selectedAgentName = "";
      managerState.selectedAgentEmail = "";
      managerAgentDetailEl.style.display = "none";
      if (managerRemoveAgentBtn) managerRemoveAgentBtn.style.display = "none";
      agentsErrorEl.textContent = t("removeAgentSaved");
      await renderManagerAgentsList();
    } catch (err) {
      agentsErrorEl.textContent = `${t("removeAgentError")} ${String(err?.message || err)}`;
    }
  }

  managerRemoveAgentBtn?.addEventListener("click", removeSelectedManagerAgent);

  document.getElementById("agents_add_btn")?.addEventListener("click", () => openModal(modalAddAgent));
  document.getElementById("add_agent_x")?.addEventListener("click", () => closeModal(modalAddAgent));
  document.getElementById("add_agent_cancel")?.addEventListener("click", () => closeModal(modalAddAgent));
  document.getElementById("add_agent_confirm")?.addEventListener("click", async () => {
    const email = (document.getElementById("add_agent_email")?.value || "").trim().toLowerCase();
    const msg = document.getElementById("add_agent_msg");
    if (!email) { if (msg) msg.textContent = t("addAgentError"); return; }
    try {
      const result = await window.cloudAssignAgentToManagerByEmail(state.teamId, state.uid, email);
      if (msg) msg.textContent = result?.alreadyAssigned ? t("agentAlreadyAssigned") : t("addAgentSaved");
      await loadManagerAgents();
    } catch (e) {
      if (msg) msg.textContent = `${t("addAgentError")} ${e?.message || e}`;
    }
  });

  document.getElementById("add_day_x")?.addEventListener("click", () => closeModal(modalAddDay));
  document.getElementById("add_day_cancel")?.addEventListener("click", () => closeModal(modalAddDay));
  document.getElementById("add_day_confirm")?.addEventListener("click", async () => {
    const msg = document.getElementById("add_day_msg");
    const agentUid = managerState.addDayTargetUid || managerState.selectedAgentUid;
    if (!agentUid) { if (msg) msg.textContent = t("addDayNeedAgent"); return; }
    const date = (document.getElementById("add_day_date")?.value || "").trim();
    if (!date) { if (msg) msg.textContent = t("addAgentError"); return; }
    const rep = (document.getElementById("add_day_rep")?.value || "").trim() || managerState.addDayTargetName || managerState.selectedAgentName || state.rep || "";
    const store = (document.getElementById("add_day_store")?.value || "").trim();
    const startT = (document.getElementById("add_day_start")?.value || "").trim();
    const endT = (document.getElementById("add_day_end")?.value || "").trim();
    const n = (id) => Math.max(0, parseInt(document.getElementById(id)?.value || 0, 10) || 0);
    const values = { S: n("add_day_s"), Z: n("add_day_z"), CC: n("add_day_cc"), C: n("add_day_c"), X: n("add_day_xv") };
    const startTs = toTsFromDateAndTime(date, startT);
    const endTs = toTsFromDateAndTime(date, endT);
    const durationMs = (startTs && endTs && endTs >= startTs) ? (endTs - startTs) : 0;
    const ratingInfo = classifyDay(values);
    const payload = { date, rep, store, startTs, endTs, durationMs, values, money: values.X * MONEY_PER_X, dayRating: ratingInfo.dayRating, dayBadge: ratingInfo.dayBadge };
    try {
      await window.cloudUpsertDay(state.teamId, agentUid, date, payload);
      managerState.records[agentUid] = managerState.records[agentUid] || {};
      managerState.records[agentUid][date] = payload;
      managerState.monthCache.delete(`${agentUid}:${managerState.calCursor.y}-${managerState.calCursor.m}`);
      if (msg) msg.textContent = t("addDaySaved");
      if (agentUid === state.uid) {
        renderCalendar();
        renderCalendarStats();
        renderProgress();
      } else {
        await renderManagerAgentCalendar();
        await renderManagerAgentsList();
      }
      closeModal(modalAddDay);
    } catch (e) {
      if (msg) msg.textContent = `${t("addAgentError")} ${e?.message || e}`;
    }
  });


  function toTsFromDateAndTime(dateISO, hhmm) {
    if (!dateISO || !hhmm) return 0;
    const d = new Date(`${dateISO}T${hhmm}:00`);
    const ts = d.getTime();
    return Number.isFinite(ts) ? ts : 0;
  }

  // ---------- Calendar rendering ----------
  let selectedDayISO = null;
  let activeDayISO = null;
  let activeDayAgentUid = "";

  let calCursor = (() => {
    const d = new Date();
    return { y: d.getFullYear(), m: d.getMonth() };
  })();

  document.getElementById("cal_prev").addEventListener("click", () => {
    calCursor.m -= 1;
    if (calCursor.m < 0) { calCursor.m = 11; calCursor.y -= 1; }
    renderCalendar();
  });
  document.getElementById("cal_next").addEventListener("click", () => {
    calCursor.m += 1;
    if (calCursor.m > 11) { calCursor.m = 0; calCursor.y += 1; }
    renderCalendar();
  });
  function renderCalendarCore({ y, m, titleEl, gridEl, selectedISO, agentUid, onClick }) {
    titleEl.textContent = monthName(y, m);
    gridEl.innerHTML = "";
    const dows = t("calendarWeekdays") || ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    dows.forEach((s) => {
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = s.toUpperCase();
      gridEl.appendChild(el);
    });
    const first = new Date(y, m, 1);
    const firstDow = first.getDay();
    const offset = (firstDow === 0) ? 6 : (firstDow - 1);
    const gridStart = new Date(y, m, 1);
    gridStart.setDate(gridStart.getDate() - offset);
    const hist = historyForAgent(agentUid);
    const todayISO = isoDateLocal();
    for (let i = 0; i < 42; i++) {
      const day = new Date(gridStart);
      day.setDate(gridStart.getDate() + i);
      const iso = isoDateLocal(day);
      const inMonth = day.getMonth() === m;
      const rec = hist[iso];
      const S = rec?.values?.S ?? 0;
      const Z = rec?.values?.Z ?? 0;
      const X = rec?.values?.X ?? 0;
      const ratingInfo = rec ? classifyDay(rec.values || {}) : null;
      const dayRating = rec ? (rec.dayRating || ratingInfo.dayRating) : "";
      const isToday = iso === todayISO;
      const badgeText = isToday ? "HOY" : "";
      const badgeHtml = badgeText ? `<div class="badge ${isToday ? "today" : ""}">${badgeText}</div>` : "";
      const dotHtml = dayRating ? `<span class="dayDot ${dayRating}"></span>` : "";
      const cell = document.createElement("div");
      cell.className = "dayCell" + (inMonth ? "" : " muted") + (rec ? " hasData" : "") + (isToday ? " today" : "") + (selectedISO === iso ? " selected" : "");
      cell.dataset.iso = iso;
      cell.innerHTML = `<div class="dayContent"><div class="dayTop"><div class="dayNum">${day.getDate()}</div>${badgeHtml}${dotHtml}</div><div class="miniClean"><span class="kpiInline">S ${S}</span><span class="kpiInline">Z ${Z}</span><span class="kpiInline">X ${X}</span></div></div>`;
      if (typeof onClick === "function") cell.addEventListener("click", () => onClick(iso));
      gridEl.appendChild(cell);
    }
  }

  function renderCalendar() {
    renderCalendarCore({ y: calCursor.y, m: calCursor.m, titleEl: calTitle, gridEl: calGrid, selectedISO: selectedDayISO, agentUid: state.uid, onClick: (iso) => { selectedDayISO = iso; openDayModal(iso, state.uid); renderCalendar(); } });
    renderCalendarStats();
  }


  function renderCompactStatCard(container, title, totals) {
    const x = totals.X || 0;
    const s = totals.S || 0;
    const z = totals.Z || 0;
    const aggr = s ? ((z / s) * 100).toFixed(1) + "%" : "0.0%";
    const close = z ? ((x / z) * 100).toFixed(1) + "%" : "0.0%";
    const money = x * MONEY_PER_X;
    const avgStops = (totals.days || 0) ? (s / totals.days).toFixed(1) : "0.0";

    container.innerHTML = `
      <div class="statsMiniTitle">${title}</div>
      <div class="statsHeroNumber">${x} ${t("salesWord")}</div>
      <div class="statsHeroEarned">$${money} ${t("earnedWord")}</div>
      <div class="statsMiniLine">${t("avgStopsPerDayLabel")}: ${avgStops}</div>
      <div class="statsMiniChips">
        <span class="statsMiniChip">${t("stopsLabel")}: ${s}</span>
        <span class="statsMiniChip">${t("aggLabel")}: ${aggr}</span>
        <span class="statsMiniChip">${t("closeLabel")}: ${close}</span>
      </div>
      <div class="statsMiniMeta">${t("workedDays")}: ${totals.days || 0} • ${t("hoursWorked")}: ${fmtHours(totals.durationMs || 0)}</div>
    `;
  }

  function renderCalendarStats() {
    hydrateCacheFromCloudForVisibleRanges();
    const now = new Date();
    const weekStart = startOfWeekMon(now);
    const weekEnd = endOfWeekSun(now);
    const weekTotals = sumRecords(recordsInRangeForAgent(state.uid, weekStart, weekEnd));

    const monthTotals = sumRecords(recordsInMonthForAgent(state.uid, calCursor.y, calCursor.m));

    renderCompactStatCard(weekStatsEl, t("weekStatsTitle"), weekTotals);
    renderCompactStatCard(monthStatsEl, t("monthStatsTitle"), monthTotals);
  }

  // ---------- Progress rendering ----------
  function weekSalesStreak(minSales = 12) {
    const hist = loadHistory();
    const now = new Date();
    const thisWeekStart = startOfWeekMon(now);
    let streak = 0;

    for (let i = 0; i < 24; i++) {
      const ws = new Date(thisWeekStart);
      ws.setDate(thisWeekStart.getDate() - (i * 7));
      const we = endOfWeekSun(ws);
      const totals = sumRecords(recordsInRangeForAgent(state.uid, ws, we));
      if ((totals.X || 0) >= minSales) streak += 1;
      else break;
    }
    return streak;
  }

  function getTrainedAgentsWithCheck() {
    const n = parseInt(localStorage.getItem("trainedAgentsWithCheck") || "0", 10);
    return Math.max(0, Number.isFinite(n) ? n : 0);
  }

  function renderProgress() {
    hydrateCacheFromCloudForVisibleRanges();
    const now = new Date();
    const weekStart = startOfWeekMon(now);
    const weekEnd = endOfWeekSun(now);
    const weekTotals = sumRecords(recordsInRangeForAgent(state.uid, weekStart, weekEnd));
    const monthTotals = sumRecords(recordsInMonthForAgent(state.uid, now.getFullYear(), now.getMonth()));

    const weekX = weekTotals.X || 0;
    const weekDays = weekTotals.days || 0;
    const weekAgg = (weekTotals.S||0) ? (((weekTotals.Z||0)/(weekTotals.S||0))*100).toFixed(1) + "%" : "0.0%";
    const weekClose = (weekTotals.Z||0) ? (((weekTotals.X||0)/(weekTotals.Z||0))*100).toFixed(1) + "%" : "0.0%";

    const monthX = monthTotals.X || 0;
    const monthDays = monthTotals.days || 0;
    const monthAvgX = monthDays ? ((monthX)/monthDays).toFixed(1) : "0.0";

    const streak = Math.min(3, weekSalesStreak(12));
    const trained = Math.min(3, getTrainedAgentsWithCheck());
    const reqAProgress = Math.min(100, Math.round((streak / 3) * 100));
    const reqBProgress = Math.min(100, Math.round((trained / 3) * 100));
    const overallDone = (streak >= 3 ? 1 : 0) + (trained >= 3 ? 1 : 0);
    const overallPct = Math.round((overallDone / 2) * 100);

    const weekMain = `${t("salesX")}: ${weekX} / 12`;

    sumWrap.innerHTML = `
      <div class="progCard">
        <div class="progTitle">${t("progressLevelTitle")}</div>
        <div class="progBig">${t("currentLevel")}: ${t("levelSeller")}</div>
        <div class="progSub">${t("nextLevel")}: ${t("levelTrainer")}</div>
        <div class="progBar"><span style="width:${overallPct}%"></span></div>
        <div class="progSub">${overallDone}/2 ${t("requirementsCompleted")} · ${overallPct}%</div>
        <div class="goalLine">${t("firstStepGuide")}</div>
      </div>

      <div class="progCard">
        <div class="progTitle">${t("pathToNextLevel")}</div>

        <div class="progSub" style="margin-top:8px; font-weight:800; opacity:.96;">${t("reqA")}</div>
        <div class="checkList">
          ${[1,2,3].map(i => {
            const done = i <= streak;
            return `<div class="checkItem ${done ? "done" : ""}"><div class="checkLeft"><span class="checkDot">${done ? "✓" : ""}</span><span>${t("weekN")} ${i}</span></div><span class="progCounter">${done ? t("completed") : t("pending")}</span></div>`;
          }).join("")}
        </div>
        <div class="progBar" style="margin-top:6px;"><span style="width:${reqAProgress}%"></span></div>
        <div class="progCounter" style="margin-top:6px;">${streak}/3</div>

        <div class="progSub" style="margin-top:10px; font-weight:800; opacity:.96;">${t("reqB")}</div>
        <div class="progBar"><span style="width:${reqBProgress}%"></span></div>
        <div class="progCounter" style="margin-top:6px;">${trained}/3</div>

        <div class="goalLine">${t("nextGoalWeek")}</div>
      </div>

      <div class="progCard rewardCard">
        <div class="rewardTitleRow"><span class="rewardIcon">${t("rewardIcon")}</span><div class="progTitle">${t("unlocks")}</div></div>
        <div class="rewardBig">${t("unlockReward")}</div>
        <div class="progSub">${t("unlockRewardNote")}</div>
      </div>

      <div class="progCard">
        <div class="progTitle">${t("weekCardTitle")}</div>
        <div class="compactMain">${weekMain}</div>
        <div class="weekImpact">${t("weekImpact")}</div>
        <div class="compactGrid">
          <div class="sumPill"><div class="k">${t("days")}</div><div class="v">${weekDays}</div></div>
          <div class="sumPill"><div class="k">% Agg (Z/S)</div><div class="v">${weekAgg}</div></div>
          <div class="sumPill"><div class="k">% Close (X/Z)</div><div class="v">${weekClose}</div></div>
        </div>
      </div>

      <div class="progCard">
        <div class="progTitle">${t("monthCardTitle")}</div>
        <div class="compactMain">${t("salesX")}: ${monthX}</div>
        <div class="progSub">${monthName(now.getFullYear(), now.getMonth())}</div>
        <div class="compactGrid">
          <div class="sumPill"><div class="k">${t("avgXPerDay")}</div><div class="v">${monthAvgX}</div></div>
          <div class="sumPill"><div class="k">${t("days")}</div><div class="v">${monthDays}</div></div>
          <div class="sumPill"><div class="k">% Close (X/Z)</div><div class="v">${(monthTotals.Z||0) ? (((monthTotals.X||0)/(monthTotals.Z||0))*100).toFixed(1) + "%" : "0.0%"}</div></div>
        </div>
      </div>
    `;
  }

  // ---------- Buttons ----------
  function openStartModal() {
    const currentName = state.rep || (window.firebaseAuth?.currentUser?.displayName || "Usuario");
    state.rep = currentName;
    startProfileName.textContent = `${t("profileForDay")}: ${currentName}`;
    startStore.value = "";
    openModal(modalStart);
    setTimeout(() => startStore.focus(), 50);
  }

  function openProfileModal() {
    profileNameInput.value = state.rep || "";
    openModal(modalProfile);
    setTimeout(() => profileNameInput.focus(), 50);
  }

  startDayBtn.addEventListener("click", openStartModal);

  document.getElementById("profile_x").addEventListener("click", () => closeModal(modalProfile));
  document.getElementById("profile_save").addEventListener("click", () => {
    const rep = (profileNameInput.value || "").trim();
    if (!rep) { alert(t("missingProfile")); return; }
    state.rep = rep;
    saveProfile(rep);
    saveStateNow();
    applyTranslations();
    closeModal(modalProfile);
  });

  document.getElementById("profile_reset").addEventListener("click", () => {
    const ok = confirm(currentLang === "es" ? "¿Resetear nombre e historial?" : "Reset name and history?");
    if (!ok) return;
    try { localStorage.removeItem(PROFILE_KEY); } catch {}
    try { localStorage.removeItem(HISTORY_KEY); } catch {}
    try { localStorage.removeItem(historyStorageKey()); } catch {}
    state.rep = "";
    state.store = "";
    saveStateNow();
    renderCalendar();
    renderProgress();
    applyTranslations();
    closeModal(modalProfile);
  });

  document.getElementById("start_x").addEventListener("click", () => closeModal(modalStart));
  document.getElementById("start_cancel").addEventListener("click", () => closeModal(modalStart));

  document.getElementById("start_confirm").addEventListener("click", () => {
    const store = (startStore.value || "").trim();
    if (!store) {
      alert(t("missingStore"));
      return;
    }
    state.store = store;
    closeModal(modalStart);
    startDay(state.rep, store);
  });

  startStore.addEventListener("keydown", (e) => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    document.getElementById("start_confirm").click();
  });

  document.getElementById("finish_day").addEventListener("click", () => {
    const endTs = Date.now();
    const text = buildReport(endTs);
    const ratingInfo = classifyDay(state.values || {});
    const result = ratingLine(ratingInfo.dayRating, ratingInfo.dayBadge);
    reportDayRating.style.display = "";
    reportDayRating.innerHTML = `${t("dayResult")}: <span style="display:inline-flex;align-items:center;gap:6px;"><span style="width:9px;height:9px;border-radius:999px;background:${ratingColor(ratingInfo.dayRating)};display:inline-block;"></span><span>${result}</span></span>`;
    reportBox.textContent = text;
    showQRForText(text);
    setReportMode("tablet");
    openModal(modalReport);
  });

  document.getElementById("report_x").addEventListener("click", () => closeModal(modalReport));
  document.getElementById("rating_help_btn").addEventListener("click", () => openModal(modalRatingHelp));

  async function doCopyOrShare(kind) {
    const confirmMsg =
      `Are you sure you want to ${kind === "copy" ? "COPY" : "SHARE"}?\n` +
      `This ends the day and resets.`;

    if (!confirm(confirmMsg)) return;

    const endTs = Date.now();
    const text = reportBox.textContent || "";

    try {
      if (kind === "share") {
        if (navigator.share) {
          await navigator.share({ title: "KPI Report", text });
        } else if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          alert("No native Share here. Copied to clipboard.");
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          alert("No native Share here. Copied to clipboard.");
        }
      } else {
        if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
      }

      const result = await persistCompletedDay(endTs, text);
      if (!result?.cloudSaved && window.firebaseAuth?.currentUser?.uid) {
        alert(currentLang === "en" ? "Could not save to cloud. Please try again." : "No se pudo guardar en la nube. Inténtalo de nuevo.");
        return;
      }
      finalizeAndReset();
      history.replaceState(null, "", location.pathname);
    } catch (_) {
      alert("Action failed. Day was not ended.");
    }
  }

  copyBtn.addEventListener("click", () => doCopyOrShare("copy"));
  shareBtn.addEventListener("click", () => doCopyOrShare("share"));

  let isEndingDay = false;

  async function handleEndDay() {
    console.log("handleEndDay click", { active: state.active, modeVisible: endBtn.style.display !== "none" });
    const confirmMsg = t("endConfirm");
    if (!confirm(confirmMsg)) return;
    if (isEndingDay) return;

    const previousLabel = endBtn.textContent;
    const dayISO = state.date;
    isEndingDay = true;
    endBtn.disabled = true;
    endBtn.textContent = t("savingDay");
    if (reportSaveStatus) reportSaveStatus.textContent = t("savingDay");

    try {
      const endTs = Date.now();
      const text = (reportBox.textContent || "").trim() || buildReport(endTs);
      const result = await persistCompletedDay(endTs, text);
      if (!result?.cloudSaved && window.firebaseAuth?.currentUser?.uid) {
        throw new Error("cloud-save-failed");
      }

      const saved = loadHistory()[dayISO];
      if (!saved) throw new Error(`Day not found in cache after save: ${dayISO}`);
      console.log("Saved day:", dayISO, saved);
      if (state.teamId) console.log("Saved to Firestore", { teamId: state.teamId, uid: window.firebaseAuth?.currentUser?.uid, date: dayISO });

      finalizeAndReset();
      closeModal(modalReport);
      if ((location.hash || "").startsWith("#r=")) {
        history.replaceState(null, "", location.pathname);
      } else {
        history.replaceState(null, "", location.pathname + location.search);
      }

      if (reportSaveStatus) reportSaveStatus.textContent = t("savedOk");
      endBtn.textContent = t("savedOk");
      setTimeout(() => {
        endBtn.textContent = t("endDayNow");
      }, 900);
    } catch (err) {
      console.error("handleEndDay failed", err);
      if (reportSaveStatus) reportSaveStatus.textContent = t("saveError");
      alert(currentLang === "en" ? "Could not save the day. Please try again." : "No se pudo guardar el día. Inténtalo de nuevo.");
      endBtn.textContent = previousLabel || t("endDayNow");
    } finally {
      isEndingDay = false;
      endBtn.disabled = false;
    }
  }

  endBtn.addEventListener("click", handleEndDay);

  function normalizeHistoryRatings() {
    const hist = loadHistory();
    let changed = false;
    Object.keys(hist).forEach((iso) => {
      const rec = hist[iso];
      if (!rec || !rec.values) return;
      if (rec.dayRating && rec.dayBadge !== undefined) return;
      const info = classifyDay(rec.values);
      rec.dayRating = info.dayRating;
      rec.dayBadge = info.dayBadge;
      changed = true;
    });
    if (changed) saveHistory(hist);
  }

  langToggleBtn.addEventListener("click", () => openModal(modalLanguage));
  if (authLangToggleBtn) authLangToggleBtn.addEventListener("click", () => openModal(modalLanguage));
  document.getElementById("lang_x").addEventListener("click", () => closeModal(modalLanguage));
  langEsBtn.addEventListener("click", () => setLanguage("es"));
  langEnBtn.addEventListener("click", () => setLanguage("en"));
  clickOutsideToClose(modalLanguage, true);

  // ---------- Init ----------
  (function init() {
    applyTranslations();
    normalizeHistoryRatings();

    // If opened from QR (phone), open report
    tryLoadReportFromHash();

    if (state.active && state.sessionStart && state.rep && state.store) {
      showSessionScreen();
      startTimerLoop();
    } else {
      showStartScreen();
    }

    renderCalendar();
    renderProgress();
    hydrateCacheFromCloudForVisibleRanges().then(() => {
      renderCalendar();
      renderProgress();
    });
    saveState();
  })();
</script>

  <!-- Firebase reminder: en Firebase Console > Authentication > Settings > Authorized domains agrega tu dominio de GitHub Pages (tuusuario.github.io). -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } 
    from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, where, getDocs, deleteDoc, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFFcAXi0gs1tielHMTjZXfLxnj6aE4zSU",
    authDomain: "closeflowtracker.firebaseapp.com",
    projectId: "closeflowtracker",
    storageBucket: "closeflowtracker.firebasestorage.app",
    messagingSenderId: "192350700436",
    appId: "1:192350700436:web:5469db8ba8bb2db0c78581",
    measurementId: "G-GRV43R260Q"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);
  const TEAM_STORAGE_KEY = "kpi_team_v1";
  const MONEY_PER_X_CENTS = 100;
  const DEBUG_ENABLED = false;
  const debugLog = (...args) => { if (DEBUG_ENABLED) console.log(...args); };

  // Exponer para el resto del código si es necesario
  window.firebaseAuth = auth;
  window.firebaseDB = db;

  function normalizeTeamIdOrThrow(teamId) {
    const clean = String(teamId || "").trim().toLowerCase().replace(/[^a-z0-9_-]/g, "");
    if (!clean) throw new Error("Invalid Team ID");
    return clean;
  }

  async function resolveTeamIdForUser(uid) {
    const userRef = doc(db, "users", uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      const fallbackName = auth.currentUser?.displayName || "";
      const fallbackEmail = auth.currentUser?.email || "";
      const fallbackTeam = sanitizeTeamId(localStorage.getItem(TEAM_STORAGE_KEY) || "");
      await setDoc(userRef, {
        teamId: fallbackTeam || "",
        displayName: fallbackName,
        email: fallbackEmail,
        createdAt: serverTimestamp(),
      }, { merge: true });
      return fallbackTeam || "";
    }

    const data = userSnap.data() || {};
    return sanitizeTeamId(data.teamId || "");
  }

  async function ensureTeamMembership(teamId, uid) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const safeUid = String(uid || "").trim();
    if (!safeUid) return;

    const user = auth.currentUser;
    const displayName = user?.displayName || state.rep || "";
    const email = user?.email || "";

    await Promise.all([
      setDoc(doc(db, "teams", safeTeamId), {
        createdAt: serverTimestamp(),
      }, { merge: true }),
      setDoc(doc(db, "teams", safeTeamId, "members", safeUid), {
        teamId: safeTeamId,
        displayName,
        email,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      }, { merge: true }),
      setDoc(doc(db, "users", safeUid), {
        teamId: safeTeamId,
        displayName,
        email,
        updatedAt: serverTimestamp(),
      }, { merge: true }),
    ]);
  }

  async function cloudUpsertDay(teamId, uid, iso, dayData) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const safeIso = String(iso || "").trim();
    if (!/^\d{4}-\d{2}-\d{2}$/.test(safeIso)) throw new Error("Invalid day ISO");

    const dayRef = doc(db, "teams", safeTeamId, "agents", uid, "days", safeIso);
    const S = Number(dayData?.values?.S || 0);
    const Z = Number(dayData?.values?.Z || 0);
    const CC = Number(dayData?.values?.CC || 0);
    const C = Number(dayData?.values?.C || 0);
    const X = Number(dayData?.values?.X || 0);

    const payload = {
      date: safeIso,
      rep: dayData?.rep || "",
      store: dayData?.store || "",
      startTs: Number(dayData?.startTs || 0),
      endTs: Number(dayData?.endTs || 0),
      durationMs: Number(dayData?.durationMs || 0),
      values: { S, Z, CC, C, X },
      money: X * MONEY_PER_X_CENTS,
      dayRating: dayData?.dayRating || "",
      dayBadge: dayData?.dayBadge || "",
      schemaVersion: 1,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    };
    const path = `teams/${safeTeamId}/agents/${uid}/days/${safeIso}`;
    try {
      console.log("Firestore day payload:", payload);
      console.log("Saving day to Firestore...", safeTeamId, uid, safeIso);
      await setDoc(dayRef, payload, { merge: true });
      console.log("Saved day to Firestore OK");
      debugLog("Firestore path", path);
      return { path, payload };
    } catch (e) {
      console.error("Firestore day write failed", e);
      console.error("Firestore day write failed (actionable): verify Firestore Rules allow teams/{teamId}/agents/{uid}/days writes for this user/team.", e?.code || e?.message || e);
      throw e;
    }
  }

  async function cloudDeleteDay(teamId, uid, iso) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const safeIso = String(iso || "").trim();
    if (!/^\d{4}-\d{2}-\d{2}$/.test(safeIso)) throw new Error("Invalid day ISO");

    await deleteDoc(doc(db, "teams", safeTeamId, "agents", uid, "days", safeIso));
  }

  async function migrateAddSchemaVersion(teamId, agentUid) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const safeUid = String(agentUid || "").trim();
    if (!safeUid) throw new Error("Invalid agent uid");

    const colRef = collection(db, "teams", safeTeamId, "agents", safeUid, "days");
    const snap = await getDocs(colRef);
    let updated = 0;

    for (const dayDoc of snap.docs) {
      const data = dayDoc.data() || {};
      if (data.schemaVersion == null) {
        await updateDoc(dayDoc.ref, {
          schemaVersion: 1,
          updatedAt: serverTimestamp(),
        });
        updated += 1;
      }
    }

    const summary = { checked: snap.size, updated, teamId: safeTeamId, agentUid: safeUid };
    console.log("migrateAddSchemaVersion summary:", summary);
    return summary;
  }


  async function cloudGetDaysInRange(teamId, uid, startISO, endISO) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const colRef = collection(db, "teams", safeTeamId, "agents", uid, "days");
    const q = query(colRef, where("date", ">=", startISO), where("date", "<=", endISO));
    const snap = await getDocs(q);
    return snap.docs.map((d) => {
      const data = d.data() || {};
      const values = {
        S: Number(data?.values?.S ?? data?.S ?? 0),
        Z: Number(data?.values?.Z ?? data?.Z ?? 0),
        CC: Number(data?.values?.CC ?? data?.CC ?? 0),
        C: Number(data?.values?.C ?? data?.C ?? 0),
        X: Number(data?.values?.X ?? data?.X ?? 0),
      };
      return {
        date: data?.date || d.id,
        rep: data?.rep || "",
        store: data?.store || "",
        startTs: Number(data?.startTs || 0),
        endTs: Number(data?.endTs || 0),
        durationMs: Number(data?.durationMs || 0),
        values,
        money: Number(data?.money ?? (values.X * MONEY_PER_X_CENTS)),
        dayRating: data?.dayRating || "",
        dayBadge: data?.dayBadge || "",
      };
    });
  }



  // FIRESTORE RULES SNIPPET (prototype):
  // match /teams/{teamId}/agents/{uid}/days/{dayId} {
  //   allow read, write: if request.auth != null && request.auth.uid == uid;
  //   allow read: if request.auth != null
  //     && exists(/databases/$(database)/documents/teams/$(teamId)/managers/$(request.auth.uid)/agents/$(uid));
  // }
  // match /teams/{teamId}/managers/{managerUid}/agents/{agentUid} {
  //   allow create, update, delete, read: if request.auth != null && request.auth.uid == managerUid;
  // }
  // No cross-team access: always scope reads/writes under the same teamId the user belongs to.

  async function cloudListAssignedAgents(teamId, managerUid) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const colRef = collection(db, "teams", safeTeamId, "managers", managerUid, "agents");
    const snap = await getDocs(query(colRef, orderBy("displayName"), limit(200)));
    return snap.docs.map((d) => ({ uid: d.id, ...(d.data() || {}) }));
  }

  async function cloudAssignAgentToManagerByEmail(teamId, managerUid, email) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const safeEmail = String(email || "").trim().toLowerCase();
    if (!safeEmail) throw new Error("Email is required");

    const membersRef = collection(db, "teams", safeTeamId, "members");
    const membersQ = query(membersRef, where("email", "==", safeEmail), limit(1));
    const membersSnap = await getDocs(membersQ);
    if (membersSnap.empty) throw new Error(t("userNotFoundInTeam"));

    const memberDoc = membersSnap.docs[0];
    const targetUid = memberDoc.id;
    const member = memberDoc.data() || {};
    const assignmentRef = doc(db, "teams", safeTeamId, "managers", managerUid, "agents", targetUid);
    const assignmentSnap = await getDoc(assignmentRef);
    if (assignmentSnap.exists()) {
      return { alreadyAssigned: true, uid: targetUid };
    }

    await setDoc(assignmentRef, {
      displayName: member.displayName || "",
      email: member.email || safeEmail,
      addedAt: serverTimestamp(),
    }, { merge: true });
    return { alreadyAssigned: false, uid: targetUid };
  }

  async function cloudRemoveAssignedAgent(teamId, managerUid, agentUid) {
    const safeTeamId = normalizeTeamIdOrThrow(teamId);
    const safeAgentUid = String(agentUid || "").trim();
    if (!safeAgentUid) throw new Error("Agent uid is required");
    await deleteDoc(doc(db, "teams", safeTeamId, "managers", managerUid, "agents", safeAgentUid));
    return true;
  }

  async function promoteToManager(targetUid) {
    const safeTeamId = normalizeTeamIdOrThrow(state.teamId);
    await Promise.all([
      setDoc(doc(db, "users", targetUid), { role: "manager", updatedAt: serverTimestamp() }, { merge: true }),
      setDoc(doc(db, "teams", safeTeamId, "members", targetUid), { role: "manager", updatedAt: serverTimestamp() }, { merge: true }),
    ]);
    return true;
  }

  window.resolveTeamIdForUser = resolveTeamIdForUser;
  window.ensureTeamMembership = ensureTeamMembership;
  window.cloudUpsertDay = cloudUpsertDay;
  window.cloudDeleteDay = cloudDeleteDay;
  window.cloudGetDaysInRange = cloudGetDaysInRange;
  window.migrateAddSchemaVersion = migrateAddSchemaVersion;
  window.cloudListAssignedAgents = cloudListAssignedAgents;
  window.cloudAssignAgentToManagerByEmail = cloudAssignAgentToManagerByEmail;
  window.cloudRemoveAssignedAgent = cloudRemoveAssignedAgent;
  window.promoteToManager = promoteToManager;

  const authRootEl = document.getElementById("authRoot");
  const appRootEl = document.getElementById("appRoot");
  const authCardEl = document.getElementById("authCard");
  let hideAppTimeout = null;
  let hideAuthTimeout = null;

  // UI helpers: show/hide (sin transiciones para priorizar estabilidad)
  function showAuth() {
    if (hideAppTimeout) clearTimeout(hideAppTimeout);
    if (hideAuthTimeout) clearTimeout(hideAuthTimeout);
    appRootEl.style.display = "none";
    authRootEl.style.display = "flex";
    const overlay = document.getElementById("auth_signup_overlay");
    if (overlay) overlay.classList.remove("show");
  }

  function showApp()  {
    if (hideAppTimeout) clearTimeout(hideAppTimeout);
    if (hideAuthTimeout) clearTimeout(hideAuthTimeout);
    authRootEl.style.display = "none";
    appRootEl.style.display = "block";
  }

  function resetManagerUiState() {
    managerState.selectedAgentUid = "";
    managerState.selectedAgentName = "";
    managerState.selectedAgentEmail = "";
    managerAgentDetailEl.style.display = "none";
    if (managerRemoveAgentBtn) managerRemoveAgentBtn.style.display = "none";
  }

  // Mostrar auth de inmediato para evitar pantalla vacía/azul mientras Firebase resuelve sesión
  showAuth();

  // Estado de sesión
  onAuthStateChanged(auth, (user) => {
    const loginBtn = document.getElementById("authLoginBtn");
    const loginBtnText = document.getElementById("authLoginBtnText");

    if (user) {
      showApp();
      // Evita arrastre visual de pestaña/panel manager entre sesiones
      state.role = "agent";
      const agentsTabLabelPre = document.getElementById("tab_agents_label");
      if (agentsTabLabelPre) agentsTabLabelPre.style.display = "none";
      resetManagerUiState();
      if (typeof window.setActiveTab === "function") window.setActiveTab("counter");

      // Si el usuario venía de click en login, limpias estado loading aquí (después del cambio real de sesión)
      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.classList.remove("loading");
      }
      if (authCardEl) authCardEl.classList.remove("loading");
      if (loginBtnText) loginBtnText.textContent = t("loginBtn");

      const repName = user.displayName || (user.email ? user.email.split("@")[0] : "Usuario");
      state.rep = repName;
      try { localStorage.setItem(PROFILE_KEY, JSON.stringify({ rep: repName })); } catch {}
      saveStateNow();
      applyTranslations();
      const el = document.getElementById("userEmail");
      if (el) el.textContent = repName;

      // Resolver team desde Firestore (/users/{uid}) y sincronizar cloud SIN bloquear UI
      (async () => {
        try {
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);
          let teamId = "";

          if (!userSnap.exists()) {
            const fallbackTeam = sanitizeTeamId(localStorage.getItem(TEAM_STORAGE_KEY) || "");
            await setDoc(userRef, {
              teamId: fallbackTeam || "",
              displayName: user.displayName || "",
              email: user.email || "",
              role: "agent",
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
            }, { merge: true });
            teamId = fallbackTeam || "";
            debugLog("Profile write OK", `users/${user.uid}`);
          } else {
            const data = userSnap.data() || {};
            teamId = sanitizeTeamId(data.teamId || "");
            // mantiene perfil actualizado
            await setDoc(userRef, {
              displayName: user.displayName || "",
              email: user.email || "",
              updatedAt: serverTimestamp(),
            }, { merge: true });
            debugLog("Profile write OK", `users/${user.uid}`);
          }

          window.setTeamId(teamId);
          state.uid = user.uid;
          let role = (userSnap.exists() ? (userSnap.data()?.role || "agent") : "agent");
          if (teamId) {
            await ensureTeamMembership(teamId, user.uid);
            const memberSnap = await getDoc(doc(db, "teams", teamId, "members", user.uid));
            const memberRole = memberSnap.exists() ? (memberSnap.data()?.role || "") : "";
            role = (role === "manager" || memberRole === "manager") ? "manager" : (memberRole || role);
          }
          state.role = role;
          saveStateNow();
          console.log("role/team loaded", { teamId: teamId || "", role, uid: user.uid });
          const agentsTabLabel = document.getElementById("tab_agents_label");
          if (agentsTabLabel) agentsTabLabel.style.display = role === "manager" ? "" : "none";
          if (role === "manager" && typeof window.loadManagerAgents === "function") {
            await window.loadManagerAgents();
          }
          if (role !== "manager") {
            resetManagerUiState();
          }
          if (typeof window.setActiveTab === "function") window.setActiveTab("counter");
        } catch (err) {
          console.error("TEAM/users bootstrap failed", err);
        }

        try {
          await hydrateCacheFromCloudForVisibleRanges();
          renderCalendar();
          renderProgress();
        } catch (err) {
          console.warn("Post-login hydrate failed", err);
        }
      })();
    } else {
      window.setTeamId("");
      state.role = "agent";
      state.uid = "";
      const agentsTabLabel = document.getElementById("tab_agents_label");
      if (agentsTabLabel) agentsTabLabel.style.display = "none";
      resetManagerUiState();
      if (typeof window.setActiveTab === "function") window.setActiveTab("counter");
      showAuth();

      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.classList.remove("loading");
      }
      if (authCardEl) authCardEl.classList.remove("loading");
      if (loginBtnText) loginBtnText.textContent = t("loginBtn");
    }
  });

  // Acciones Auth (ligadas a botones)
  window.authOpenSignup = () => {
    const overlay = document.getElementById("auth_signup_overlay");
    const msgEl = document.getElementById("signupMsg");
    if (msgEl) { msgEl.textContent = ""; msgEl.classList.remove("error"); }
    if (overlay) overlay.classList.add("show");
  };

  window.authCloseSignup = () => {
    const overlay = document.getElementById("auth_signup_overlay");
    if (overlay) overlay.classList.remove("show");
  };

  window.authSignup = async () => {
    const name = document.getElementById("signupName").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const teamRaw = document.getElementById("signupTeamId").value;
    const pass = document.getElementById("signupPass").value;
    const pass2 = document.getElementById("signupPass2").value;
    const msgEl = document.getElementById("signupMsg");
    const createBtn = document.getElementById("signupCreateBtn");

    msgEl.textContent = "";
    msgEl.classList.remove("error");

    let teamId = "";
    try {
      teamId = normalizeTeamIdOrThrow(teamRaw);
    } catch {
      msgEl.textContent = currentLang === "en"
        ? "Team ID is required."
        : "Team ID es obligatorio.";
      msgEl.classList.add("error");
      return;
    }

    if (!name || !email || !pass || !pass2) {
      msgEl.textContent = currentLang === "en" ? "Complete all fields." : "Completa todos los campos.";
      msgEl.classList.add("error");
      return;
    }
    if (pass !== pass2) {
      msgEl.textContent = currentLang === "en" ? "Passwords do not match." : "Las contraseñas no coinciden.";
      msgEl.classList.add("error");
      return;
    }

    createBtn.disabled = true;
    createBtn.textContent = currentLang === "en" ? "Creating…" : "Creando…";
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: name });

      await Promise.all([
        setDoc(doc(db, "users", cred.user.uid), {
          teamId,
          displayName: name,
          email,
          role: "agent",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge: true }),
        setDoc(doc(db, "teams", teamId), {
          createdAt: serverTimestamp(),
        }, { merge: true }),
        setDoc(doc(db, "teams", teamId, "members", cred.user.uid), {
          teamId,
          displayName: name,
          email,
          role: "agent",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge: true }),
      ]);

      debugLog("Profile write OK", `users/${cred.user.uid}`);
      debugLog("Profile write OK", `teams/${teamId}`);
      debugLog("Profile write OK", `teams/${teamId}/members/${cred.user.uid}`);

      window.setTeamId(teamId);
      state.rep = name;
      try { localStorage.setItem(PROFILE_KEY, JSON.stringify({ rep: name })); } catch {}
      saveStateNow();
      const nameEl = document.getElementById("userEmail");
      if (nameEl) nameEl.textContent = name;
      msgEl.textContent = currentLang === "en" ? "Account created successfully." : "Cuenta creada correctamente.";
      setTimeout(() => authCloseSignup(), 450);
    } catch (e) {
      msgEl.textContent = humanAuthError(e);
      msgEl.classList.add("error");
      console.error("Profile write failed", e);
    } finally {
      createBtn.disabled = false;
      createBtn.textContent = t("signupBtn");
    }
  };

  window.authLogin = async () => {
    const email = document.getElementById("authEmail").value.trim();
    const pass  = document.getElementById("authPass").value;
    const msgEl = document.getElementById("authMsg");
    const loginBtn = document.getElementById("authLoginBtn");
    const loginBtnText = document.getElementById("authLoginBtnText");

    msgEl.textContent = "";
    msgEl.classList.remove("error");
    loginBtn.disabled = true;
    loginBtn.classList.add("loading");
    loginBtnText.textContent = "Iniciando…";
    authCardEl.classList.remove("shake");
    authCardEl.classList.add("loading");

    try {
      await signInWithEmailAndPassword(auth, email, pass);
      msgEl.textContent = "";
      msgEl.classList.remove("error");
    } catch (e) {
      msgEl.textContent = humanAuthError(e);
      msgEl.classList.add("error");
      authCardEl.classList.remove("loading");
      authCardEl.classList.add("shake");
      setTimeout(() => authCardEl.classList.remove("shake"), 280);
      loginBtn.disabled = false;
      loginBtn.classList.remove("loading");
      loginBtnText.textContent = t("loginBtn");
      return;
    }

    // El botón se restablece en onAuthStateChanged para evitar estados inconsistentes.
  };

  window.authLogout = async () => {
    await signOut(auth);
  };

  function humanAuthError(e){
    const code = e?.code || "";
    if (code === "auth/invalid-email") return "Email inválido.";
    if (code === "auth/user-not-found") return "No existe esa cuenta.";
    if (code === "auth/wrong-password") return "Contraseña incorrecta.";
    if (code === "auth/email-already-in-use") return "Ese email ya está registrado.";
    if (code === "auth/weak-password") return "Contraseña muy débil (mínimo 6 caracteres).";
    return e?.message || "Error de autenticación.";
  }
</script>

</body>
</html>
